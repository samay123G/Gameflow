<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GameFlow ‚Äî Play. Win. Repeat.</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
/* ===================== VARIABLES ===================== */
:root{
  --black:#080808;--dark:#111;--card:#161616;--card2:#1e1e1e;
  --orange:#ff6600;--orange2:#ff8833;--orange3:#ffaa55;
  --oglow:rgba(255,102,0,0.25);--oglow2:rgba(255,102,0,0.08);
  --white:#fff;--gray:#999;--gray2:#555;--border:rgba(255,102,0,0.15);
  --radius:14px;--radius2:10px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Exo 2',sans-serif;background:var(--black);color:var(--white);overflow-x:hidden;cursor:default;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--dark);}::-webkit-scrollbar-thumb{background:var(--orange);border-radius:3px;}

/* ===================== HEADER ===================== */
header{position:fixed;top:0;width:100%;z-index:900;background:rgba(8,8,8,0.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.hdr{max-width:1280px;margin:0 auto;display:flex;align-items:center;gap:2rem;padding:0 1.5rem;height:62px;}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;flex-shrink:0;}
.logo-box{width:36px;height:36px;background:linear-gradient(135deg,var(--orange),var(--orange2));border-radius:8px;display:grid;place-items:center;font-size:18px;box-shadow:0 0 20px var(--oglow);}
.logo-text{font-family:'Orbitron',monospace;font-weight:900;font-size:1.3rem;letter-spacing:1px;}
.logo-text span{color:var(--orange);}
nav{display:flex;gap:0.2rem;flex:1;}
nav a{color:var(--gray);text-decoration:none;padding:6px 14px;border-radius:8px;font-weight:600;font-size:0.9rem;transition:all 0.2s;letter-spacing:0.3px;}
nav a:hover{color:var(--white);background:rgba(255,255,255,0.05);}
nav a.active{color:var(--orange);}
.hdr-right{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.search-wrap{position:relative;}
.search-wrap input{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--white);padding:7px 14px 7px 36px;border-radius:20px;font-size:0.85rem;font-family:'Exo 2',sans-serif;width:180px;transition:all 0.3s;}
.search-wrap input:focus{outline:none;border-color:var(--orange);width:220px;background:rgba(255,102,0,0.05);}
.search-wrap input::placeholder{color:var(--gray2);}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--gray2);font-size:14px;pointer-events:none;}
.btn{padding:8px 20px;border-radius:8px;font-family:'Exo 2',sans-serif;font-weight:700;font-size:0.88rem;cursor:pointer;border:none;transition:all 0.2s;letter-spacing:0.3px;}
.btn-ghost{background:transparent;color:var(--orange);border:1.5px solid var(--orange);}
.btn-ghost:hover{background:var(--orange);color:#fff;}
.btn-fill{background:linear-gradient(135deg,var(--orange),var(--orange2));color:#fff;box-shadow:0 4px 15px var(--oglow);}
.btn-fill:hover{transform:translateY(-1px);box-shadow:0 6px 20px var(--oglow);}

/* ===================== HERO ===================== */
.hero{min-height:100vh;display:flex;align-items:center;position:relative;overflow:hidden;padding-top:62px;}
.hero-particles{position:absolute;inset:0;pointer-events:none;}
.particle{position:absolute;width:2px;height:2px;background:var(--orange);border-radius:50%;animation:drift linear infinite;opacity:0;}
@keyframes drift{0%{opacity:0;transform:translateY(100vh) translateX(0);}10%{opacity:0.6;}90%{opacity:0.3;}100%{opacity:0;transform:translateY(-20vh) translateX(60px);}}
.hero-grid-bg{position:absolute;inset:0;background-image:linear-gradient(rgba(255,102,0,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,102,0,0.03) 1px,transparent 1px);background-size:50px 50px;}
.hero-glow{position:absolute;top:-20%;left:50%;transform:translateX(-50%);width:800px;height:500px;background:radial-gradient(ellipse,rgba(255,102,0,0.07) 0%,transparent 70%);pointer-events:none;}
.hero-inner{position:relative;z-index:2;max-width:1280px;margin:0 auto;padding:0 1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:5rem;align-items:center;width:100%;}
.hero-left{}
.hero-badge{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,102,0,0.4);background:rgba(255,102,0,0.08);padding:5px 14px;border-radius:20px;font-size:0.78rem;color:var(--orange);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5rem;}
.hero-badge::before{content:'';width:6px;height:6px;background:var(--orange);border-radius:50%;animation:pulse 1.5s ease infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(1.5);}}
.hero h1{font-family:'Orbitron',monospace;font-size:3.8rem;font-weight:900;line-height:1.08;margin-bottom:1.2rem;letter-spacing:-1px;}
.hero h1 em{font-style:normal;color:var(--orange);text-shadow:0 0 40px var(--oglow);}
.hero-sub{color:var(--gray);font-size:1.05rem;line-height:1.75;max-width:460px;margin-bottom:2rem;}
.hero-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:2.5rem;}
.hero-actions .btn{font-size:1rem;padding:12px 28px;border-radius:10px;}
.hero-stats{display:flex;gap:2rem;}
.stat-box{text-align:center;}
.stat-num{font-family:'Orbitron',monospace;font-size:1.8rem;font-weight:900;color:var(--orange);}
.stat-lbl{color:var(--gray);font-size:0.72rem;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
.hero-right{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.hcard{background:var(--card);border:1px solid var(--border);border-radius:var(--radius2);padding:1.1rem 0.9rem;text-align:center;cursor:pointer;transition:all 0.3s;animation:floatCard 4s ease-in-out infinite;}
.hcard:nth-child(2){animation-delay:0.5s;}.hcard:nth-child(3){animation-delay:1s;}.hcard:nth-child(4){animation-delay:1.5s;}.hcard:nth-child(5){animation-delay:2s;}.hcard:nth-child(6){animation-delay:2.5s;}
@keyframes floatCard{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
.hcard:hover{border-color:var(--orange);background:rgba(255,102,0,0.08);transform:translateY(-6px) scale(1.04);box-shadow:0 12px 30px var(--oglow);}
.hcard .hc-icon{font-size:2.2rem;margin-bottom:6px;display:block;}
.hcard .hc-name{font-size:0.72rem;color:var(--gray);font-weight:700;letter-spacing:0.5px;}

/* ===================== MARQUEE ===================== */
.marquee-section{background:rgba(255,102,0,0.05);border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 0;overflow:hidden;}
.marquee-track{display:flex;gap:0;white-space:nowrap;animation:marqueeRun 30s linear infinite;}
.marquee-item{display:inline-flex;align-items:center;gap:8px;padding:0 2rem;color:var(--orange);font-weight:700;font-size:0.8rem;letter-spacing:1.5px;text-transform:uppercase;}
.marquee-dot{width:4px;height:4px;background:var(--orange);border-radius:50%;opacity:0.5;}
@keyframes marqueeRun{from{transform:translateX(0);}to{transform:translateX(-50%);}}

/* ===================== SECTIONS ===================== */
.section{padding:4rem 1.5rem;}
.container{max-width:1280px;margin:0 auto;}
.sec-hdr{display:flex;align-items:center;gap:1rem;margin-bottom:2rem;}
.sec-title{font-family:'Orbitron',monospace;font-size:1.6rem;font-weight:900;white-space:nowrap;}
.sec-title span{color:var(--orange);}
.sec-line{flex:1;height:1px;background:linear-gradient(to right,var(--orange),transparent);opacity:0.4;}
.sec-count{font-size:0.8rem;color:var(--gray);font-weight:600;background:var(--card);padding:4px 12px;border-radius:20px;border:1px solid var(--border);}

/* ===================== CATEGORY FILTER ===================== */
.cats{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:2rem;}
.cat{background:var(--card);border:1px solid var(--border);color:var(--gray);padding:8px 18px;border-radius:25px;font-family:'Exo 2',sans-serif;font-weight:700;font-size:0.85rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
.cat:hover{border-color:rgba(255,102,0,0.4);color:var(--white);}
.cat.active{background:var(--orange);color:#fff;border-color:var(--orange);box-shadow:0 4px 15px var(--oglow);}

/* ===================== GAME GRID ===================== */
.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:1.1rem;}
.gcard{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all 0.3s;position:relative;group;}
.gcard:hover{border-color:rgba(255,102,0,0.5);transform:translateY(-5px);box-shadow:0 20px 40px rgba(0,0,0,0.4),0 0 20px var(--oglow);}
.gcard-thumb{height:125px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;}
.gcard-thumb .gicon{font-size:4rem;position:relative;z-index:1;transition:transform 0.3s;filter:drop-shadow(0 4px 10px rgba(0,0,0,0.5));}
.gcard:hover .gicon{transform:scale(1.1);}
.gcard-play{position:absolute;inset:0;background:rgba(255,102,0,0.85);display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-weight:900;font-size:1rem;letter-spacing:3px;opacity:0;transition:opacity 0.2s;z-index:2;}
.gcard:hover .gcard-play{opacity:1;}
.gcard-body{padding:0.9rem 1rem;}
.gcard-name{font-weight:700;font-size:0.98rem;margin-bottom:4px;letter-spacing:0.2px;}
.gcard-meta{display:flex;align-items:center;justify-content:space-between;}
.gcard-cat{font-size:0.72rem;font-weight:700;color:var(--orange);text-transform:uppercase;letter-spacing:0.5px;}
.gcard-stars{font-size:0.72rem;color:#f59e0b;}
.gcard-badge{position:absolute;top:8px;right:8px;background:var(--orange);color:#fff;font-size:0.62rem;font-weight:900;padding:3px 9px;border-radius:20px;letter-spacing:0.5px;text-transform:uppercase;z-index:3;}
.gcard-badge.new-badge{background:#22c55e;}
.gcard-badge.hot-badge{background:var(--orange);}

/* ===================== FEATURED BANNER ===================== */
.featured-banner{background:linear-gradient(135deg,rgba(255,102,0,0.07),rgba(255,102,0,0.02));border:1px solid var(--border);border-radius:20px;padding:2.5rem;margin-bottom:3rem;position:relative;overflow:hidden;}
.featured-banner::before{content:'';position:absolute;right:-100px;top:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(255,102,0,0.08),transparent 70%);pointer-events:none;}
.featured-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-top:1.5rem;}
.fcard{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:1.2rem;display:flex;align-items:center;gap:0.9rem;cursor:pointer;transition:all 0.25s;}
.fcard:hover{background:rgba(255,102,0,0.07);border-color:rgba(255,102,0,0.3);transform:translateX(4px);}
.fcard-icon{width:52px;height:52px;border-radius:12px;background:rgba(255,102,0,0.12);display:grid;place-items:center;font-size:1.6rem;flex-shrink:0;}
.fcard-name{font-weight:700;font-size:0.95rem;margin-bottom:3px;}
.fcard-desc{color:var(--gray);font-size:0.8rem;}
.fcard-tag{display:inline-block;background:var(--orange);color:#fff;font-size:0.62rem;padding:2px 8px;border-radius:10px;font-weight:900;margin-top:5px;letter-spacing:0.5px;}

/* ===================== LEADERBOARD ===================== */
.lb-section{background:var(--dark);border-top:1px solid var(--border);}
.lb-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;}
.lb-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;}
.lb-title{font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;color:var(--orange);margin-bottom:1.2rem;}
.lb-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.lb-row:last-child{border-bottom:none;}
.lb-rank{width:28px;font-family:'Orbitron',monospace;font-weight:900;font-size:1rem;}
.rank-1{color:#f59e0b;}.rank-2{color:#9ca3af;}.rank-3{color:#b45309;}.rank-4,.rank-5{color:var(--gray2);}
.lb-av{width:34px;height:34px;border-radius:50%;background:var(--card2);display:grid;place-items:center;font-size:1rem;flex-shrink:0;}
.lb-name{flex:1;font-weight:600;font-size:0.92rem;}
.lb-score{font-family:'Orbitron',monospace;font-weight:700;color:var(--orange);font-size:0.95rem;}

/* ===================== FOOTER ===================== */
footer{background:var(--dark);border-top:1px solid var(--border);padding:3rem 1.5rem 1.5rem;}
.footer-inner{max-width:1280px;margin:0 auto;}
.footer-top{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:2.5rem;margin-bottom:2rem;}
.footer-brand p{color:var(--gray);font-size:0.88rem;line-height:1.7;max-width:270px;margin-top:0.8rem;}
.footer-socials{display:flex;gap:8px;margin-top:1rem;}
.social-btn{width:34px;height:34px;background:var(--card2);border-radius:8px;display:grid;place-items:center;cursor:pointer;border:1px solid var(--border);transition:all 0.2s;font-size:14px;}
.social-btn:hover{background:var(--orange);border-color:var(--orange);}
.f-col h4{font-family:'Orbitron',monospace;font-size:0.85rem;font-weight:700;margin-bottom:1rem;color:var(--white);}
.f-col a{display:block;color:var(--gray);text-decoration:none;margin-bottom:8px;font-size:0.88rem;transition:color 0.2s;}
.f-col a:hover{color:var(--orange);}
.footer-bottom{border-top:1px solid rgba(255,255,255,0.05);padding-top:1.2rem;display:flex;justify-content:space-between;color:var(--gray);font-size:0.82rem;flex-wrap:wrap;gap:8px;}
.footer-bottom span{display:flex;align-items:center;gap:4px;}

/* ===================== MODAL ===================== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.25s;backdrop-filter:blur(8px);}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--dark);border:1px solid rgba(255,102,0,0.2);border-radius:18px;width:min(96vw,860px);max-height:93vh;display:flex;flex-direction:column;transform:scale(0.93) translateY(10px);transition:transform 0.25s;overflow:hidden;}
.modal-overlay.open .modal{transform:scale(1) translateY(0);}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.4rem;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;}
.modal-title{font-family:'Orbitron',monospace;font-weight:900;font-size:1.1rem;display:flex;align-items:center;gap:10px;}
.modal-title-icon{font-size:1.4rem;}
.modal-close{background:rgba(255,255,255,0.07);border:none;color:var(--white);width:34px;height:34px;border-radius:8px;font-size:1.1rem;cursor:pointer;display:grid;place-items:center;transition:all 0.2s;flex-shrink:0;}
.modal-close:hover{background:var(--orange);}
.modal-body{padding:1.2rem;overflow-y:auto;flex:1;}
.modal-body::-webkit-scrollbar{width:4px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--orange);}

/* ===================== GAME UI COMMONS ===================== */
.g-container{display:flex;flex-direction:column;align-items:center;gap:1rem;}
.g-scorebar{display:flex;gap:2rem;padding:0.8rem 1.5rem;background:var(--card2);border-radius:10px;border:1px solid var(--border);}
.g-score-item{text-align:center;}
.g-score-val{font-family:'Orbitron',monospace;font-size:1.6rem;font-weight:900;color:var(--orange);}
.g-score-lbl{font-size:0.65rem;color:var(--gray);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
.g-btn{background:linear-gradient(135deg,var(--orange),var(--orange2));color:#fff;border:none;padding:10px 28px;border-radius:9px;font-family:'Orbitron',monospace;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.2s;letter-spacing:1px;}
.g-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px var(--oglow);}
.g-btn.secondary{background:var(--card2);border:1px solid var(--border);color:var(--gray);}
.g-btn.secondary:hover{border-color:var(--orange);color:var(--white);}
.g-hint{color:var(--gray);font-size:0.82rem;text-align:center;padding:4px 0;}
.g-canvas{border-radius:10px;border:1px solid var(--border);display:block;max-width:100%;touch-action:none;}
.g-status{font-family:'Orbitron',monospace;font-weight:700;font-size:1.1rem;text-align:center;padding:6px;}

/* ===================== GAME-SPECIFIC ===================== */
/* Tic Tac Toe */
.ttt-board{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:280px;}
.ttt-cell{background:var(--card2);border:2px solid rgba(255,255,255,0.06);border-radius:10px;height:88px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;cursor:pointer;transition:all 0.2s;font-family:'Orbitron',monospace;font-weight:900;}
.ttt-cell:hover:not(.taken){border-color:rgba(255,102,0,0.5);background:rgba(255,102,0,0.05);}
.ttt-cell.X{color:var(--orange);}
.ttt-cell.O{color:#60a5fa;}
.ttt-cell.win-cell{border-color:var(--orange);background:rgba(255,102,0,0.15);animation:winPulse 0.5s ease;}
@keyframes winPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}

/* Sudoku */
.sdk-wrap{overflow-x:auto;max-width:100%;}
.sdk-grid{border-collapse:collapse;border:2px solid var(--orange);border-radius:4px;}
.sdk-cell{width:38px;height:38px;text-align:center;font-weight:700;font-size:0.95rem;cursor:pointer;background:var(--card2);color:var(--white);border:1px solid rgba(255,255,255,0.06);transition:background 0.1s;user-select:none;}
.sdk-cell.given{color:var(--orange);cursor:default;}
.sdk-cell.selected{background:rgba(255,102,0,0.2);}
.sdk-cell.err{color:#ef4444;}
.sdk-cell.highlight{background:rgba(255,102,0,0.07);}
.sdk-nums{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
.sdk-num{background:var(--card2);border:1px solid var(--border);color:var(--white);width:38px;height:38px;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;font-family:'Exo 2',sans-serif;transition:all 0.15s;}
.sdk-num:hover{background:var(--orange);border-color:var(--orange);}

/* Candy Crush */
.cc-board{display:grid;gap:5px;}
.cc-cell{width:50px;height:50px;border-radius:10px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;font-size:1.5rem;border:2px solid transparent;user-select:none;}
.cc-cell:hover{transform:scale(1.08);}
.cc-cell.selected{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,0.4);transform:scale(1.1);}
.cc-cell.matched{animation:matchPop 0.3s ease forwards;}
@keyframes matchPop{0%{transform:scale(1);}50%{transform:scale(1.3);}100%{opacity:0;transform:scale(0);}}

/* Memory Card */
.mem-grid{display:grid;gap:8px;}
.mem-card{height:75px;border-radius:10px;border:2px solid var(--border);background:var(--card2);cursor:pointer;transition:all 0.35s;transform-style:preserve-3d;font-size:0;display:flex;align-items:center;justify-content:center;}
.mem-card.flipped,.mem-card.matched{font-size:2rem;background:rgba(255,102,0,0.1);border-color:var(--orange);}
.mem-card.matched{background:rgba(34,197,94,0.1);border-color:#22c55e;}

/* Not a Robot */
.robot-panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;max-width:380px;width:100%;}
.robot-checkbox-row{display:flex;align-items:center;gap:12px;padding:1rem;background:var(--card2);border-radius:8px;cursor:pointer;margin-bottom:1rem;border:1px solid var(--border);transition:border-color 0.2s;}
.robot-checkbox-row:hover{border-color:var(--orange);}
.robot-cb{width:22px;height:22px;accent-color:var(--orange);cursor:pointer;}
.captcha-display{font-family:monospace;font-size:2rem;letter-spacing:10px;text-align:center;background:rgba(0,0,0,0.4);padding:1rem;border-radius:8px;margin-bottom:1rem;user-select:none;filter:url(#warp);}
.captcha-in{width:100%;padding:10px 14px;background:var(--card2);border:1px solid var(--border);color:var(--white);border-radius:8px;font-size:1rem;font-family:'Exo 2',sans-serif;margin-bottom:0.8rem;}
.captcha-in:focus{outline:none;border-color:var(--orange);}

/* ===================== NOTIFICATION ===================== */
.toast{position:fixed;top:76px;right:16px;background:linear-gradient(135deg,var(--orange),var(--orange2));color:#fff;padding:10px 20px;border-radius:10px;font-weight:700;z-index:2000;transform:translateX(150%);transition:transform 0.3s;font-size:0.92rem;box-shadow:0 6px 20px var(--oglow);max-width:280px;}
.toast.show{transform:translateX(0);}

/* ===================== RESPONSIVE ===================== */
@media(max-width:1024px){.featured-grid{grid-template-columns:1fr 1fr;}.footer-top{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){
  nav{display:none;}
  .search-wrap{display:none;}
  .hero-inner{grid-template-columns:1fr;gap:2rem;text-align:center;}
  .hero h1{font-size:2.5rem;}
  .hero-right{display:none;}
  .hero-stats{justify-content:center;}
  .featured-grid{grid-template-columns:1fr;}
  .lb-grid{grid-template-columns:1fr;}
  .footer-top{grid-template-columns:1fr;}
  .g-scorebar{gap:1rem;}
  .g-score-val{font-size:1.2rem;}
}
</style>
</head>
<body>

<!-- ============ TOAST ============ -->
<div class="toast" id="toast"></div>

<!-- ============ HEADER ============ -->
<header>
  <div class="hdr">
    <a class="logo" href="#">
      <div class="logo-box">üéÆ</div>
      <div class="logo-text"><span>Game</span>Flow</div>
    </a>
    <nav>
      <a href="#" class="active" onclick="scrollTo(0,0);return false;">Home</a>
      <a href="#games-section">All Games</a>
      <a href="#leaderboard">Leaderboard</a>
    </nav>
    <div class="hdr-right">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" placeholder="Search games..." id="searchInput" oninput="searchGames(this.value)">
      </div>
      <button class="btn btn-ghost" onclick="showToast('Sign in coming soon!')">Sign In</button>
      <button class="btn btn-fill" onclick="showToast('Welcome to GameFlow! üéÆ')">Play Free</button>
    </div>
  </div>
</header>

<!-- ============ HERO ============ -->
<section class="hero" id="home">
  <div class="hero-particles" id="particles"></div>
  <div class="hero-grid-bg"></div>
  <div class="hero-glow"></div>
  <div class="hero-inner">
    <div class="hero-left">
      <div class="hero-badge">üî• <span id="heroBadgeCount" id="heroGameCount">30</span> Games Available Now</div>
      <h1>The Ultimate<br>Browser <em>Gaming</em><br>Experience</h1>
      <p class="hero-sub">GameFlow brings you 15+ fully playable games ‚Äî from strategy puzzles to high-speed racing. No downloads, no logins needed. Just pure fun.</p>
      <div class="hero-actions">
        <button class="btn btn-fill" onclick="document.getElementById('games-section').scrollIntoView({behavior:'smooth'})">üïπÔ∏è Play Now ‚Äî It's Free</button>
        <button class="btn btn-ghost" onclick="document.getElementById('games-section').scrollIntoView({behavior:'smooth'})">Browse Games</button>
      </div>
      <div class="hero-stats">
        <div class="stat-box"><div class="stat-num">15+</div><div class="stat-lbl">Games</div></div>
        <div class="stat-box"><div class="stat-num">100%</div><div class="stat-lbl">Free</div></div>
        <div class="stat-box"><div class="stat-num">4.9‚òÖ</div><div class="stat-lbl">Rating</div></div>
        <div class="stat-box"><div class="stat-num">50K+</div><div class="stat-lbl">Players</div></div>
      </div>
    </div>
    <div class="hero-right">
      <div class="hcard" onclick="openGame('tictactoe')"><span class="hc-icon">‚≠ï</span><div class="hc-name">Tic Tac Toe</div></div>
      <div class="hcard" onclick="openGame('sudoku')"><span class="hc-icon">üî¢</span><div class="hc-name">Sudoku</div></div>
      <div class="hcard" onclick="openGame('carracing')"><span class="hc-icon">üèéÔ∏è</span><div class="hc-name">Car Racing</div></div>
      <div class="hcard" onclick="openGame('candycrush')"><span class="hc-icon">üç¨</span><div class="hc-name">Candy Crush</div></div>
      <div class="hcard" onclick="openGame('tetris')"><span class="hc-icon">üì¶</span><div class="hc-name">Box Fill</div></div>
      <div class="hcard" onclick="openGame('bubble')"><span class="hc-icon">ü´ß</span><div class="hc-name">Bubble Shooter</div></div>
    </div>
  </div>
</section>

<!-- ============ MARQUEE ============ -->
<div class="marquee-section">
  <div class="marquee-track" id="marqueeTrack"></div>
</div>

<!-- ============ FEATURED ============ -->
<section class="section" style="padding-bottom:0;">
  <div class="container">
    <div class="featured-banner">
      <div class="sec-hdr" style="margin-bottom:0;">
        <div class="sec-title">‚≠ê Featured <span>Games</span></div>
      </div>
      <div class="featured-grid" id="featuredGrid"></div>
    </div>
  </div>
</section>

<!-- ============ ALL GAMES ============ -->
<section class="section" id="games-section">
  <div class="container">
    <div class="sec-hdr">
      <div class="sec-title">All <span>Games</span></div>
      <div class="sec-line"></div>
      <div class="sec-count" id="gameCount">30 Games</div>
    </div>
    <div class="cats" id="catFilter"></div>
    <div class="games-grid" id="gamesGrid"></div>
  </div>
</section>

<!-- ============ LEADERBOARD ============ -->
<section class="section lb-section" id="leaderboard">
  <div class="container">
    <div class="sec-hdr">
      <div class="sec-title">üèÜ Leader<span>board</span></div>
      <div class="sec-line"></div>
    </div>
    <div class="lb-grid">
      <div class="lb-box">
        <div class="lb-title">üèéÔ∏è Car Racing ‚Äî Top Racers</div>
        <div class="lb-row"><div class="lb-rank rank-1">1</div><div class="lb-av">üëë</div><div class="lb-name">SpeedKing99</div><div class="lb-score">124,500</div></div>
        <div class="lb-row"><div class="lb-rank rank-2">2</div><div class="lb-av">ü•à</div><div class="lb-name">TurboRacer</div><div class="lb-score">98,320</div></div>
        <div class="lb-row"><div class="lb-rank rank-3">3</div><div class="lb-av">ü•â</div><div class="lb-name">NightDrift</div><div class="lb-score">87,650</div></div>
        <div class="lb-row"><div class="lb-rank rank-4">4</div><div class="lb-av">üéÆ</div><div class="lb-name">FastFury</div><div class="lb-score">72,100</div></div>
        <div class="lb-row"><div class="lb-rank rank-5">5</div><div class="lb-av">‚ö°</div><div class="lb-name">BlazeX</div><div class="lb-score">65,800</div></div>
      </div>
      <div class="lb-box">
        <div class="lb-title">üì¶ Tetris ‚Äî Box Champions</div>
        <div class="lb-row"><div class="lb-rank rank-1">1</div><div class="lb-av">üëë</div><div class="lb-name">BlockMaster</div><div class="lb-score">890,000</div></div>
        <div class="lb-row"><div class="lb-rank rank-2">2</div><div class="lb-av">ü•à</div><div class="lb-name">TetrisGod</div><div class="lb-score">756,400</div></div>
        <div class="lb-row"><div class="lb-rank rank-3">3</div><div class="lb-av">ü•â</div><div class="lb-name">DropZone</div><div class="lb-score">634,200</div></div>
        <div class="lb-row"><div class="lb-rank rank-4">4</div><div class="lb-av">üéÆ</div><div class="lb-name">ClearLine</div><div class="lb-score">521,800</div></div>
        <div class="lb-row"><div class="lb-rank rank-5">5</div><div class="lb-av">‚ö°</div><div class="lb-name">PieceByPiece</div><div class="lb-score">480,000</div></div>
      </div>
    </div>
  </div>
</section>

<!-- ============ FOOTER ============ -->
<footer>
  <div class="footer-inner">
    <div class="footer-top">
      <div class="footer-brand">
        <div class="logo"><div class="logo-box">üéÆ</div><div class="logo-text"><span>Game</span>Flow</div></div>
        <p>Your #1 destination for free browser games. 15+ games, zero downloads. Play anytime, anywhere, on any device.</p>
        <div class="footer-socials">
          <div class="social-btn" title="Facebook">üìò</div>
          <div class="social-btn" title="Twitter">üê¶</div>
          <div class="social-btn" title="Instagram">üì∏</div>
          <div class="social-btn" title="YouTube">‚ñ∂Ô∏è</div>
        </div>
      </div>
      <div class="f-col">
        <h4>Top Games</h4>
        <a href="#" onclick="openGame('carracing');return false;">Car Racing</a>
        <a href="#" onclick="openGame('tetris');return false;">Box Fill</a>
        <a href="#" onclick="openGame('bubble');return false;">Bubble Shooter</a>
        <a href="#" onclick="openGame('gunfight');return false;">Gun Fight</a>
        <a href="#" onclick="openGame('stickman');return false;">Stickman Run</a>
      </div>
      <div class="f-col">
        <h4>Puzzle Games</h4>
        <a href="#" onclick="openGame('tictactoe');return false;">Tic Tac Toe</a>
        <a href="#" onclick="openGame('sudoku');return false;">Sudoku</a>
        <a href="#" onclick="openGame('memory');return false;">Memory Cards</a>
        <a href="#" onclick="openGame('candycrush');return false;">Candy Crush</a>
        <a href="#" onclick="openGame('notarobot');return false;">Not A Robot</a>
      </div>
      <div class="f-col">
        <h4>Company</h4>
        <a href="#">About Us</a>
        <a href="#">Privacy Policy</a>
        <a href="#">Terms of Use</a>
        <a href="#">Advertise</a>
        <a href="#">Contact</a>
      </div>
    </div>
    <div class="footer-bottom">
      <span>¬© 2024 GameFlow. All rights reserved.</span>
      <span>Made with ‚ù§Ô∏è for gamers worldwide</span>
    </div>
  </div>
</footer>

<!-- ============ MODAL ============ -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title"><span class="modal-title-icon" id="mIcon">üéÆ</span><span id="mTitle">Game</span><span id="mLvl" style="background:rgba(255,102,0,.15);border:1px solid rgba(255,102,0,.3);padding:2px 10px;border-radius:16px;font-size:.7rem;font-weight:700;color:var(--orange);margin-left:8px;"></span></div>
      <button class="modal-close" id="modalCloseBtn">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
"use strict";
/* =========================================================
   GAME REGISTRY
========================================================= */
const GAMES = [
  {id:'tictactoe', name:'Tic Tac Toe',   icon:'‚≠ï', cat:'puzzle', bg:'linear-gradient(135deg,#1a1a3e,#0e0e2e)', rating:'4.8', badge:'classic', featured:true,  desc:'Beat the AI in classic Tic Tac Toe'},
  {id:'sudoku',    name:'Sudoku',          icon:'üî¢', cat:'puzzle', bg:'linear-gradient(135deg,#0e2e0e,#0a1e0a)', rating:'4.9', badge:'brain',   featured:false, desc:'Fill the 9√ó9 grid ‚Äî no repeats!'},
  {id:'candycrush',name:'Candy Crush',     icon:'üç¨', cat:'arcade', bg:'linear-gradient(135deg,#2e0e2e,#1e0a1e)', rating:'4.7', badge:'sweet',   featured:true,  desc:'Match 3 candies to crush them'},
  {id:'bubble',    name:'Bubble Shooter',  icon:'ü´ß', cat:'arcade', bg:'linear-gradient(135deg,#0e0e3e,#080820)', rating:'4.6', badge:'fun',     featured:false, desc:'Aim & shoot to pop bubbles'},
  {id:'carracing', name:'Car Racing',      icon:'üèéÔ∏è', cat:'racing', bg:'linear-gradient(135deg,#2e1000,#3d1500)', rating:'4.9', badge:'hot',     featured:true,  desc:'Dodge traffic at top speed'},
  {id:'gunfight',  name:'Gun Fight',       icon:'üî´', cat:'action', bg:'linear-gradient(135deg,#2e0000,#3d0000)', rating:'4.8', badge:'action',  featured:true,  desc:'Shoot enemies before they reach you'},
  {id:'arrowbow',  name:'Arrow & Bow',     icon:'üèπ', cat:'action', bg:'linear-gradient(135deg,#0e2000,#162d00)', rating:'4.5', badge:'aim',     featured:false, desc:'Hit moving targets with arrows'},
  {id:'hillclimb', name:'Hill Climb',      icon:'üèîÔ∏è', cat:'racing', bg:'linear-gradient(135deg,#000a2e,#001040)', rating:'4.6', badge:'drive',   featured:false, desc:'Conquer hills without flipping'},
  {id:'templerun', name:'Temple Run',      icon:'üèõÔ∏è', cat:'arcade', bg:'linear-gradient(135deg,#2a1500,#3d2000)', rating:'4.7', badge:'run',     featured:false, desc:'Run, jump & slide to survive'},
  {id:'tetris',    name:'Box Fill',        icon:'üì¶', cat:'puzzle', bg:'linear-gradient(135deg,#00002e,#00003d)', rating:'4.8', badge:'classic', featured:true,  desc:'Classic Tetris ‚Äî drop & clear lines'},
  {id:'glasshit',  name:'Glass Hit',       icon:'ü™ü', cat:'casual', bg:'linear-gradient(135deg,#0a2030,#0f2a3a)', rating:'4.4', badge:'smash',   featured:false, desc:'Smash glowing glass targets'},
  {id:'notarobot', name:'Not A Robot',     icon:'ü§ñ', cat:'casual', bg:'linear-gradient(135deg,#1e1000,#2e1800)', rating:'4.3', badge:'tricky',  featured:false, desc:'Prove you\'re human ‚Äî pass the test'},
  {id:'bikeracing',name:'Bike Racing',     icon:'üèçÔ∏è', cat:'racing', bg:'linear-gradient(135deg,#1a002e,#220040)', rating:'4.7', badge:'speed',   featured:false, desc:'Weave through traffic on your bike'},
  {id:'stickman',  name:'Stickman Run',    icon:'üèÉ', cat:'arcade', bg:'linear-gradient(135deg,#002e10,#003d15)', rating:'4.5', badge:'runner',  featured:false, desc:'Jump over obstacles endlessly'},
  {id:'spaceship', name:'Space Blaster',   icon:'üöÄ', cat:'action', bg:'linear-gradient(135deg,#000020,#00003a)', rating:'4.6', badge:'new',     featured:false, desc:'Blast alien invaders from space'},
  {id:'memory',    name:'Memory Cards',    icon:'üÉè', cat:'puzzle', bg:'linear-gradient(135deg,#200020,#2e002e)', rating:'4.5', badge:'memory',  featured:false, desc:'Match pairs before time runs out'},
  {id:'watersort',  name:'Water Sort',     icon:'üß™', cat:'puzzle', bg:'linear-gradient(135deg,#001030,#002040)', rating:'4.7', badge:'new',     featured:true,  desc:'Sort colored water into tubes'},
  {id:'wordsearch', name:'Word Search',    icon:'üî§', cat:'puzzle', bg:'linear-gradient(135deg,#002020,#004040)', rating:'4.6', badge:'new',     featured:false, desc:'Find all hidden words!'},
  {id:'braintest',  name:'Brain Test',     icon:'üß†', cat:'puzzle', bg:'linear-gradient(135deg,#200010,#3d0020)', rating:'4.8', badge:'tricky',  featured:false, desc:'Trick questions!'},
  {id:'chess',      name:'Chess',          icon:'‚ôüÔ∏è', cat:'puzzle', bg:'linear-gradient(135deg,#100010,#200030)', rating:'4.9', badge:'classic', featured:true,  desc:'Play chess vs AI'},
  {id:'goodspuzzle',name:'Goods Puzzle',   icon:'üéÅ', cat:'puzzle', bg:'linear-gradient(135deg,#102010,#203020)', rating:'4.4', badge:'sort',    featured:false, desc:'Sort items into categories'},
  {id:'frutninja',  name:'Fruit Ninja',    icon:'üçâ', cat:'action', bg:'linear-gradient(135deg,#200010,#3d0020)', rating:'4.7', badge:'hot',     featured:false, desc:'Slice fruits!'},
  {id:'mobcontrol', name:'Mob Control',    icon:'üßë', cat:'action', bg:'linear-gradient(135deg,#102030,#203040)', rating:'4.5', badge:'new',     featured:false, desc:'Guide your army through gates'},
  {id:'crossyroad', name:'Crossy Road',    icon:'üê∏', cat:'racing', bg:'linear-gradient(135deg,#003000,#004800)', rating:'4.7', badge:'new',     featured:false, desc:'Hop across roads safely'},
  {id:'magictiles', name:'Magic Tiles',    icon:'üéπ', cat:'arcade', bg:'linear-gradient(135deg,#000010,#000020)', rating:'4.6', badge:'new',     featured:true,  desc:'Tap the black piano tiles!'},
  {id:'colorbook',  name:'Coloring Game',  icon:'üé®', cat:'casual', bg:'linear-gradient(135deg,#002020,#003030)', rating:'4.5', badge:'relax',   featured:false, desc:'Color beautiful scenes'},
  {id:'ludo',       name:'Ludo King',      icon:'üé≤', cat:'casual', bg:'linear-gradient(135deg,#1a0020,#2e0040)', rating:'4.6', badge:'classic', featured:false, desc:'Classic 2-player dice game'},
  {id:'township',   name:'City Builder',   icon:'üèôÔ∏è', cat:'casual', bg:'linear-gradient(135deg,#001020,#002030)', rating:'4.4', badge:'build',   featured:false, desc:'Build your city'},
  {id:'storymatch', name:'Story Match',    icon:'üìñ', cat:'casual', bg:'linear-gradient(135deg,#200000,#300010)', rating:'4.3', badge:'match',   featured:false, desc:'Fairy tale trivia'},
  {id:'carrom',     name:'Carrom Board',   icon:'üéØ', cat:'casual', bg:'linear-gradient(135deg,#1a1000,#2a1800)', rating:'4.5', badge:'classic', featured:false, desc:'Pot all coins to win'},
  {id:'dino', name:'Dino Run', icon:'ü¶ï', cat:'arcade', bg:'linear-gradient(135deg,#1a1a1a,#2a2a2a)', rating:'4.9', badge:'classic', featured:true, desc:'Jump over cacti & birds! Classic Chrome game!'},

];

const CATEGORIES = [
  {id:'all',    label:'üéÆ All Games'},
  {id:'puzzle', label:'üß© Puzzle'},
  {id:'action', label:'üí• Action'},
  {id:'racing', label:'üèéÔ∏è Racing'},
  {id:'arcade', label:'üïπÔ∏è Arcade'},
  {id:'casual', label:'‚òÄÔ∏è Casual'},
];

/* =========================================================
   GAME ENGINE HELPERS ‚Äî proper lifecycle management
========================================================= */
let activeRAF = null;
let activeIntervals = [];
let activeListeners = []; // {el, type, fn, options}
let activeGame = null;

/* LEVEL SYSTEM */
const gameLevels = {};
function getLevel(id) { return gameLevels[id] || 1; }
function bumpLevel(id) { gameLevels[id] = (gameLevels[id]||1)+1; return gameLevels[id]; }
function showWin(msg, id, cb) {
  const lv = bumpLevel(id);
  const body = document.getElementById('modalBody');
  if (!body) return;
  const cbStr = cb.toString();
  body.innerHTML = '<div class="g-container" style="padding:1rem;"><div style="text-align:center;padding:1.5rem;"><div style="font-size:4rem;margin-bottom:.8rem;">üèÜ</div><h2 style="font-family:Orbitron,monospace;color:#22c55e;margin-bottom:.5rem;">Level Complete!</h2><p style="color:#999;margin-bottom:1rem;">'+msg+'</p><p style="font-size:1.1rem;font-weight:700;color:var(--orange);margin-bottom:1.5rem;">üî• Level '+lv+' Unlocked!</p><button class="g-btn" id="winBtn">‚ñ∂ Play Level '+lv+'</button></div></div>';
  const wb = document.getElementById('winBtn'); if(wb) wb.onclick = cb;
}

/* ==============================================================
   SOUND ENGINE (Web Audio API)
============================================================== */
let audioCtx = null;
function getAudio() {
  if (!audioCtx) {
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  return audioCtx;
}
function playTone(freq, dur=0.1, type='square', vol=0.15) {
  const ac = getAudio(); if (!ac) return;
  try {
    const o = ac.createOscillator(), g = ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.type = type; o.frequency.setValueAtTime(freq, ac.currentTime);
    g.gain.setValueAtTime(vol, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
    o.start(); o.stop(ac.currentTime + dur);
  } catch(e) {}
}
function playClick() { playTone(800, 0.05, 'sine', 0.2); }
function playWin()   { [523,659,784,1047].forEach((f,i) => setTimeout(()=>playTone(f,0.2,'sine',0.25), i*100)); }
function playFail()  { [300,200].forEach((f,i) => setTimeout(()=>playTone(f,0.15,'sawtooth',0.2), i*120)); }
function playPop()   { playTone(600, 0.08, 'sine', 0.3); }
function playHit()   { playTone(400, 0.06, 'square', 0.2); }
function playSlice() { playTone(900, 0.04, 'triangle', 0.25); }
function playPiano(note) {
  const freqs = {C4:262,D4:294,E4:330,F4:349,G4:392,A4:440,B4:494,C5:523};
  const ac = getAudio(); if (!ac) return;
  try {
    const o = ac.createOscillator(), g = ac.createGain();
    const keys = Object.keys(freqs);
    const f = freqs[keys[note % keys.length]] * (1 + Math.floor(note/8) * 0.5);
    o.connect(g); g.connect(ac.destination);
    o.type = 'triangle'; o.frequency.value = f;
    g.gain.setValueAtTime(0.4, ac.currentTime);
    g.gain.linearRampToValueAtTime(0, ac.currentTime + 0.5);
    o.start(); o.stop(ac.currentTime + 0.5);
  } catch(e) {}
}
function playCoin()  { playTone(1200,0.08,'sine',0.3); setTimeout(()=>playTone(1600,0.08,'sine',0.25),80); }
function playShoot() { playTone(200, 0.06, 'square', 0.15); }
function playExplode(){ [250,180,120].forEach((f,i)=>setTimeout(()=>playTone(f,0.1,'sawtooth',0.2),i*50)); }

/* Canvas coordinate helper - fixes touch/click offset on scaled canvas */
function getCanvasPos(canvas, clientX, clientY) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  return {
    x: (clientX - rect.left) * scaleX,
    y: (clientY - rect.top) * scaleY
  };
}

function stopEngine() {
  if (activeRAF) { cancelAnimationFrame(activeRAF); activeRAF = null; }
  activeIntervals.forEach(id => clearInterval(id));
  activeIntervals = [];
  activeListeners.forEach(({el, type, fn, opts}) => el.removeEventListener(type, fn, opts));
  activeListeners = [];
}

function addListener(el, type, fn, opts) {
  el.addEventListener(type, fn, opts);
  activeListeners.push({el, type, fn, opts});
}

function addInterval(fn, ms) {
  const id = setInterval(fn, ms);
  activeIntervals.push(id);
  return id;
}

function startLoop(fn) {
  function tick() { fn(); activeRAF = requestAnimationFrame(tick); }
  activeRAF = requestAnimationFrame(tick);
}

/* =========================================================
   UI HELPERS
========================================================= */
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

/* =========================================================
   MODAL SYSTEM
========================================================= */
const overlay = document.getElementById('modalOverlay');
overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function openGame(id) {
  const game = GAMES.find(g => g.id === id);
  if (!game) return;
  stopEngine();
  document.getElementById('mIcon').textContent = game.icon;
  document.getElementById('mTitle').textContent = game.name;
  const lvlDisp = document.getElementById('mLvl'); if(lvlDisp) lvlDisp.textContent = 'Lv '+(getLevel(id)||1);
  const body = document.getElementById('modalBody');
  body.innerHTML = '<div class="g-container" id="gc"></div><div style="padding:.5rem;text-align:center;"><button onclick="showRating(\'' + id + '\')" style="background:none;border:1px solid rgba(255,102,0,.2);color:#888;padding:4px 12px;border-radius:8px;font-size:.72rem;cursor:pointer;">‚≠ê Rate this game</button></div>';
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
  const gc = document.getElementById('gc');
  const lv = getLevel(id);
  const builders = {
    tictactoe: buildTTT, sudoku: buildSudoku, candycrush: buildCandy,
    bubble: buildBubble, carracing: buildCarRace, gunfight: buildGunFight,
    arrowbow: buildArrowBow, hillclimb: buildHillClimb, templerun: buildTempleRun,
    tetris: buildTetris, glasshit: buildGlassHit, notarobot: buildNotARobot,
    bikeracing: buildBikeRace, stickman: buildStickman, spaceship: buildSpaceship,
    memory: buildMemory, watersort: buildWaterSort, wordsearch: buildWordSearch,
    braintest: buildBrainTest, chess: buildChess, goodspuzzle: buildGoods,
    frutninja: buildFruitNinja, mobcontrol: buildMobControl, crossyroad: buildCrossy,
    magictiles: buildMagicTiles, colorbook: buildColorBook, ludo: buildLudo,
    township: buildTownship, storymatch: buildStoryMatch, carrom: buildCarrom, dino: buildDino,
  };
  if (builders[id]) builders[id](gc, lv);
}

function closeModal() {
  stopEngine();
  overlay.classList.remove('open');
  document.body.style.overflow = '';
  document.getElementById('modalBody').innerHTML = '';
}

/* =========================================================
   RENDER GRID
========================================================= */
let currentCat = 'all';

function renderGrid(filter = 'all', search = '') {
  const grid = document.getElementById('gamesGrid');
  const filtered = GAMES.filter(g => {
    const catOk = filter === 'all' || g.cat === filter;
    const searchOk = !search || g.name.toLowerCase().includes(search.toLowerCase());
    return catOk && searchOk;
  });
  document.getElementById('gameCount').textContent = filtered.length + ' Games';
  grid.innerHTML = filtered.map(g => `
    <div class="gcard" onclick="openGame('${g.id}')">
      ${g.badge ? `<div class="gcard-badge ${g.badge==='new'?'new-badge':'hot-badge'}">${g.badge}</div>` : ''}
      <div class="gcard-thumb" style="background:${g.bg}">
        <span class="gicon">${g.icon}</span>
        <div class="gcard-play">‚ñ∂ PLAY</div>
      </div>
      <div class="gcard-body">
        <div class="gcard-name">${g.name}</div>
        <div class="gcard-meta">
          <span class="gcard-cat">${g.cat}</span>
          <span class="gcard-stars">${'‚òÖ'.repeat(Math.floor(parseFloat(g.rating)))} ${g.rating}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function filterCat(cat, btn) {
  currentCat = cat;
  document.querySelectorAll('.cat').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderGrid(cat, document.getElementById('searchInput').value);
}

function searchGames(val) {
  renderGrid(currentCat, val);
}

/* =========================================================
   INIT CATEGORIES & FEATURED
========================================================= */
function initUI() {
  // Categories
  const catEl = document.getElementById('catFilter');
  catEl.innerHTML = CATEGORIES.map((c,i) => 
    `<button class="cat${i===0?' active':''}" onclick="filterCat('${c.id}',this)">${c.label}</button>`
  ).join('');

  // Featured
  const featured = GAMES.filter(g => g.featured);
  document.getElementById('featuredGrid').innerHTML = featured.map(g => `
    <div class="fcard" onclick="openGame('${g.id}')">
      <div class="fcard-icon">${g.icon}</div>
      <div>
        <div class="fcard-name">${g.name}</div>
        <div class="fcard-desc">${g.desc}</div>
        <span class="fcard-tag">${g.badge.toUpperCase()}</span>
      </div>
    </div>
  `).join('');

  // Marquee
  const items = GAMES.map(g => `<span class="marquee-item">${g.icon} ${g.name} <span class="marquee-dot"></span></span>`).join('');
  const track = document.getElementById('marqueeTrack');
  track.innerHTML = items + items; // duplicate for seamless loop

  // Particles
  const pc = document.getElementById('particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.cssText = `left:${Math.random()*100}%;animation-duration:${8+Math.random()*12}s;animation-delay:${Math.random()*10}s;`;
    pc.appendChild(p);
  }

  renderGrid();
  // Dynamic count
  const hbc = document.getElementById('heroBadgeCount');
  if(hbc) hbc.textContent = GAMES.length;
  const hgc = document.getElementById('heroGameCount');
  if(hgc) hgc.textContent = GAMES.length;
}
initUI();









/* ==============================================================
   GAME 9: TEMPLE RUN (Endless Runner)
============================================================== */
function buildTempleRun(c) {
  const W=500, H=340;
  let running=false, score=0, coins=0, speed=5, obstacles=[], coinItems=[], frame=0;
  const GROUND=270;
  const player={x:70,y:GROUND,vy:0,jumping:false,sliding:false,alive:true,runFrame:0};

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="trScore">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="trCoins">0</div><div class="g-score-lbl">Coins ü™ô</div></div>
    </div>
    <canvas id="trCanvas" class="g-canvas" width="${W}" height="${H}"></canvas>
    <div class="g-hint">‚Üë / SPACE / Click = Jump &nbsp; ‚Üì = Slide</div>
    <button class="g-btn" id="trBtn" onclick="trStart()">üèÉ Run!</button>
  `;
  const canvas=document.getElementById('trCanvas');
  const ctx=canvas.getContext('2d');

  function draw() {
    // BG
    const bg=ctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0,'#1a0a00'); bg.addColorStop(0.6,'#2a1500'); bg.addColorStop(1,'#1a0a00');
    ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
    // Temple BG
    ctx.fillStyle='rgba(100,70,30,0.3)';
    ctx.beginPath(); ctx.moveTo(0,H-80); ctx.lineTo(0,120); ctx.lineTo(60,80); ctx.lineTo(120,120);
    ctx.lineTo(120,H-80); ctx.closePath(); ctx.fill();
    // Ground
    ctx.fillStyle='#3d2200'; ctx.fillRect(0,GROUND+18,W,H-GROUND);
    ctx.fillStyle='#5a3300'; ctx.fillRect(0,GROUND+18,W,8);
    // Ground tiles
    ctx.strokeStyle='rgba(255,150,50,0.15)'; ctx.lineWidth=1;
    for(let x=(frame*speed)%60;x<W;x+=60){ctx.beginPath();ctx.moveTo(x,GROUND+18);ctx.lineTo(x,H);ctx.stroke();}
    // Torches (BG decoration)
    [80,230,380].forEach((tx,i)=>{
      const flicker=Math.sin(Date.now()/100+i)*0.3+0.7;
      ctx.fillStyle='#5a3a1a'; ctx.fillRect(tx-4,GROUND-40,8,40);
      const fg=ctx.createRadialGradient(tx,GROUND-45,0,tx,GROUND-45,20);
      fg.addColorStop(0,`rgba(255,200,50,${flicker})`); fg.addColorStop(1,'rgba(255,100,0,0)');
      ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(tx,GROUND-45,20,0,Math.PI*2); ctx.fill();
    });
    // Coins
    coinItems.forEach(ci=>{
      ctx.fillStyle='#ffd700';
      const cg=ctx.createRadialGradient(ci.x,ci.y,0,ci.x,ci.y,8);
      cg.addColorStop(0,'#fff'); cg.addColorStop(0.3,'#ffd700'); cg.addColorStop(1,'#b8860b');
      ctx.fillStyle=cg; ctx.beginPath(); ctx.arc(ci.x,ci.y,8,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#fff'; ctx.lineWidth=1; ctx.stroke();
    });
    // Obstacles
    obstacles.forEach(o=>{
      if(o.type==='rock'){
        ctx.fillStyle='#5a4a3a'; ctx.beginPath();
        ctx.arc(o.x,o.y,o.w/2,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#6a5a4a'; ctx.beginPath(); ctx.arc(o.x-o.w/5,o.y-o.w/5,o.w/3,0,Math.PI*2); ctx.fill();
      } else if(o.type==='log'){
        ctx.fillStyle='#4a2a10'; ctx.beginPath(); ctx.roundRect(o.x-o.w/2,o.y-o.h,o.w,o.h,4); ctx.fill();
        ctx.strokeStyle='#6a4a20'; ctx.lineWidth=2; ctx.beginPath(); ctx.roundRect(o.x-o.w/2,o.y-o.h,o.w,o.h,4); ctx.stroke();
      } else {
        // low bar (must slide)
        ctx.fillStyle='#8b4513'; ctx.fillRect(o.x-2,GROUND-55,4,55);
        ctx.fillStyle='#6a3300'; ctx.fillRect(o.x-30,GROUND-60,60,10);
      }
    });
    // Player
    const py=player.sliding?player.y+20:player.y;
    const ph=player.sliding?35:55;
    if(player.alive){
      // Body
      ctx.fillStyle='#ff6600'; ctx.beginPath(); ctx.roundRect(player.x-10,py-ph+18,20,player.sliding?14:25,3); ctx.fill();
      // Head
      ctx.fillStyle='#ffd'; ctx.beginPath(); ctx.arc(player.x,py-ph+12,11,0,Math.PI*2); ctx.fill();
      // Hair
      ctx.fillStyle='#333'; ctx.fillRect(player.x-10,py-ph+2,20,8);
      // Legs (animated)
      if(!player.sliding){
        const lf=Math.sin(frame*0.35)*12;
        ctx.fillStyle='#333'; ctx.strokeStyle='#333'; ctx.lineWidth=3; ctx.lineCap='round';
        ctx.beginPath(); ctx.moveTo(player.x-3,py-12); ctx.lineTo(player.x-6+lf,py+2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(player.x+3,py-12); ctx.lineTo(player.x+6-lf,py+2); ctx.stroke();
      }
      // Arms
      const af=Math.sin(frame*0.35)*8;
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(player.x,py-ph+25); ctx.lineTo(player.x-14+af,py-ph+35); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(player.x,py-ph+25); ctx.lineTo(player.x+14-af,py-ph+35); ctx.stroke();
    } else {
      // Dead X eyes
      ctx.fillStyle='#ffd'; ctx.beginPath(); ctx.arc(player.x,py-40,11,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#ef4444'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(player.x-6,py-45); ctx.lineTo(player.x+6,py-35); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(player.x+6,py-45); ctx.lineTo(player.x-6,py-35); ctx.stroke();
    }
    if(!running&&score>0){
      ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#ff6600'; ctx.font='bold 26px Orbitron'; ctx.textAlign='center';
      ctx.fillText('üíÄ GAME OVER', W/2,H/2-15);
      ctx.fillStyle='#ffd700'; ctx.font='16px Exo 2'; ctx.fillText('Score: '+score+' | Coins: '+coins,W/2,H/2+20);
      ctx.textAlign='left';
    }
  }

  function update(){
    if(!running) return;
    frame++; score++;
    if(score%600===0&&speed<12) speed+=0.5;
    player.runFrame++;
    const se=document.getElementById('trScore');if(se)se.textContent=score;
    player.vy+=0.55; player.y=Math.min(GROUND,player.y+player.vy);
    if(player.y>=GROUND){player.y=GROUND;player.vy=0;player.jumping=false;}
    if(Math.random()<0.016) obstacles.push({x:W+30,y:GROUND,w:28+Math.random()*20,h:24+Math.random()*18,type:Math.random()<0.4?'rock':Math.random()<0.5?'log':'bar'});
    if(Math.random()<0.025) coinItems.push({x:W+10,y:GROUND-25-Math.random()*80});
    obstacles.forEach(o=>o.x-=speed);
    coinItems.forEach(ci=>ci.x-=speed);
    obstacles=obstacles.filter(o=>o.x>-60);
    coinItems=coinItems.filter(ci=>ci.x>-20);
    // Coin collect
    coinItems.forEach((ci,i)=>{
      if(Math.abs(player.x-ci.x)<18&&Math.abs(player.y-player.h/2-ci.y)<20){
        coins++; const ce=document.getElementById('trCoins');if(ce)ce.textContent=coins;
        coinItems.splice(i,1); showToast('ü™ô +1 Coin!');
      }
    });
    // Collision with obstacles
    obstacles.forEach(o=>{
      let hit=false;
      const ph=player.sliding?35:55;
      const py=player.sliding?player.y+20:player.y;
      if(o.type==='bar'){
        if(!player.sliding&&player.x+12>o.x-30&&player.x-12<o.x+30&&py-ph<GROUND-50) hit=true;
      } else {
        const hw=o.type==='rock'?o.w/2:o.w/2;
        if(player.x+10>o.x-hw&&player.x-10<o.x+hw&&py>o.y-o.h&&py-ph<o.y) hit=true;
      }
      if(hit){running=false;player.alive=false;showToast('üí• Game Over! Score: '+score);}
    });
    draw();
  }

  function jump(){if(running&&!player.jumping&&!player.sliding){player.vy=-13;player.jumping=true;}}
  const keyFn=e=>{if(e.key===' '||e.key==='ArrowUp'){e.preventDefault();jump();}if(e.key==='ArrowDown')player.sliding=true;};
  const keyUpFn=e=>{if(e.key==='ArrowDown')player.sliding=false;};
  addListener(document,'keydown',keyFn);
  addListener(document,'keyup',keyUpFn);
  addListener(canvas,'click',jump);
  addListener(canvas,'touchstart',e=>{e.preventDefault();const r=canvas.getBoundingClientRect();if(e.touches[0].clientY-r.top>H/2)player.sliding=true;else jump();},{passive:false});
  addListener(canvas,'touchend',()=>{player.sliding=false;});

  window.trStart=function(){
    score=0;coins=0;speed=5;obstacles=[];coinItems=[];frame=0;
    player.x=70;player.y=GROUND;player.vy=0;player.jumping=false;player.sliding=false;player.alive=true;running=true;
    const se=document.getElementById('trScore');if(se)se.textContent=0;
    const ce=document.getElementById('trCoins');if(ce)ce.textContent=0;
    const btn=document.getElementById('trBtn');if(btn)btn.textContent='Restart';
  };
  draw();
  startLoop(update);
}

/* ==============================================================
   GAME 14: STICKMAN RUN
============================================================== */
function buildStickman(c) {
  const W=500, H=300, GROUND=240;
  let running=false,score=0,best=0,speed=5,obstacles=[],frame=0;
  const p={x:70,y:GROUND,vy:0,jumping:false,alive:true};

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="smScore">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="smBest">0</div><div class="g-score-lbl">Best</div></div>
    </div>
    <canvas id="smCanvas" class="g-canvas" width="${W}" height="${H}"></canvas>
    <div class="g-hint">SPACE / Click / Tap to jump! How far can you run?</div>
    <button class="g-btn" id="smBtn" onclick="smStart()">üèÉ Run!</button>
  `;
  const canvas=document.getElementById('smCanvas');
  const ctx=canvas.getContext('2d');

  function drawStick(x,y,f,alive){
    const lf=alive?Math.sin(f*0.3)*14:0;
    ctx.strokeStyle=alive?'#ff6600':'#ef4444';
    ctx.lineWidth=2.5; ctx.lineCap='round';
    // Head
    ctx.fillStyle=alive?'#ffd':'#ccc'; ctx.beginPath(); ctx.arc(x,y-52,11,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=alive?'#ff6600':'#ef4444'; ctx.lineWidth=2; ctx.stroke();
    if(!alive){ctx.fillStyle='#ef4444';ctx.font='12px sans-serif';ctx.textAlign='center';ctx.fillText('‚úï',x-4,y-47);ctx.fillText('‚úï',x+4,y-47);ctx.textAlign='left';}
    // Body
    ctx.lineWidth=2.5; ctx.beginPath(); ctx.moveTo(x,y-40); ctx.lineTo(x,y-15); ctx.stroke();
    // Arms
    ctx.beginPath(); ctx.moveTo(x,y-33); ctx.lineTo(x-14+lf*0.5,y-22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y-33); ctx.lineTo(x+14-lf*0.5,y-22); ctx.stroke();
    // Legs
    ctx.beginPath(); ctx.moveTo(x,y-15); ctx.lineTo(x-10+lf,y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x,y-15); ctx.lineTo(x+10-lf,y); ctx.stroke();
  }

  function draw(){
    // Sky
    const sg=ctx.createLinearGradient(0,0,0,H);
    sg.addColorStop(0,'#0a0518'); sg.addColorStop(1,'#1a0a30');
    ctx.fillStyle=sg; ctx.fillRect(0,0,W,H);
    // Moon
    ctx.fillStyle='rgba(255,255,200,0.9)'; ctx.beginPath(); ctx.arc(W-50,30,16,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(0,0,20,0.4)'; ctx.beginPath(); ctx.arc(W-42,25,14,0,Math.PI*2); ctx.fill();
    // Stars
    ctx.fillStyle='rgba(255,255,255,0.6)';
    for(let i=0;i<20;i++) ctx.fillRect((i*73+score)%W,(i*47)%GROUND,1.5,1.5);
    // City silhouette
    ctx.fillStyle='#0a0a20';
    [40,100,160,220,280,340,400,460].forEach((bx,i)=>{
      const bh=40+i*12;
      ctx.fillRect(bx,GROUND+18-bh,30+i*3,bh);
      ctx.fillStyle='rgba(255,200,50,0.3)'; ctx.fillRect(bx+4,GROUND+18-bh+8,8,8);
      ctx.fillStyle='#0a0a20';
    });
    // Ground
    ctx.fillStyle='#2a1a0a'; ctx.fillRect(0,GROUND+18,W,H-GROUND);
    ctx.fillStyle='#ff6600'; ctx.fillRect(0,GROUND+18,W,3);
    // Track lines
    ctx.setLineDash([15,10]); ctx.strokeStyle='rgba(255,102,0,0.2)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,GROUND+10); ctx.lineTo(W,GROUND+10); ctx.stroke();
    ctx.setLineDash([]);
    // Obstacles
    obstacles.forEach(o=>{
      if(o.type==='spike'){
        ctx.fillStyle='#888';
        for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(o.x+i*12,GROUND+18);ctx.lineTo(o.x+i*12+6,GROUND-o.h+18);ctx.lineTo(o.x+i*12+12,GROUND+18);ctx.closePath();ctx.fill();}
      } else {
        ctx.fillStyle='#5a3a1a'; ctx.beginPath(); ctx.roundRect(o.x,GROUND+18-o.h,o.w,o.h,3); ctx.fill();
        ctx.strokeStyle='#8b5a30'; ctx.lineWidth=1.5; ctx.stroke();
      }
    });
    drawStick(p.x,p.y,frame,p.alive);
    if(!running&&score>0){
      ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#ff6600'; ctx.font='bold 26px Orbitron'; ctx.textAlign='center';
      ctx.fillText('üíÄ OUCH!', W/2,H/2-15);
      ctx.fillStyle='#fff'; ctx.font='17px Exo 2'; ctx.fillText('Score: '+score+' | Best: '+best,W/2,H/2+18);
      ctx.textAlign='left';
    }
  }

  function update(){
    if(!running)return;
    frame++; score++; speed=5+score/600;
    const se=document.getElementById('smScore');if(se)se.textContent=score;
    if(score>best){best=score;const be=document.getElementById('smBest');if(be)be.textContent=best;}
    p.vy+=0.55; p.y=Math.min(GROUND,p.y+p.vy);
    if(p.y>=GROUND){p.y=GROUND;p.vy=0;p.jumping=false;}
    if(Math.random()<0.018) obstacles.push({x:W+10,y:GROUND,h:22+Math.random()*22,w:10+Math.random()*16,type:Math.random()<0.4?'spike':'block'});
    obstacles.forEach(o=>o.x-=speed);
    obstacles=obstacles.filter(o=>o.x>-60);
    obstacles.forEach(o=>{
      if(p.x+12>o.x&&p.x-12<o.x+o.w&&p.y>GROUND+18-o.h&&p.y-55<GROUND+18){
        running=false; p.alive=false; showToast('üí• Hit! Score: '+score);
      }
    });
    draw();
  }

  function jump(){if(running&&!p.jumping){p.vy=-12.5;p.jumping=true;}}
  addListener(document,'keydown',e=>{if(e.key===' '||e.key==='ArrowUp'){e.preventDefault();jump();}});
  addListener(canvas,'click',jump);
  addListener(canvas,'touchstart',e=>{e.preventDefault();jump();},{passive:false});

  window.smStart=function(){
    score=0;speed=5;obstacles=[];p.x=70;p.y=GROUND;p.vy=0;p.jumping=false;p.alive=true;frame=0;running=true;
    const se=document.getElementById('smScore');if(se)se.textContent=0;
    const btn=document.getElementById('smBtn');if(btn)btn.textContent='Restart';
  };
  draw();
  startLoop(update);
}

/* ==============================================================
   FIXED & NEW GAMES ‚Äî uses addListener, startLoop, addInterval
============================================================== */

/* ============================================================
   GAME: ARROW & BOW (FIXED)
============================================================ */
function buildArrowBow(c, lv) {
  lv = lv||1;
  const W=500, H=400, AX=55, AY=200;
  let targets=[], arrows=[], score=0, shots=10+lv*2, streak=0;
  let holding=false, holdStart=0, mx=W/2, my=100;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="abSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="abSh">${shots}</div><div class="g-score-lbl">Arrows</div></div>
      <div class="g-score-item"><div class="g-score-val" id="abSt">x1</div><div class="g-score-lbl">Streak</div></div>
    </div>
    <canvas id="abC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;"></canvas>
    <div class="g-hint">Hold mouse to charge power, release to shoot! üéØ</div>
    <button class="g-btn" onclick="buildArrowBow(document.getElementById('gc'),${lv})">New Game</button>`;

  const cv=document.getElementById('abC'), ctx=cv.getContext('2d');
  for(let i=0;i<3+lv;i++) spawnT();

  function spawnT(){
    targets.push({x:200+Math.random()*(W-250),y:60+Math.random()*(H-120),r:36,vx:(Math.random()-.5)*2.5,vy:(Math.random()-.5)*1.5,hp:1});
  }

  function drawTarget(t){
    [[t.r,'#ef4444'],[t.r*.7,'#fff'],[t.r*.45,'#3b82f6'],[t.r*.2,'#ffd700']].forEach(([r,c2])=>{ctx.beginPath();ctx.arc(t.x,t.y,r,0,Math.PI*2);ctx.fillStyle=c2;ctx.fill();});
    ctx.beginPath();ctx.arc(t.x,t.y,3,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();
  }

  function draw(){
    const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#0a1520');bg.addColorStop(1,'#1a2a10');
    ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#2a3a10';ctx.fillRect(0,H-40,W,40);
    ctx.fillStyle='#3a4a15';ctx.fillRect(0,H-42,W,4);
    [80,180,380,460].forEach(x=>{ctx.fillStyle='#1a3a0a';ctx.fillRect(x-8,H-80,16,42);ctx.beginPath();ctx.arc(x,H-90,28,0,Math.PI*2);ctx.fill();});
    targets.forEach(t=>drawTarget(t));
    // Archer
    ctx.fillStyle='#ffd';ctx.beginPath();ctx.arc(AX,AY-35,10,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#8b4513';ctx.fillRect(AX-7,AY-24,14,28);
    // Bow & aim
    const ang=Math.atan2(my-(AY-18),mx-AX);
    ctx.save();ctx.translate(AX+8,AY-18);ctx.rotate(ang);
    ctx.strokeStyle='#8b4513';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,28,-1.0,1.0);ctx.stroke();
    ctx.strokeStyle='#ddd';ctx.lineWidth=1.5;
    const pw=holding?Math.min((Date.now()-holdStart)/1000,1):0;
    ctx.beginPath();ctx.moveTo(28*Math.cos(-1.0),28*Math.sin(-1.0));ctx.lineTo(-8-pw*12,0);ctx.lineTo(28*Math.cos(1.0),28*Math.sin(1.0));ctx.stroke();
    ctx.restore();
    // Aim line
    ctx.save();ctx.setLineDash([6,10]);ctx.strokeStyle='rgba(255,200,0,.25)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(AX+10,AY-18);ctx.lineTo(AX+Math.cos(ang)*120,AY-18+Math.sin(ang)*120);ctx.stroke();ctx.restore();
    // Power bar
    if(holding){const pw2=Math.min((Date.now()-holdStart)/1000,1);ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(AX-25,AY+15,50,10);ctx.fillStyle=`hsl(${120-pw2*120},100%,45%)`;ctx.fillRect(AX-25,AY+15,50*pw2,10);ctx.fillStyle='rgba(255,255,255,.6)';ctx.font='9px Exo 2';ctx.fillText('POWER',AX-15,AY+32);}
    // Arrows in flight
    arrows.forEach(a=>{ctx.save();ctx.translate(a.x,a.y);ctx.rotate(Math.atan2(a.vy,a.vx));ctx.fillStyle='#d2691e';ctx.fillRect(-12,-2,22,4);ctx.fillStyle='#ffd700';ctx.beginPath();ctx.moveTo(10,0);ctx.lineTo(-4,-6);ctx.lineTo(-4,6);ctx.closePath();ctx.fill();ctx.restore();});
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.font='bold 12px Exo 2';ctx.fillText('Score: '+score,8,20);
    if(shots<=0&&arrows.every(a=>a.done)){ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 26px Orbitron';ctx.textAlign='center';ctx.fillText('Game Over!',W/2,H/2-10);ctx.fillStyle='#fff';ctx.font='16px Exo 2';ctx.fillText('Score: '+score,W/2,H/2+20);ctx.textAlign='left';}
  }

  function update(){
    targets.forEach(t=>{t.x+=t.vx;t.y+=t.vy;if(t.x<t.r||t.x>W-t.r)t.vx*=-1;if(t.y<t.r||t.y>H-60-t.r)t.vy*=-1;});
    arrows.forEach(a=>{if(a.done)return;a.x+=a.vx;a.y+=a.vy;a.vy+=.25;
      if(a.x>W+20||a.y>H+20){a.done=true;return;}
      targets.forEach((t,i)=>{if(a.done)return;const dx=a.x-t.x,dy=a.y-t.y;if(Math.sqrt(dx*dx+dy*dy)<t.r){
        a.done=true;const dist=Math.sqrt(dx*dx+dy*dy);
        let pts=dist<t.r*.2?100:dist<t.r*.5?60:dist<t.r*.75?30:10;
        streak++;pts*=Math.min(streak,5);score+=pts;
        showToast((dist<t.r*.2?'üí• Bullseye! ':'üéØ Hit! ')+'+'+pts+(streak>1?' x'+Math.min(streak,5):''));
        targets.splice(i,1);spawnT();
        const se=document.getElementById('abSc');if(se)se.textContent=score;
        const st=document.getElementById('abSt');if(st)st.textContent='x'+Math.min(streak,5);
        if(score>=200*lv)setTimeout(()=>showWin('Score: '+score+'! Archery Master!','arrowbow',()=>openGame('arrowbow')),400);
      }});
    });
    arrows=arrows.filter(a=>!a.done);
    draw();
  }

  function shoot(){
    if(shots<=0)return;const pw=Math.min((Date.now()-holdStart)/1000,1);
    const ang=Math.atan2(my-(AY-18),mx-AX);const spd=6+pw*16;
    arrows.push({x:AX+10,y:AY-18,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,done:false});
    shots--;streak=0;const se=document.getElementById('abSh');if(se)se.textContent=shots;
    const st=document.getElementById('abSt');if(st)st.textContent='x1';
  }

  addListener(cv,'mousemove',e=>{const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;});
  addListener(cv,'mousedown',()=>{holding=true;holdStart=Date.now();});
  addListener(cv,'mouseup',()=>{if(holding){holding=false;shoot();}});
  addListener(cv,'touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();mx=e.touches[0].clientX-r.left;my=e.touches[0].clientY-r.top;},{passive:false});
  addListener(cv,'touchstart',e=>{e.preventDefault();const r=cv.getBoundingClientRect();mx=e.touches[0].clientX-r.left;my=e.touches[0].clientY-r.top;holding=true;holdStart=Date.now();},{passive:false});
  addListener(cv,'touchend',e=>{e.preventDefault();if(holding){holding=false;shoot();}},{passive:false});
  draw();startLoop(update);
}

/* ============================================================
   GAME: CANDY CRUSH (FIXED)
============================================================ */
function buildCandy(c, lv) {
  lv=lv||1;
  const COLS2=8,ROWS2=8;
  const EMOJIS=['üç¨','üç≠','üç´','üç©','üç™','üçÆ','üç°'];
  const nTypes=Math.min(4+lv,7);
  let board=[],sel=null,moves=20+lv*5,score=0,animating=false;

  function rnd(){return EMOJIS[Math.floor(Math.random()*nTypes)];}
  function initBoard(){
    board=Array.from({length:ROWS2},()=>Array.from({length:COLS2},()=>rnd()));
    while(findMatches().length)board=Array.from({length:ROWS2},()=>Array.from({length:COLS2},()=>rnd()));
  }

  function findMatches(){
    const m=new Set();
    for(let r=0;r<ROWS2;r++)for(let col=0;col<COLS2-2;col++)if(board[r][col]&&board[r][col]===board[r][col+1]&&board[r][col]===board[r][col+2]){m.add(r+','+col);m.add(r+','+(col+1));m.add(r+','+(col+2));}
    for(let r=0;r<ROWS2-2;r++)for(let col=0;col<COLS2;col++)if(board[r][col]&&board[r][col]===board[r+1][col]&&board[r][col]===board[r+2][col]){m.add(r+','+col);m.add((r+1)+','+col);m.add((r+2)+','+col);}
    return[...m].map(k=>{const[r,col]=k.split(',').map(Number);return[r,col];});
  }

  function clearAndFill(){
    const m=findMatches();if(!m.length)return false;
    m.forEach(([r,col])=>{score+=10;board[r][col]=null;});
    // Gravity
    for(let col=0;col<COLS2;col++){let empty=[];for(let r=ROWS2-1;r>=0;r--){if(!board[r][col])empty.push(r);}for(let r=ROWS2-1;r>=0;r--){if(board[r][col]&&empty.length){const t=empty.shift();board[t][col]=board[r][col];board[r][col]=null;empty.push(r);}}}
    for(let r=0;r<ROWS2;r++)for(let col=0;col<COLS2;col++)if(!board[r][col])board[r][col]=rnd();
    return true;
  }

  function render(){
    const ms=document.getElementById('ccMv');if(ms)ms.textContent=moves;
    const ss=document.getElementById('ccSc');if(ss)ss.textContent=score;
    const CS=40;
    const g=document.getElementById('ccGrid');if(!g)return;
    g.style.cssText=`display:grid;grid-template-columns:repeat(${COLS2},${CS}px);gap:3px;`;
    g.innerHTML=board.flatMap((row,r)=>row.map((e,col)=>{
      const isSel=sel&&sel[0]===r&&sel[1]===col;
      return`<div onclick="ccTap(${r},${col})" style="width:${CS}px;height:${CS}px;background:rgba(255,255,255,${isSel?.18:.06});border:${isSel?'2px solid #fff':'1px solid rgba(255,255,255,.1)'};border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;transition:all .1s;user-select:none;">${e||''}</div>`;
    })).join('');
  }

  window.ccTap=function(r,col){
    if(animating||moves<=0)return;
    if(!sel){sel=[r,col];render();return;}
    const[sr,sc]=sel;
    if(sr===r&&sc===col){sel=null;render();return;}
    const adj=(Math.abs(sr-r)+Math.abs(sc-col))===1;
    if(!adj){sel=[r,col];render();return;}
    [board[sr][sc],board[r][col]]=[board[r][col],board[sr][sc]];
    sel=null;moves--;
    if(!clearAndFill()){[board[sr][sc],board[r][col]]=[board[r][col],board[sr][sc]];moves++;showToast('No match here!');}
    else{animating=true;const cascade=()=>{if(clearAndFill())setTimeout(cascade,300);else{animating=false;if(moves<=0&&score<150*lv)showToast('Out of moves! Score: '+score);if(score>=150*lv)setTimeout(()=>showWin('Score: '+score+'! Sweet!','candycrush',()=>openGame('candycrush')),300);}};setTimeout(cascade,300);}
    render();
  };

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="ccSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="ccMv">${moves}</div><div class="g-score-lbl">Moves</div></div>
    </div>
    <div style="overflow-x:auto;max-width:100%;" id="ccGrid"></div>
    <div class="g-hint">Click two adjacent candies to swap! Match 3+ to clear!</div>
    <button class="g-btn" onclick="buildCandy(document.getElementById('gc'),${lv})">New Game</button>`;
  initBoard();render();
}



/* ============================================================
   GAME: SPACE BLASTER (FIXED)
============================================================ */
function buildSpaceship(c, lv) {
  lv=lv||1;
  const W=500,H=420;
  let aliens=[],bullets=[],particles3=[],score=0,lives=3,wave=1,mx=W/2,my=H/2,shootTimer=0;
  let alienBullets=[],invincible=0;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="spSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="spLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="g-score-lbl">Lives</div></div>
      <div class="g-score-item"><div class="g-score-val" id="spWv">1</div><div class="g-score-lbl">Wave</div></div>
    </div>
    <canvas id="spC" class="g-canvas" width="${W}" height="${H}" style="cursor:none;"></canvas>
    <div class="g-hint">Move mouse to aim ‚Äî auto-shooting! Kill all aliens to advance!</div>`;

  const cv=document.getElementById('spC'),ctx=cv.getContext('2d');

  function spawnWave(){
    aliens=[];const cnt=6+(wave-1)*2+lv;
    for(let i=0;i<cnt;i++) aliens.push({x:50+Math.random()*(W-100),y:30+Math.random()*120,vx:(Math.random()-.5)*1.5*(1+wave*.1),vy:.3+Math.random()*.3,hp:1+Math.floor(wave/3),maxHp:1+Math.floor(wave/3),hue:Math.random()*360,stimer:60+Math.random()*80});
  }

  function draw(){
    const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#030308');bg.addColorStop(1,'#080318');
    ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
    for(let i=0;i<80;i++){ctx.fillStyle='rgba(255,255,255,'+(.3+Math.random()*.5)+')';ctx.fillRect((i*97+Date.now()/50)%W,(i*113)%H,1.5,1.5);}
    aliens.forEach(a=>{
      if(invincible%6<3){ctx.fillStyle='rgba(255,255,255,.05)';ctx.beginPath();ctx.arc(a.x,a.y,35,0,Math.PI*2);ctx.fill();}
      const ag=ctx.createRadialGradient(a.x-5,a.y-5,0,a.x,a.y,28);ag.addColorStop(0,`hsl(${a.hue},80%,65%)`);ag.addColorStop(1,`hsl(${a.hue},60%,28%)`);
      ctx.fillStyle=ag;ctx.beginPath();ctx.arc(a.x,a.y,20,0,Math.PI*2);ctx.fill();
      [-7,7].forEach(dx=>{ctx.fillStyle='rgba(0,0,0,.7)';ctx.beginPath();ctx.arc(a.x+dx,a.y-5,5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#f00';ctx.beginPath();ctx.arc(a.x+dx,a.y-5,2,0,Math.PI*2);ctx.fill();});
      if(a.hp>1){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(a.x-20,a.y+24,40,6);ctx.fillStyle='#22c55e';ctx.fillRect(a.x-20,a.y+24,40*(a.hp/a.maxHp),6);}
    });
    bullets.forEach(b=>{ctx.fillStyle='#ff0';ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,0,.3)';ctx.beginPath();ctx.arc(b.x,b.y,8,0,Math.PI*2);ctx.fill();});
    alienBullets.forEach(b=>{ctx.fillStyle='#f33';ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();});
    particles3.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.s*p.life,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;});
    // Ship
    const sx=mx,sy=H-40;
    if(invincible%8<5){
      ctx.fillStyle='#ff6600';ctx.beginPath();ctx.moveTo(sx,sy-22);ctx.lineTo(sx-18,sy+15);ctx.lineTo(sx,sy+8);ctx.lineTo(sx+18,sy+15);ctx.closePath();ctx.fill();
      ctx.fillStyle='#ff8833';ctx.beginPath();ctx.moveTo(sx,sy-15);ctx.lineTo(sx-10,sy+8);ctx.lineTo(sx+10,sy+8);ctx.closePath();ctx.fill();
      ctx.fillStyle='rgba(255,255,0,.8)';ctx.beginPath();ctx.arc(sx,sy-5,5,0,Math.PI*2);ctx.fill();
    }
    // Crosshair
    ctx.strokeStyle='rgba(255,200,0,.5)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(mx-20,my);ctx.lineTo(mx+20,my);ctx.moveTo(mx,my-20);ctx.lineTo(mx,my+20);ctx.stroke();ctx.setLineDash([]);
    ctx.strokeStyle='rgba(255,200,0,.3)';ctx.beginPath();ctx.arc(mx,my,12,0,Math.PI*2);ctx.stroke();
  }

  function update(){
    const sx=mx,sy=H-40;
    shootTimer++;
    const rate=Math.max(6-lv,3);
    if(shootTimer>=rate){shootTimer=0;const dx=mx-sx,dy=my-sy,d=Math.hypot(dx,dy)||1;bullets.push({x:sx,y:sy,vx:dx/d*14,vy:dy/d*14});}
    bullets=bullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;return b.y>0&&b.y<H&&b.x>0&&b.x<W;});
    alienBullets=alienBullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;return b.y<H+10;});
    aliens.forEach(a=>{a.x+=a.vx;a.y+=a.vy;if(a.x<20||a.x>W-20)a.vx*=-1;
      a.stimer--;if(a.stimer<=0){a.stimer=50+Math.random()*60;const dx=sx-a.x,dy=sy-a.y,d=Math.hypot(dx,dy)||1;alienBullets.push({x:a.x,y:a.y,vx:dx/d*3,vy:dy/d*3});}});
    // Bullet-alien collision
    bullets.forEach((b,bi)=>{aliens.forEach((a,ai)=>{if(Math.hypot(b.x-a.x,b.y-a.y)<22){a.hp--;bullets.splice(bi,1);if(a.hp<=0){for(let i=0;i<12;i++)particles3.push({x:a.x,y:a.y,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,s:4+Math.random()*4,life:1,c:`hsl(${a.hue},80%,60%)`});score+=20;aliens.splice(ai,1);const ss=document.getElementById('spSc');if(ss)ss.textContent=score;};}});});
    // Alien bullet hits ship
    if(invincible<=0){alienBullets.forEach((b,bi)=>{if(Math.hypot(b.x-sx,b.y-sy)<25){lives--;alienBullets.splice(bi,1);invincible=120;const le=document.getElementById('spLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));showToast('üí• Hit! '+lives+' lives');if(lives<=0){showToast('Game Over!');return;}}});}
    if(invincible>0)invincible--;
    particles3.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=.02;});particles3=particles3.filter(p=>p.life>0);
    if(!aliens.length){wave++;const we=document.getElementById('spWv');if(we)we.textContent=wave;spawnWave();showToast('Wave '+wave+'! üöÄ');if(score>=400*lv)setTimeout(()=>showWin('Score: '+score+'! Wave '+wave+'!','spaceship',()=>openGame('spaceship')),400);}
    draw();
  }

  addListener(cv,'mousemove',e=>{const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;});
  addListener(cv,'touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();mx=e.touches[0].clientX-r.left;my=e.touches[0].clientY-r.top;},{passive:false});
  spawnWave();draw();startLoop(update);
}

/* ============================================================
   GAME: CAR RACING (FIXED ‚Äî no lane overlap)
============================================================ */
function buildCarRace(c, lv) {
  lv=lv||1;
  const W=400,H=500;
  const LANES=[78,155,232,309];
  let cars=[],score=0,lives=3,speed=3+lv,px=LANES[1],invincible=0;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="crSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="crLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="g-score-lbl">Lives</div></div>
    </div>
    <canvas id="crC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;"></canvas>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button class="g-btn" onclick="crMv(-1)" style="padding:10px 28px;">‚óÄ Left</button>
      <button class="g-btn" onclick="crMv(1)" style="padding:10px 28px;">Right ‚ñ∂</button>
    </div>
    <div class="g-hint">Arrow keys or tap/click buttons. Dodge the traffic!</div>`;

  const cv=document.getElementById('bCarCanvas')||document.getElementById('crC'),ctx=(document.getElementById('crC')||cv).getContext('2d');
  const canvas=document.getElementById('crC');const ctx2=canvas.getContext('2d');

  let curLane=1,roadOff=0;
  const COLORS=['#ef4444','#3b82f6','#22c55e','#f59e0b','#8b5cf6','#ec4899'];

  function canSpawn(lane){return !cars.some(car=>car.lane===lane&&car.y>0&&car.y<200);}

  function draw(){
    ctx2.fillStyle='#1a1a1a';ctx2.fillRect(0,0,W,H);
    ctx2.fillStyle='#2a2a2a';ctx2.fillRect(40,0,W-80,H);
    roadOff=(roadOff+speed)%80;
    ctx2.strokeStyle='rgba(255,255,255,.3)';ctx2.lineWidth=2;ctx2.setLineDash([40,40]);
    [117,195,273].forEach(x=>{ctx2.beginPath();ctx2.moveTo(x,-80+roadOff);ctx2.lineTo(x,H+80);ctx2.stroke();});
    ctx2.setLineDash([]);
    // Traffic cars
    cars.forEach(car=>{const cl=COLORS[car.col%COLORS.length];ctx2.fillStyle=cl;ctx2.beginPath();ctx2.roundRect(car.x-22,car.y-44,44,70,6);ctx2.fill();ctx2.fillStyle='rgba(200,230,255,.7)';ctx2.fillRect(car.x-16,car.y-38,32,18);ctx2.fillRect(car.x-16,car.y-16,32,18);ctx2.fillStyle='rgba(0,0,0,.4)';ctx2.fillRect(car.x-22,car.y-44,6,12);ctx2.fillRect(car.x+16,car.y-44,6,12);ctx2.fillRect(car.x-22,car.y+20,6,12);ctx2.fillRect(car.x+16,car.y+20,6,12);});
    // Player car
    if(invincible%8<5){ctx2.fillStyle='#ff6600';ctx2.beginPath();ctx2.roundRect(px-22,H-120,44,70,6);ctx2.fill();ctx2.fillStyle='rgba(200,230,255,.8)';ctx2.fillRect(px-16,H-114,32,18);ctx2.fillRect(px-16,H-92,32,18);ctx2.fillStyle='#ffd700';ctx2.fillRect(px-22,H-50,8,10);ctx2.fillRect(px+14,H-50,8,10);}
    ctx2.setLineDash([]);
  }

  function update(){
    score++;speed=3+lv+score/300;
    const ss=document.getElementById('crSc');if(ss)ss.textContent=Math.floor(score/10);
    cars.forEach(car=>{car.y+=speed;});
    cars=cars.filter(car=>car.y<H+60);
    if(Math.random()<.02){const lane=LANES[Math.floor(Math.random()*4)];if(canSpawn(lane))cars.push({x:lane,y:-60,lane,col:Math.floor(Math.random()*6)});}
    if(invincible<=0){cars.forEach(car=>{if(Math.abs(car.x-px)<38&&car.y>H-170&&car.y<H-60){invincible=90;lives--;const le=document.getElementById('crLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));showToast('üí• Crash! '+lives+' lives left');if(lives<=0){showToast('Game Over! Score: '+Math.floor(score/10));if(score/10>=300*lv)setTimeout(()=>showWin('Score: '+Math.floor(score/10)+'! Speed Racer!','carracing',()=>openGame('carracing')),400);};}});}
    if(invincible>0)invincible--;
    draw();
  }

  window.crMv=function(dir){
    const ni=LANES.indexOf(px);const nn=Math.max(0,Math.min(3,ni+dir));px=LANES[nn];curLane=nn;
  };

  addListener(document,'keydown',e=>{if(e.key==='ArrowLeft'){e.preventDefault();crMv(-1);}if(e.key==='ArrowRight'){e.preventDefault();crMv(1);}});
  addListener(canvas,'touchstart',e=>{e.preventDefault();const r=canvas.getBoundingClientRect();const tx=e.touches[0].clientX-r.left;crMv(tx>W/2?1:-1);},{passive:false});
  draw();startLoop(update);
}

/* ============================================================
   GAME: BIKE RACING (FIXED)
============================================================ */
function buildBikeRace(c, lv) {
  lv=lv||1;
  const W=400,H=500;
  const LANES=[80,155,230,305];
  let obstacles=[],score=0,lives=3,speed=3+lv,px=LANES[1],invincible=0;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="brSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="brLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="g-score-lbl">Lives</div></div>
    </div>
    <canvas id="brC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;"></canvas>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button class="g-btn" onclick="brMv(-1)" style="padding:10px 28px;">‚óÄ Left</button>
      <button class="g-btn" onclick="brMv(1)" style="padding:10px 28px;">Right ‚ñ∂</button>
    </div>
    <div class="g-hint">Arrow keys or tap. Dodge all cars on your bike!</div>`;

  const canvas=document.getElementById('brC');const ctx=canvas.getContext('2d');
  let roadOff=0;const COLORS=['#ef4444','#3b82f6','#22c55e','#f59e0b'];

  function canSpawn(lane){return !obstacles.some(o=>o.lane===lane&&o.y>0&&o.y<200);}

  function draw(){
    ctx.fillStyle='#1a1a1a';ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#2a2a2a';ctx.fillRect(35,0,W-70,H);
    roadOff=(roadOff+speed)%80;
    ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1.5;ctx.setLineDash([40,40]);
    [115,195,272].forEach(x=>{ctx.beginPath();ctx.moveTo(x,-80+roadOff);ctx.lineTo(x,H);ctx.stroke();});
    ctx.setLineDash([]);
    obstacles.forEach(o=>{ctx.fillStyle=COLORS[o.col%4];ctx.beginPath();ctx.roundRect(o.x-22,o.y-44,44,70,6);ctx.fill();ctx.fillStyle='rgba(200,230,255,.7)';ctx.fillRect(o.x-16,o.y-38,32,18);});
    // Bike
    if(invincible%8<5){ctx.fillStyle='#ff6600';ctx.save();ctx.translate(px,H-100);ctx.strokeStyle='#ff8833';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,20,22,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(0,-18,22,0,Math.PI*2);ctx.stroke();ctx.fillStyle='#ff6600';ctx.fillRect(-5,-18,10,38);ctx.fillStyle='#ffd';ctx.beginPath();ctx.arc(0,-28,8,0,Math.PI*2);ctx.fill();ctx.restore();}
  }

  function update(){
    score++;speed=3+lv+score/400;
    const ss=document.getElementById('brSc');if(ss)ss.textContent=Math.floor(score/10);
    obstacles.forEach(o=>o.y+=speed);
    obstacles=obstacles.filter(o=>o.y<H+60);
    if(Math.random()<.018){const lane=LANES[Math.floor(Math.random()*4)];if(canSpawn(lane))obstacles.push({x:lane,y:-60,lane,col:Math.floor(Math.random()*4)});}
    if(invincible<=0){obstacles.forEach(o=>{if(Math.abs(o.x-px)<32&&o.y>H-155&&o.y<H-55){invincible=90;lives--;const le=document.getElementById('brLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));showToast('üí• Crash! '+lives+' lives');if(lives<=0)showToast('Game Over! Score: '+Math.floor(score/10));}});}
    if(invincible>0)invincible--;
    if(score/10>=300*lv)setTimeout(()=>showWin('Score: '+Math.floor(score/10)+'! Speed Biker!','bikeracing',()=>openGame('bikeracing')),400);
    draw();
  }

  window.brMv=function(dir){const ni=LANES.indexOf(px);const nn=Math.max(0,Math.min(3,ni+dir));px=LANES[nn];};
  addListener(document,'keydown',e=>{if(e.key==='ArrowLeft'){e.preventDefault();brMv(-1);}if(e.key==='ArrowRight'){e.preventDefault();brMv(1);}});
  addListener(canvas,'touchstart',e=>{e.preventDefault();const r=canvas.getBoundingClientRect();brMv(e.touches[0].clientX-r.left>W/2?1:-1);},{passive:false});
  draw();startLoop(update);
}

/* ============================================================
   GAME: GUN FIGHT (FIXED)
============================================================ */
function buildGunFight(c, lv) {
  lv=lv||1;
  const W=500,H=400;
  let enemies=[],bullets=[],particles4=[],score=0,ammo=12,wave=1,mx=W/2,my=H/2;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="gfSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="gfAm">12</div><div class="g-score-lbl">Ammo</div></div>
      <div class="g-score-item"><div class="g-score-val" id="gfWv">1</div><div class="g-score-lbl">Wave</div></div>
    </div>
    <canvas id="gfC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;touch-action:none;"></canvas>
    <div class="g-hint">Click/tap to shoot! Press R to reload (12 ammo). Kill all enemies!</div>
    <button class="g-btn" id="gfBtn" onclick="gfSt()">‚öîÔ∏è Start!</button>`;

  const cv=document.getElementById('gfC'),ctx=cv.getContext('2d');
  const pX=W/2,pY=H-32;
  let running=false;

  function spawnWave(){const cnt=3+(wave-1)*2+lv;for(let i=0;i<cnt;i++)enemies.push({x:40+Math.random()*(W-80),y:-(40+Math.random()*100),r:20,hp:1+Math.floor((wave+lv)/3),maxHp:1+Math.floor((wave+lv)/3),vx:(Math.random()-.5)*1.8,vy:.6+wave*.2+lv*.1,hue:Math.random()*360,stimer:80+Math.random()*80});}

  function draw(){
    const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#030308');bg.addColorStop(1,'#0a0308');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#1a1a1a';ctx.fillRect(0,H-45,W,45);ctx.fillStyle='#ff6600';ctx.fillRect(0,H-47,W,3);
    enemies.forEach(e=>{const eg=ctx.createRadialGradient(e.x-4,e.y-4,0,e.x,e.y,e.r);eg.addColorStop(0,`hsl(${e.hue},80%,60%)`);eg.addColorStop(1,`hsl(${e.hue},60%,25%)`);ctx.fillStyle=eg;ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();[-7,7].forEach(dx=>{ctx.fillStyle='rgba(0,0,0,.8)';ctx.beginPath();ctx.arc(e.x+dx,e.y-4,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#f00';ctx.beginPath();ctx.arc(e.x+dx,e.y-4,2,0,Math.PI*2);ctx.fill();});if(e.hp<e.maxHp){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(e.x-20,e.y+24,40,5);ctx.fillStyle='#22c55e';ctx.fillRect(e.x-20,e.y+24,40*(e.hp/e.maxHp),5);}});
    bullets.forEach(b=>{ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(b.x,b.y,5,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,215,0,.3)';ctx.beginPath();ctx.arc(b.x,b.y,9,0,Math.PI*2);ctx.fill();});
    particles4.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.s*p.life,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;});
    // Player
    ctx.fillStyle='#ff6600';ctx.beginPath();ctx.roundRect(pX-22,pY-12,44,24,5);ctx.fill();
    const ang2=Math.atan2(my-pY,mx-pX);ctx.save();ctx.translate(pX,pY);ctx.rotate(ang2);ctx.fillStyle='#888';ctx.beginPath();ctx.roundRect(0,-4,32,8,3);ctx.fill();ctx.restore();
    // Crosshair
    ctx.strokeStyle='rgba(255,200,0,.5)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(mx-15,my);ctx.lineTo(mx+15,my);ctx.moveTo(mx,my-15);ctx.lineTo(mx,my+15);ctx.stroke();ctx.setLineDash([]);
    ctx.strokeStyle='rgba(255,200,0,.3)';ctx.beginPath();ctx.arc(mx,my,10,0,Math.PI*2);ctx.stroke();
    // Ammo
    ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(6,H-40,90,28);ctx.fillStyle=ammo>3?'#22c55e':'#ef4444';ctx.font='bold 11px Orbitron';ctx.fillText('AMMO: '+ammo,10,H-22);
    if(!running){ctx.fillStyle='rgba(0,0,0,.75)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 26px Orbitron';ctx.textAlign='center';ctx.fillText('CLICK TO SHOOT',W/2,H/2);ctx.textAlign='left';}
  }

  function shoot(){
    if(!running||ammo<=0)return;
    const dx=mx-pX,dy=my-pY,d=Math.hypot(dx,dy)||1;
    bullets.push({x:pX,y:pY,vx:dx/d*15,vy:dy/d*15});ammo--;
    const ae=document.getElementById('gfAm');if(ae)ae.textContent=ammo;
  }

  function reload(){ammo=12;const ae=document.getElementById('gfAm');if(ae)ae.textContent=12;showToast('üîÑ Reloaded!');}

  function update(){
    if(!running)return;
    enemies.forEach(e=>{e.x+=e.vx;e.y+=e.vy;if(e.x<20||e.x>W-20)e.vx*=-1;e.stimer--;if(e.stimer<=0){e.stimer=40+Math.random()*60;const dx=pX-e.x,dy=pY-e.y,d=Math.hypot(dx,dy)||1;bullets.push({x:e.x,y:e.y,vx:dx/d*3.5,vy:dy/d*3.5,fromEnemy:true});}});
    bullets=bullets.filter(b=>{b.x+=b.vx;b.y+=b.vy;return b.x>0&&b.x<W&&b.y>0&&b.y<H;});
    bullets.forEach((b,bi)=>{if(b.fromEnemy)return;enemies.forEach((e,ei)=>{if(Math.hypot(b.x-e.x,b.y-e.y)<e.r+4){e.hp--;bullets.splice(bi,1);if(e.hp<=0){for(let i=0;i<12;i++)particles4.push({x:e.x,y:e.y,vx:(Math.random()-.5)*9,vy:(Math.random()-.5)*9,s:3+Math.random()*4,life:1,c:`hsl(${e.hue},80%,60%)`});score+=30;enemies.splice(ei,1);const ss=document.getElementById('gfSc');if(ss)ss.textContent=score;};}});});
    particles4.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=.025;});particles4=particles4.filter(p=>p.life>0);
    if(!enemies.length){wave++;const we=document.getElementById('gfWv');if(we)we.textContent=wave;spawnWave();reload();showToast('Wave '+wave+'! Reloaded!');if(score>=400*lv)setTimeout(()=>showWin('Score: '+score+'! Combat Expert!','gunfight',()=>openGame('gunfight')),400);}
    draw();
  }

  window.gfSt=function(){enemies=[];bullets=[];particles4=[];score=0;ammo=12;wave=1;running=true;spawnWave();const btn=document.getElementById('gfBtn');if(btn)btn.textContent='Restart';};
  addListener(cv,'mousemove',e=>{const r=cv.getBoundingClientRect();mx=e.clientX-r.left;my=e.clientY-r.top;});
  addListener(cv,'click',()=>shoot());
  addListener(cv,'touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();mx=e.touches[0].clientX-r.left;my=e.touches[0].clientY-r.top;},{passive:false});
  addListener(cv,'touchstart',e=>{e.preventDefault();const r=cv.getBoundingClientRect();mx=e.touches[0].clientX-r.left;my=e.touches[0].clientY-r.top;shoot();},{passive:false});
  addListener(document,'keydown',e=>{if(e.key==='r'||e.key==='R')reload();});
  draw();startLoop(update);
}



/* ============================================================
   GAME: BOX FILL / TETRIS (FIXED)
============================================================ */
function buildTetris(c, lv) {
  lv=lv||1;
  const COLS=10,ROWS=20,CS=26;
  const PIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[1,1,1],[0,1,0]],[[1,1,1],[1,0,0]],[[1,1,1],[0,0,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]];
  const COLORS=['#00f5ff','#ffd700','#a855f7','#f97316','#3b82f6','#22c55e','#ef4444'];
  let board=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  let cur=null,score=0,lines=0,level=lv,gameOver=false,dropTimer=0;
  const dropSpeed=Math.max(100,500-level*40);

  function newPiece(){const t=Math.floor(Math.random()*7);return{shape:PIECES[t].map(r=>[...r]),color:COLORS[t],x:Math.floor(COLS/2)-1,y:0};}
  function rotate(s){return s[0].map((_,i)=>s.map(r=>r[i])).reverse();}
  function valid(s,x,y){return s.every((row,r)=>row.every((v,col)=>!v||((y+r>=0&&y+r<ROWS)&&(x+col>=0&&x+col<COLS)&&!board[y+r][x+col])));}

  function lock(){cur.shape.forEach((row,r)=>row.forEach((v,col)=>{if(v&&cur.y+r>=0)board[cur.y+r][cur.x+col]=cur.color;}));let cleared=0;for(let r=ROWS-1;r>=0;r--){if(board[r].every(c=>c)){board.splice(r,1);board.unshift(Array(COLS).fill(0));cleared++;r++;}}if(cleared){const pts=[0,100,300,500,800][cleared]*level;score+=pts;lines+=cleared;level=lv+Math.floor(lines/10);showToast(cleared+'x clear! +'+pts);}cur=newPiece();if(!valid(cur.shape,cur.x,cur.y)){gameOver=true;showToast('Game Over! Score: '+score);}}

  function drop(){if(!valid(cur.shape,cur.x,cur.y+1)){lock();}else cur.y++;}
  function hardDrop(){while(valid(cur.shape,cur.x,cur.y+1))cur.y++;lock();}

  function ghostY(){let gy=cur.y;while(valid(cur.shape,cur.x,gy+1))gy++;return gy;}

  function render(){
    const g=document.getElementById('tetG');if(!g)return;
    const W2=COLS*CS,H2=ROWS*CS;
    let html=`<canvas id="tetC" width="${W2}" height="${H2}" style="border:1px solid rgba(255,102,0,.3);border-radius:4px;display:block;"></canvas>`;
    const scores=`<div style="display:flex;flex-direction:column;gap:6px;"><div style="background:var(--card2);padding:6px 10px;border-radius:6px;border:1px solid var(--border);"><div style="font-family:'Orbitron',monospace;font-size:1.2rem;color:var(--orange);">${score}</div><div style="font-size:.6rem;color:#999;">SCORE</div></div><div style="background:var(--card2);padding:6px 10px;border-radius:6px;border:1px solid var(--border);"><div style="font-family:'Orbitron',monospace;font-size:1.2rem;color:var(--orange);">${lines}</div><div style="font-size:.6rem;color:#999;">LINES</div></div><div style="background:var(--card2);padding:6px 10px;border-radius:6px;border:1px solid var(--border);"><div style="font-family:'Orbitron',monospace;font-size:1.2rem;color:var(--orange);">${level}</div><div style="font-size:.6rem;color:#999;">LEVEL</div></div></div>`;
    g.innerHTML=`<div style="display:flex;gap:8px;justify-content:center;align-items:flex-start;">${html}${scores}</div>`;
    const tetC=document.getElementById('tetC');if(!tetC)return;
    const ctx=tetC.getContext('2d');
    ctx.fillStyle='#050510';ctx.fillRect(0,0,W2,H2);
    // Grid
    ctx.strokeStyle='rgba(255,255,255,.05)';ctx.lineWidth=.5;
    for(let r=0;r<ROWS;r++)for(let col=0;col<COLS;col++){ctx.strokeRect(col*CS,r*CS,CS,CS);}
    // Board
    board.forEach((row,r)=>row.forEach((v,col)=>{if(v){ctx.fillStyle=v;ctx.fillRect(col*CS+1,r*CS+1,CS-2,CS-2);ctx.fillStyle='rgba(255,255,255,.2)';ctx.fillRect(col*CS+1,r*CS+1,CS-2,4);}}));
    // Ghost
    if(cur&&!gameOver){const gy=ghostY();cur.shape.forEach((row,r)=>row.forEach((v,col)=>{if(v){ctx.fillStyle='rgba(255,255,255,.1)';ctx.fillRect((cur.x+col)*CS+1,(gy+r)*CS+1,CS-2,CS-2);}}));
    // Current piece
    cur.shape.forEach((row,r)=>row.forEach((v,col)=>{if(v&&cur.y+r>=0){ctx.fillStyle=cur.color;ctx.fillRect((cur.x+col)*CS+1,(cur.y+r)*CS+1,CS-2,CS-2);ctx.fillStyle='rgba(255,255,255,.25)';ctx.fillRect((cur.x+col)*CS+1,(cur.y+r)*CS+1,CS-2,4);}}));}
    if(gameOver){ctx.fillStyle='rgba(0,0,0,.8)';ctx.fillRect(0,0,W2,H2);ctx.fillStyle='#ff6600';ctx.font='bold 16px Orbitron';ctx.textAlign='center';ctx.fillText('GAME OVER',W2/2,H2/2-8);ctx.fillStyle='#fff';ctx.font='12px Exo 2';ctx.fillText('Score: '+score,W2/2,H2/2+14);ctx.textAlign='left';}
    const se=document.getElementById('tetSc');if(se)se.textContent=score;
    if(score>=800*lv&&!gameOver)setTimeout(()=>showWin('Score: '+score+'! Tetris Master!','tetris',()=>openGame('tetris')),300);
  }

  let lastT=0;
  function update(ts){if(!lastT)lastT=ts;dropTimer+=ts-lastT;lastT=ts;if(!gameOver&&cur&&dropTimer>=dropSpeed){drop();render();dropTimer=0;}}

  addListener(document,'keydown',e=>{
    if(!cur||gameOver)return;
    if(e.key==='ArrowLeft'&&valid(cur.shape,cur.x-1,cur.y)){cur.x--;render();}
    if(e.key==='ArrowRight'&&valid(cur.shape,cur.x+1,cur.y)){cur.x++;render();}
    if(e.key==='ArrowDown'){drop();render();}
    if(e.key==='ArrowUp'||e.key==='z'){const r2=rotate(cur.shape);if(valid(r2,cur.x,cur.y)){cur.shape=r2;render();}}
    if(e.key===' '){e.preventDefault();hardDrop();render();}
  });

  c.innerHTML=`
    <div id="tetG" style="overflow-x:auto;max-width:100%;"></div>
    <div style="display:flex;gap:5px;flex-wrap:wrap;justify-content:center;">
      <button class="g-btn" onclick="tetLeft()" style="padding:8px 16px;">‚óÄ</button>
      <button class="g-btn" onclick="tetRot()" style="padding:8px 16px;">‚Ü∫</button>
      <button class="g-btn" onclick="tetDown()" style="padding:8px 16px;">‚ñº</button>
      <button class="g-btn" onclick="tetRight()" style="padding:8px 16px;">‚ñ∂</button>
      <button class="g-btn" onclick="tetHard()" style="padding:8px 16px;">‚¨áDROP</button>
    </div>
    <div class="g-hint">Arrow keys or buttons. ‚Üë/Z = rotate, Space = hard drop!</div>`;
  window.tetLeft=function(){if(cur&&valid(cur.shape,cur.x-1,cur.y)){cur.x--;render();}};
  window.tetRight=function(){if(cur&&valid(cur.shape,cur.x+1,cur.y)){cur.x++;render();}};
  window.tetDown=function(){drop();render();};
  window.tetRot=function(){if(cur){const r2=rotate(cur.shape);if(valid(r2,cur.x,cur.y)){cur.shape=r2;render();}}};
  window.tetHard=function(){hardDrop();render();};
  cur=newPiece();render();
  let rafId;function tick(ts){update(ts);rafId=requestAnimationFrame(tick);}
  rafId=requestAnimationFrame(tick);activeIntervals.push({cancel:()=>cancelAnimationFrame(rafId)});
}

/* ============================================================
   GAME: MEMORY CARDS (FIXED ‚Äî proper sizing)
============================================================ */
function buildMemory(c, lv) {
  lv=lv||1;
  const ALL=['üéÆ','üèÜ','üî•','‚≠ê','üöÄ','üéØ','üíé','üåü','üçÄ','üé™','üêâ','ü¶Å'];
  const pairs=Math.min(4+lv,8),cols=4;
  const deck=[...ALL.slice(0,pairs),...ALL.slice(0,pairs)].sort(()=>Math.random()-.5);
  let cards=deck.map((e,i)=>({id:i,e,rev:false,mat:false}));
  let flip=[],mat=0,moves=0,locked=false,timer=0;
  addInterval(()=>{timer++;const te=document.getElementById('memT');if(te)te.textContent=timer+'s';},1000);

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="memM">0</div><div class="g-score-lbl">Moves</div></div>
      <div class="g-score-item"><div class="g-score-val" id="memP">0/${pairs}</div><div class="g-score-lbl">Pairs</div></div>
      <div class="g-score-item"><div class="g-score-val" id="memT">0s</div><div class="g-score-lbl">Time</div></div>
    </div>
    <div id="memG" style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:7px;max-width:${cols*82}px;width:100%;"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button class="g-btn" onclick="buildMemory(document.getElementById('gc'),${lv})">Restart</button>
      <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="memPeek()">üëÅ Peek 3s</button>
    </div>
    <div class="g-hint">Level ${lv}: ${pairs} pairs. Match them all!</div>`;

  function render(){
    const g=document.getElementById('memG');if(!g)return;
    g.innerHTML=cards.map((cd,i)=>`<div onclick="memFlip(${i})" style="min-height:72px;background:${cd.mat?'rgba(34,197,94,.12)':cd.rev?'rgba(255,102,0,.12)':'var(--card2)'};border:2px solid ${cd.mat?'#22c55e':cd.rev?'var(--orange)':'rgba(255,255,255,.08)'};border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;transition:all .25s;user-select:none;">${cd.rev||cd.mat?cd.e:'?'}</div>`).join('');
    const mm=document.getElementById('memM');if(mm)mm.textContent=moves;const mp=document.getElementById('memP');if(mp)mp.textContent=mat+'/'+pairs;
  }
  window.memFlip=function(i){if(locked||cards[i].rev||cards[i].mat)return;cards[i].rev=true;flip.push(i);render();if(flip.length===2){moves++;locked=true;const[a,b]=flip;if(cards[a].e===cards[b].e){cards[a].mat=cards[b].mat=true;mat++;flip=[];locked=false;render();if(mat===pairs){showToast('üéâ All matched!');setTimeout(()=>showWin(`${pairs} pairs in ${moves} moves, ${timer}s`,'memory',()=>openGame('memory')),400);}}else setTimeout(()=>{cards[a].rev=cards[b].rev=false;flip=[];locked=false;render();},700);}};
  window.memPeek=function(){if(locked)return;locked=true;cards.forEach(cd=>{if(!cd.mat)cd.rev=true;});render();setTimeout(()=>{cards.forEach(cd=>{if(!cd.mat)cd.rev=false;});render();locked=false;},3000);};
  render();
}

/* ============================================================
   NEW: WATER SORT PUZZLE
============================================================ */
function buildWaterSort(c, lv) {
  lv=lv||1;const nC=Math.min(3+lv,8),nT=nC+2,CAP=4;
  const COLORS=['#ef4444','#3b82f6','#22c55e','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316'];
  let tubes=[],sel=null;
  function init(){const pieces=[];for(let ci=0;ci<nC;ci++)for(let i=0;i<CAP;i++)pieces.push(ci);for(let i=pieces.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pieces[i],pieces[j]]=[pieces[j],pieces[i]];}tubes=[];for(let t=0;t<nC;t++)tubes.push(pieces.slice(t*CAP,(t+1)*CAP));for(let i=0;i<2;i++)tubes.push([]);}
  function pour(f,t){if(f===t||!tubes[f].length)return false;const tc=tubes[f][tubes[f].length-1];if(tubes[t].length>=CAP)return false;if(tubes[t].length>0&&tubes[t][tubes[t].length-1]!==tc)return false;let cnt=0;for(let i=tubes[f].length-1;i>=0&&tubes[f][i]===tc;i--)cnt++;const sp=CAP-tubes[t].length,mv=Math.min(cnt,sp);for(let i=0;i<mv;i++)tubes[t].push(tubes[f].pop());return true;}
  function solved(){return tubes.every(t=>!t.length||(t.length===CAP&&t.every(v=>v===t[0])));}
  function render(){const w=document.getElementById('wsW');if(!w)return;const H=120,TW=42;w.innerHTML=tubes.map((t,idx)=>{let segs='';for(let i=CAP-1;i>=0;i--){const cl=t[i]!==undefined?COLORS[t[i]]:'transparent';segs+=`<rect x="4" y="${H-(i+1)*(H/CAP)}" width="${TW-8}" height="${H/CAP-1}" rx="2" fill="${cl}" opacity="${cl==='transparent'?0:.9}"/>`;}const iS=sel===idx;return`<div style="display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;" onclick="wsTap(${idx})"><svg width="${TW}" height="${H+16}" overflow="visible">${iS?`<rect x="-2" y="-4" width="${TW+4}" height="${H+8}" rx="6" fill="rgba(255,102,0,.15)" stroke="var(--orange)" stroke-width="2"/>`:''}${segs}<rect x="0" y="0" width="${TW}" height="${H}" rx="5" fill="none" stroke="${iS?'var(--orange)':'rgba(255,255,255,.25)'}" stroke-width="2"/></svg><div style="font-size:.6rem;color:${iS?'var(--orange)':'#666'};">${idx+1}</div></div>`;}).join('');}
  window.wsTap=function(idx){if(sel===null){if(tubes[idx].length){sel=idx;render();}return;}if(sel===idx){sel=null;render();return;}pour(sel,idx);sel=null;render();if(solved()){showToast('üéâ All sorted!');setTimeout(()=>showWin('All '+nC+' colors sorted!','watersort',()=>openGame('watersort')),400);}};
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val">${nC}</div><div class="g-score-lbl">Colors</div></div><div class="g-score-item"><div class="g-score-val">${nT}</div><div class="g-score-lbl">Tubes</div></div></div><div style="display:flex;gap:9px;flex-wrap:wrap;justify-content:center;" id="wsW"></div><button class="g-btn" onclick="init();sel=null;render();">‚Ü∫ Restart</button><div class="g-hint">Click a tube to select, click another to pour!</div>`;
  init();render();
}



/* ============================================================
   NEW: BRAIN TEST
============================================================ */
function buildBrainTest(c, lv) {
  lv=lv||1;
  const QS=[{q:'Which is larger: 1/3 or 1/4?',opts:['1/3','1/4','Equal','Can\'t tell'],ans:0,exp:'1/3‚âà0.333 > 1/4=0.25!'},{q:'17 sheep, all but 9 die. How many left?',opts:['8','9','17','0'],ans:1,exp:'"All but 9" = 9 remain!'},{q:'You have 3 apples, you take 2. How many do YOU have?',opts:['1','2','3','0'],ans:1,exp:'You TOOK 2, so you have 2!'},{q:'Roosters lay eggs on roof. Which way do they roll?',opts:['Left','Right','Down','Roosters can\'t!'],ans:3,exp:'Roosters are male ‚Äî no eggs!'},{q:'How many months have 28 days?',opts:['1','4','7','All 12'],ans:3,exp:'ALL 12 months have at least 28!'},{q:'What is 2+2√ó2?',opts:['8','6','4','16'],ans:1,exp:'BODMAS: 2+(2√ó2)=6!'},{q:'What has hands but cannot clap?',opts:['Robot','Clock','Puppet','Person'],ans:1,exp:'A clock has hands!'},{q:'I speak without mouth, heard without ears. What am I?',opts:['Ghost','Wind','Echo','River'],ans:2,exp:'An echo!'},{q:'You cannot bury a survivor. Where do you bury them?',opts:['Nowhere','Hometown','Graveyard','They decide'],ans:0,exp:'SURVIVORS ARE ALIVE ‚Äî you don\'t bury them!'},{q:'What gets wetter the more it dries?',opts:['Rain','A towel','Sponge','Ice'],ans:1,exp:'A towel dries you and gets wet!'}];
  let qi=(lv-1)%QS.length,score=0,asked=0;
  function loadQ(){const q=QS[qi];asked++;document.getElementById('gc').innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val">${score}</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val">${qi+1}/${QS.length}</div><div class="g-score-lbl">Q</div></div></div><div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:1.3rem;max-width:440px;width:100%;"><div style="font-size:1rem;font-weight:700;text-align:center;margin-bottom:1rem;line-height:1.5;">${q.q}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="btOpts">${q.opts.map((o,i)=>`<div onclick="btAns(${i})" style="background:var(--card);border:1px solid var(--border);padding:.8rem;border-radius:8px;cursor:pointer;text-align:center;font-weight:600;font-size:.88rem;transition:all .2s;">${o}</div>`).join('')}</div><div id="btExp" style="margin-top:.9rem;font-size:.82rem;color:#aaa;text-align:center;min-height:18px;"></div></div><div class="g-hint">Think carefully ‚Äî these are trick questions!</div>`;
  window.btAns=function(i){const opts=document.querySelectorAll('#btOpts div');opts[q.ans].style.cssText+=';background:rgba(34,197,94,.15);border-color:#22c55e;color:#22c55e;';if(i!==q.ans)opts[i].style.cssText+=';background:rgba(239,68,68,.15);border-color:#ef4444;color:#ef4444;';const exp=document.getElementById('btExp');if(exp)exp.textContent='üí° '+q.exp;if(i===q.ans){score+=10;showToast('‚úÖ Correct! +10');}else showToast('‚ùå Wrong!');setTimeout(()=>{qi=(qi+1)%QS.length;if(score>=80||asked>=QS.length)showWin('Score: '+score+'! Brain Master!','braintest',()=>openGame('braintest'));else loadQ();},1600);};}
  loadQ();
}

/* ============================================================
   NEW: CHESS
============================================================ */
function buildChess(c, lv) {
  lv=lv||1;
  const PC={K:'‚ôî',Q:'‚ôï',R:'‚ôñ',B:'‚ôó',N:'‚ôò',P:'‚ôô',k:'‚ôö',q:'‚ôõ',r:'‚ôú',b:'‚ôù',n:'‚ôû',p:'‚ôü'};
  let bd=[['r','n','b','q','k','b','n','r'],['p','p','p','p','p','p','p','p'],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],['P','P','P','P','P','P','P','P'],['R','N','B','Q','K','B','N','R']];
  let sel=null,mvs=[],turn='white',over=false;
  const isW=p=>p&&p===p.toUpperCase(),isB=p=>p&&p===p.toLowerCase();
  const sameT=(a,b)=>(isW(a)&&isW(b))||(isB(a)&&isB(b)),enemy=(a,b)=>a&&b&&!sameT(a,b);
  function getMvs(r,col){const p=bd[r][col];if(!p)return[];const mv=[],tp=p.toUpperCase(),dir=isW(p)?-1:1;
    if(tp==='P'){const nr=r+dir;if(nr>=0&&nr<8&&!bd[nr][col]){mv.push([nr,col]);if((isW(p)&&r===6||isB(p)&&r===1)&&!bd[r+dir][col]&&!bd[r+dir*2][col])mv.push([r+dir*2,col]);}[-1,1].forEach(dc=>{const nc=col+dc;if(nc>=0&&nc<8&&nr>=0&&nr<8&&bd[nr]&&enemy(p,bd[nr][nc]))mv.push([nr,nc]);});}
    if(tp==='N')[[-2,-1],[-2,1],[2,-1],[2,1],[-1,-2],[1,-2],[-1,2],[1,2]].forEach(([dr,dc])=>{const nr=r+dr,nc=col+dc;if(nr>=0&&nr<8&&nc>=0&&nc<8&&!sameT(p,bd[nr][nc]))mv.push([nr,nc]);});
    if(tp==='K')for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){if(!dr&&!dc)continue;const nr=r+dr,nc=col+dc;if(nr>=0&&nr<8&&nc>=0&&nc<8&&!sameT(p,bd[nr][nc]))mv.push([nr,nc]);}
    function slide(dirs){dirs.forEach(([dr,dc])=>{let nr=r+dr,nc=col+dc;while(nr>=0&&nr<8&&nc>=0&&nc<8){if(bd[nr][nc]){if(enemy(p,bd[nr][nc]))mv.push([nr,nc]);break;}mv.push([nr,nc]);nr+=dr;nc+=dc;}});}
    if(tp==='R')slide([[0,1],[0,-1],[1,0],[-1,0]]);if(tp==='B')slide([[1,1],[1,-1],[-1,1],[-1,-1]]);if(tp==='Q')slide([[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]);return mv;}
  function render(){const b=document.getElementById('chB');if(!b)return;b.innerHTML='';for(let r=0;r<8;r++)for(let col=0;col<8;col++){const sq=document.createElement('div');const SZ=window.innerWidth<480?32:window.innerWidth<768?38:46;sq.style.cssText=`width:${SZ}px;height:${SZ}px;display:flex;align-items:center;justify-content:center;font-size:${SZ*.75}px;cursor:pointer;user-select:none;background:${(r+col)%2===0?'#c8a96e':'#8b5e34'};`;const p=bd[r][col];if(p)sq.textContent=PC[p];if(sel&&sel[0]===r&&sel[1]===col)sq.style.background='rgba(255,102,0,.75)';if(mvs.some(([mr,mc])=>mr===r&&mc===col))sq.style.background=bd[r][col]?'rgba(220,50,50,.55)':'rgba(50,200,100,.4)';sq.onclick=()=>chCl(r,col);b.appendChild(sq);}const st=document.getElementById('chSt');if(st)st.textContent=over?'Game Over':(turn==='white'?'üü° Your turn':'ü§ñ AI thinking...');}
  function doMv(fr,fc,tr,tc,side){const p=bd[fr][fc],cap=bd[tr][tc];bd[tr][tc]=p;bd[fr][fc]=null;if(p==='P'&&tr===0)bd[tr][tc]='Q';if(p==='p'&&tr===7)bd[tr][tc]='q';if(cap&&cap.toLowerCase()==='k'){over=true;showToast(side==='white'?'üéâ You Win!':'ü§ñ AI Wins!');if(side==='white')setTimeout(()=>showWin('You captured the King!','chess',()=>openGame('chess')),500);}turn=turn==='white'?'black':'white';}
  function ai(){const all=[];for(let r=0;r<8;r++)for(let col=0;col<8;col++)if(bd[r][col]&&isB(bd[r][col]))getMvs(r,col).forEach(([mr,mc])=>all.push({fr:r,fc:col,tr:mr,tc:mc}));if(!all.length){over=true;showToast('Stalemate!');return;}const VALS={P:1,N:3,B:3,R:5,Q:9,K:100};const sc2=all.map(m=>({...m,s:(bd[m.tr][m.tc]?VALS[bd[m.tr][m.tc].toUpperCase()]||0:0)+Math.random()*.5}));sc2.sort((a,bb)=>bb.s-a.s);let chosen;if(lv<=2&&Math.random()<.45)chosen=all[Math.floor(Math.random()*all.length)];else chosen=sc2[0];doMv(chosen.fr,chosen.fc,chosen.tr,chosen.tc,'black');sel=null;mvs=[];render();}
  window.chCl=function(r,col){if(over||turn!=='white')return;if(sel){const mv=mvs.find(([mr,mc])=>mr===r&&mc===col);if(mv){doMv(sel[0],sel[1],r,col,'white');sel=null;mvs=[];render();if(!over)setTimeout(ai,300+lv*50);return;}}const p=bd[r][col];if(p&&isW(p)){sel=[r,col];mvs=getMvs(r,col);render();}else{sel=null;mvs=[];render();}};
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item" style="flex:1;"><div class="g-score-val" id="chSt" style="font-size:.85rem;">Your Turn (White)</div></div></div><div style="display:grid;grid-template-columns:repeat(8,1fr);border:2px solid var(--orange);border-radius:4px;overflow:hidden;width:fit-content;max-width:100%;" id="chB"></div><button class="g-btn" onclick="buildChess(document.getElementById('gc'),${lv})">New Game</button><div class="g-hint">Click a piece then click destination. AI Level: ${lv}</div>`;
  render();
}

/* ============================================================
   NEW: GOODS PUZZLE
============================================================ */
function buildGoods(c, lv) {
  lv=lv||1;
  const SETS=[{cats:['üçé Fruit','ü•ï Veggie','üçï Fast Food'],items:[{e:'üçé',c:0},{e:'üçä',c:0},{e:'üçá',c:0},{e:'üçå',c:0},{e:'ü•ï',c:1},{e:'ü•¶',c:1},{e:'üßÖ',c:1},{e:'üåΩ',c:1},{e:'üçï',c:2},{e:'üçî',c:2},{e:'üçü',c:2},{e:'üåÆ',c:2}]},{cats:['üöÄ Space','üåä Ocean','üåø Nature'],items:[{e:'‚≠ê',c:0},{e:'üõ∏',c:0},{e:'üåô',c:0},{e:'‚òÑÔ∏è',c:0},{e:'üê†',c:1},{e:'ü¶ë',c:1},{e:'üêã',c:1},{e:'ü¶à',c:1},{e:'üå≥',c:2},{e:'üå∫',c:2},{e:'üçÄ',c:2},{e:'ü¶ã',c:2}]},{cats:['üéµ Music','‚öΩ Sports','üé® Art'],items:[{e:'üé∏',c:0},{e:'üéπ',c:0},{e:'ü•Å',c:0},{e:'üéª',c:0},{e:'‚öΩ',c:1},{e:'üèÄ',c:1},{e:'üéæ',c:1},{e:'üèÜ',c:1},{e:'üñåÔ∏è',c:2},{e:'‚úèÔ∏è',c:2},{e:'üñºÔ∏è',c:2},{e:'üé≠',c:2}]}];
  const ds=SETS[(lv-1)%3];let items=ds.items.map((x,i)=>({...x,id:i,placed:false})).sort(()=>Math.random()-.5);let bins=ds.cats.map(()=>[]),drag=null,score=0;
  function render(){const g=document.getElementById('gc');if(!g)return;g.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val">${score}</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val">${items.filter(x=>x.placed).length}/${items.length}</div><div class="g-score-lbl">Sorted</div></div></div><div style="display:flex;gap:7px;flex-wrap:wrap;justify-content:center;margin-bottom:1rem;">${items.filter(x=>!x.placed).map(x=>`<div onclick="gpD(${x.id})" style="width:50px;height:50px;background:var(--card2);border:2px solid ${drag===x.id?'var(--orange)':'var(--border)'};border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.7rem;cursor:pointer;">${x.e}</div>`).join('')}</div><div style="display:flex;gap:9px;flex-wrap:wrap;justify-content:center;">${ds.cats.map((cat,i)=>`<div onclick="gpDp(${i})" style="min-width:110px;min-height:80px;background:rgba(255,102,0,.05);border:2px dashed rgba(255,102,0,.3);border-radius:9px;padding:8px;text-align:center;cursor:pointer;"><div style="font-weight:700;font-size:.82rem;margin-bottom:5px;">${cat}</div><div style="display:flex;flex-wrap:wrap;gap:3px;justify-content:center;">${bins[i].map(x=>`<span style="font-size:1.3rem;">${x.e}</span>`).join('')}</div></div>`).join('')}</div><button class="g-btn" onclick="buildGoods(document.getElementById('gc'),${lv})">‚Ü∫ Restart</button><div class="g-hint">Click item ‚Üí click category!</div>`;}
  window.gpD=function(id){drag=id;showToast('Now click a category!');render();};
  window.gpDp=function(bin){if(drag===null)return;const it=items.find(x=>x.id===drag);if(!it||it.placed)return;if(it.c===bin){it.placed=true;bins[bin].push(it);score+=10;showToast('‚úÖ +10');if(items.every(x=>x.placed))setTimeout(()=>showWin('All sorted!','goodspuzzle',()=>openGame('goodspuzzle')),400);}else{score=Math.max(0,score-5);showToast('‚ùå Wrong! -5');}drag=null;render();};
  render();
}

/* ============================================================
   NEW: FRUIT NINJA
============================================================ */
function buildFruitNinja(c, lv) {
  lv=lv||1;const W=500,H=380;
  const FRUITS=['üçâ','üçä','üçá','üçì','üçç'];
  let fruits=[],slices=[],parts=[],score=0,lives=3,running=false,spawnT=0;
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="fnSc">0</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val" id="fnLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="g-score-lbl">Lives</div></div></div><canvas id="fnC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;touch-action:none;"></canvas><div class="g-hint">Move mouse/finger over fruits to slice! Avoid üí£ bombs!</div><button class="g-btn" id="fnBtn" onclick="fnSt()">üçâ Start!</button>`;
  const cv=document.getElementById('fnC'),ctx=cv.getContext('2d');
  let lx=0,ly=0;
  function fnSlice(x,y){if(!running)return;slices.push({x1:lx,y1:ly,x2:x,y2:y,life:1});fruits.forEach(f=>{if(f.sliced)return;if(Math.hypot(x-f.x,y-f.y)<f.r+12){f.sliced=true;if(f.isBomb){running=false;showToast('üí£ Bomb! Game Over!');return;}score+=f.pts;const se=document.getElementById('fnSc');if(se)se.textContent=score;for(let i=0;i<6;i++)parts.push({x:f.x,y:f.y,e:f.e,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7-2,life:1});showToast('+'+f.pts+' '+f.e);if(score>=300*lv){running=false;setTimeout(()=>showWin('Score: '+score+'! Ninja!','frutninja',()=>openGame('frutninja')),300);}}});lx=x;ly=y;}
  function draw(){const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#080808');bg.addColorStop(1,'#0f0505');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);slices.forEach(s=>{ctx.save();ctx.globalAlpha=s.life;ctx.strokeStyle=`rgba(255,200,100,${s.life})`;ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(s.x1,s.y1);ctx.lineTo(s.x2,s.y2);ctx.stroke();ctx.restore();});fruits.filter(f=>!f.sliced).forEach(f=>{ctx.font=(f.r*1.5)+'px serif';ctx.textAlign='center';ctx.fillText(f.e,f.x,f.y);});parts.forEach(p=>{ctx.save();ctx.globalAlpha=p.life;ctx.font='20px serif';ctx.textAlign='center';ctx.fillText(p.e,p.x,p.y);ctx.restore();});if(!running&&score>0){ctx.fillStyle='rgba(0,0,0,.82)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 26px Orbitron';ctx.textAlign='center';ctx.fillText('GAME OVER',W/2,H/2-12);ctx.fillStyle='#fff';ctx.font='16px Exo 2';ctx.fillText('Score: '+score,W/2,H/2+18);ctx.textAlign='left';}}
  function update(){if(!running)return;spawnT++;if(spawnT>Math.max(25,55-lv*8)){fruits.push({x:60+Math.random()*(W-120),y:H+30,vx:(Math.random()-.5)*5,vy:-(10+Math.random()*5+lv),e:Math.random()<.1+lv*.02?'üí£':FRUITS[Math.floor(Math.random()*5)],r:26,isBomb:Math.random()<.1+lv*.02,pts:Math.ceil(Math.random()*3)*10});fruits[fruits.length-1].isBomb=fruits[fruits.length-1].e==='üí£';spawnT=0;}fruits.forEach(f=>{f.x+=f.vx;f.y+=f.vy;f.vy+=.25;});fruits.forEach(f=>{if(!f.sliced&&f.y>H+40&&!f.isBomb){lives=Math.max(0,lives-1);const le=document.getElementById('fnLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(lives);if(lives<=0)running=false;}});fruits=fruits.filter(f=>f.y<H+60&&!f.sliced);slices.forEach(s=>s.life-=.06);slices=slices.filter(s=>s.life>0);parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=.03;});parts=parts.filter(p=>p.life>0);draw();}
  addListener(cv,'mousemove',e=>{const r=cv.getBoundingClientRect();fnSlice(e.clientX-r.left,e.clientY-r.top);});
  addListener(cv,'mousedown',e=>{const r=cv.getBoundingClientRect();lx=e.clientX-r.left;ly=e.clientY-r.top;});
  addListener(cv,'touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();fnSlice(e.touches[0].clientX-r.left,e.touches[0].clientY-r.top);},{passive:false});
  addListener(cv,'touchstart',e=>{e.preventDefault();const r=cv.getBoundingClientRect();lx=e.touches[0].clientX-r.left;ly=e.touches[0].clientY-r.top;},{passive:false});
  window.fnSt=function(){score=0;lives=3;fruits=[];slices=[];parts=[];spawnT=0;running=true;lx=0;ly=0;const se=document.getElementById('fnSc');if(se)se.textContent=0;const le=document.getElementById('fnLv');if(le)le.textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';const btn=document.getElementById('fnBtn');if(btn)btn.textContent='Restart';};
  draw();startLoop(update);
}

/* ============================================================
   NEW: MOB CONTROL
============================================================ */
function buildMobControl(c, lv) {
  lv=lv||1;const W=400,H=500;
  let soldiers=20+lv*5,gates=[],enemies=[],stage=0,score=0,running=false,px=W/2,frame2=0;
  function genStage(){gates=[];enemies=[];const ng=4+lv;for(let i=0;i<ng;i++){const y=60+i*70;const isL=Math.random()<.5;const types=['+5','+10','√ó2','√ó3','-5','+20'];const ops=[v=>v+5,v=>v+10,v=>v*2,v=>v*3,v=>Math.max(1,v-5),v=>v+20];const idx=Math.floor(Math.random()*types.length);const good=!types[idx].startsWith('-');gates.push({x:isL?80:250,y,label:types[idx],op:ops[idx],passed:false,good,w:80,h:34});}const ne=2+Math.floor(lv/2);for(let i=0;i<ne;i++)enemies.push({x:50+Math.random()*(W-100),y:H-100+i*8,count:5+(i+stage)*lv*2,beaten:false});}
  function draw(ctx){const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#050518');bg.addColorStop(1,'#051805');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);gates.filter(g=>!g.passed).forEach(g=>{ctx.fillStyle=g.good?'rgba(34,197,94,.8)':'rgba(239,68,68,.8)';ctx.beginPath();ctx.roundRect(g.x,g.y,g.w,g.h,6);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 15px Orbitron';ctx.textAlign='center';ctx.fillText(g.label,g.x+g.w/2,g.y+g.h/2+5);});enemies.filter(e=>!e.beaten).forEach(e=>{ctx.fillStyle='rgba(239,68,68,.9)';ctx.beginPath();ctx.roundRect(e.x-32,e.y-20,64,30,6);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 12px Exo 2';ctx.textAlign='center';ctx.fillText('üòà√ó'+e.count,e.x,e.y);});ctx.font='18px serif';ctx.textAlign='center';for(let i=0;i<Math.min(soldiers,20);i++)ctx.fillText('üßë',px-18+(i%10)*3.6,H-55-(Math.floor(i/10)*18));ctx.fillStyle='#fff';ctx.font='bold 13px Exo 2';ctx.fillText(soldiers+' soldiers',px,H-22);ctx.fillStyle='var(--orange)';ctx.font='22px serif';ctx.fillText('‚¨ÜÔ∏è',px,H-72);ctx.textAlign='left';if(!running&&score>0){ctx.fillStyle='rgba(0,0,0,.8)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 22px Orbitron';ctx.textAlign='center';ctx.fillText(soldiers>0?'Victory! üéâ':'Defeated! üíÄ',W/2,H/2-10);ctx.fillStyle='#fff';ctx.font='14px Exo 2';ctx.fillText('Score: '+score,W/2,H/2+20);ctx.textAlign='left';}}
  function update(ctx){if(!running)return;frame2++;const spd=1.5+lv*.3;const py=H-frame2*spd;gates.filter(g=>!g.passed).forEach(g=>{if(px>g.x-15&&px<g.x+g.w+15&&py<g.y+g.h&&py>g.y){soldiers=Math.max(1,g.op(soldiers));g.passed=true;showToast(g.label+'! ‚Üí '+soldiers);}});enemies.filter(e=>!e.beaten).forEach(e=>{if(Math.abs(px-e.x)<40&&py<e.y+20&&py>e.y-50){if(soldiers>=e.count){score+=e.count*10;e.beaten=true;soldiers=Math.max(1,soldiers-Math.floor(e.count/2));showToast('‚öîÔ∏è Won! +'+e.count*10);}else{soldiers=0;running=false;showToast('üòà Defeated!');}e.beaten=true;}});if(py<0){running=false;if(soldiers>0){score+=soldiers*5;showToast('Stage '+(stage+1)+' clear! +'+soldiers*5);stage++;if(stage>=3)setTimeout(()=>showWin('Score: '+score+'! All stages!','mobcontrol',()=>openGame('mobcontrol')),400);else{soldiers=Math.min(soldiers+10,99);frame2=0;genStage();running=true;}}}draw(ctx);}
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="mcSc">0</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val" id="mcSg">1/3</div><div class="g-score-lbl">Stage</div></div></div><canvas id="mcC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;"></canvas><div class="g-hint">Move left-right to guide soldiers through gates!</div><button class="g-btn" id="mcBtn" onclick="mcSt()">üßë Start!</button>`;
  const cv=document.getElementById('mcC'),ctx=cv.getContext('2d');
  addListener(cv,'mousemove',e=>{const r=cv.getBoundingClientRect();px=e.clientX-r.left;});
  addListener(cv,'touchmove',e=>{e.preventDefault();const r=cv.getBoundingClientRect();px=e.touches[0].clientX-r.left;},{passive:false});
  window.mcSt=function(){soldiers=20+lv*5;score=0;stage=0;frame2=0;px=W/2;running=true;genStage();const se=document.getElementById('mcSc');if(se)se.textContent=0;};
  genStage();draw(ctx);startLoop(()=>{update(ctx);const se=document.getElementById('mcSc');if(se)se.textContent=score;const sg=document.getElementById('mcSg');if(sg)sg.textContent=(stage+1)+'/3';});
}

/* ============================================================
   NEW: CROSSY ROAD
============================================================ */
function buildCrossy(c, lv) {
  lv=lv||1;const W=400,H=480,ROWS=10,RH=H/ROWS;
  let frog={x:W/2,y:H-RH/2},cars=[],score=0,running=false;
  const SAFE=[0,1,ROWS-1];
  function initCars(){cars=[];for(let row=2;row<ROWS-1;row++){if(SAFE.includes(row))continue;const dir=row%2===0?1:-1,spd=(1+Math.random()*2+lv*.3)*dir;const nc=2+Math.floor(Math.random()*2);for(let i=0;i<nc;i++)cars.push({x:(i/nc)*W*1.5,y:row*RH+RH/2,vx:spd,w:48,h:26,row,e:dir>0?'üöó':'üöô'});}}
  function draw(ctx){for(let row=0;row<ROWS;row++){ctx.fillStyle=SAFE.includes(row)?(row===0?'rgba(34,197,94,.4)':'rgba(30,100,30,.3)'):'rgba(25,25,35,.8)';ctx.fillRect(0,row*RH,W,RH);if(!SAFE.includes(row)){ctx.fillStyle='rgba(255,255,255,.06)';ctx.fillRect(0,row*RH+RH/2-1,W,2);}}ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='11px Exo 2';ctx.fillText('üèÅ GOAL',6,14);cars.forEach(car=>{ctx.font=car.h+'px serif';ctx.textAlign='center';ctx.fillText(car.e,car.x,car.y+car.h/2);});ctx.font='32px serif';ctx.textAlign='center';ctx.fillText('üê∏',frog.x,frog.y+12);if(!running&&score>0){ctx.fillStyle='rgba(0,0,0,.8)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 22px Orbitron';ctx.textAlign='center';ctx.fillText('üíÄ Squished!',W/2,H/2-10);ctx.fillStyle='#fff';ctx.font='14px Exo 2';ctx.fillText('Score: '+score,W/2,H/2+20);}ctx.textAlign='left';}
  function update(ctx){if(!running)return;cars.forEach(car=>{car.x+=car.vx;if(car.vx>0&&car.x>W+40)car.x=-40;if(car.vx<0&&car.x<-40)car.x=W+40;});const row=Math.floor(frog.y/RH);if(!SAFE.includes(row))cars.forEach(car=>{if(Math.abs(car.x-frog.x)<28&&Math.abs(car.y-frog.y)<18){running=false;showToast('üíÄ Squished! Score:'+score);}});if(frog.y<RH){score+=50;showToast('üéâ Made it! +50');frog={x:W/2,y:H-RH/2};const se=document.getElementById('crSc');if(se)se.textContent=score;if(score>=200*lv)setTimeout(()=>showWin('Score: '+score+'! Road Hopper!','crossyroad',()=>openGame('crossyroad')),400);}draw(ctx);}
  function hop(dx,dy){if(!running)return;frog.x=Math.max(20,Math.min(W-20,frog.x+dx*40));frog.y=Math.max(RH/2,Math.min(H-RH/2,frog.y+dy*RH));if(dy<0){score+=10;const se=document.getElementById('crSc');if(se)se.textContent=score;}}
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="crSc">0</div><div class="g-score-lbl">Score</div></div></div><canvas id="crC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;"></canvas><div style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap;"><button class="g-btn" onclick="crH(-1,0)" style="padding:8px 20px;">‚óÄ</button><div style="display:flex;flex-direction:column;gap:4px;"><button class="g-btn" onclick="crH(0,-1)" style="padding:8px 20px;">‚ñ≤</button><button class="g-btn" onclick="crH(0,1)" style="padding:8px 20px;">‚ñº</button></div><button class="g-btn" onclick="crH(1,0)" style="padding:8px 20px;">‚ñ∂</button></div><button class="g-btn" id="crBtn" onclick="crSt()">üê∏ Start!</button><div class="g-hint">Arrow keys or tap buttons. Hop across all lanes!</div>`;
  const cv=document.getElementById('crC'),ctx=cv.getContext('2d');
  addListener(document,'keydown',e=>{const m={ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],ArrowDown:[0,1]};if(m[e.key]){e.preventDefault();hop(...m[e.key]);}});
  window.crH=hop;window.crSt=function(){frog={x:W/2,y:H-RH/2};score=0;running=true;initCars();const se=document.getElementById('crSc');if(se)se.textContent=0;};
  initCars();draw(ctx);startLoop(()=>update(ctx));
}



/* ============================================================
   NEW: COLORING GAME
============================================================ */
function buildColorBook(c, lv) {
  lv=lv||1;
  const PAL=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#ffffff','#f59e0b'];
  let selColor=PAL[0],score=0;
  const shapes=[{type:'sun',cx:200,cy:95,r:42,color:null,pts:20},{type:'cloud',cx:75,cy:52,r:26,color:null,pts:15},{type:'cloud2',cx:330,cy:52,r:26,color:null,pts:15},{type:'tree',cx:85,cy:225,r:36,color:null,pts:20},{type:'tree2',cx:315,cy:225,r:36,color:null,pts:20},{type:'house',cx:200,cy:235,color:null,pts:30},{type:'grass',color:null,pts:10}];
  function render(){const cv=document.getElementById('cbC');if(!cv)return;const ctx=cv.getContext('2d');ctx.fillStyle='#87ceeb';ctx.fillRect(0,0,400,310);shapes.forEach(s=>{const cl=s.color||'rgba(200,200,200,.15)';ctx.fillStyle=cl;ctx.strokeStyle='rgba(50,50,50,.4)';ctx.lineWidth=2;if(s.type==='sun'){ctx.beginPath();ctx.arc(s.cx,s.cy,s.r,0,Math.PI*2);ctx.fill();ctx.stroke();}else if(s.type.startsWith('cloud')){ctx.beginPath();ctx.arc(s.cx,s.cy,s.r,0,Math.PI*2);ctx.arc(s.cx+s.r,s.cy,s.r*.7,0,Math.PI*2);ctx.arc(s.cx-s.r*.6,s.cy,s.r*.6,0,Math.PI*2);ctx.fill();ctx.stroke();}else if(s.type.startsWith('tree')){ctx.beginPath();ctx.arc(s.cx,s.cy-15,s.r*.75,0,Math.PI*2);ctx.fill();ctx.stroke();ctx.fillStyle=s.color?'#8b4513':'rgba(120,80,40,.15)';ctx.fillRect(s.cx-6,s.cy+8,12,38);ctx.strokeRect(s.cx-6,s.cy+8,12,38);}else if(s.type==='house'){ctx.fillStyle=s.color||'rgba(200,200,200,.15)';ctx.fillRect(s.cx-48,s.cy-18,96,52);ctx.strokeRect(s.cx-48,s.cy-18,96,52);ctx.fillStyle=s.color?'#c0392b':'rgba(180,80,60,.15)';ctx.beginPath();ctx.moveTo(s.cx-58,s.cy-18);ctx.lineTo(s.cx,s.cy-64);ctx.lineTo(s.cx+58,s.cy-18);ctx.closePath();ctx.fill();ctx.stroke();}else if(s.type==='grass'){ctx.fillStyle=s.color||'rgba(100,180,80,.15)';ctx.fillRect(0,278,400,35);}});const pd=document.getElementById('cbPal');if(!pd)return;pd.innerHTML=PAL.map(col=>`<div onclick="cbPk('${col}')" style="width:30px;height:30px;background:${col};border-radius:50%;cursor:pointer;border:3px solid ${col===selColor?'#fff':'transparent'};box-shadow:${col===selColor?'0 0 8px rgba(255,255,255,.6)':'none'};transition:all .15s;flex-shrink:0;"></div>`).join('');const sc2=document.getElementById('cbSc');if(sc2)sc2.textContent=score;if(shapes.every(s=>s.color))setTimeout(()=>showWin('Beautiful! Score: '+score,'colorbook',()=>openGame('colorbook')),300);}
  window.cbPk=function(col){selColor=col;render();};
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="cbSc">0</div><div class="g-score-lbl">Score</div></div></div><canvas id="cbC" class="g-canvas" width="400" height="310" style="cursor:pointer;"></canvas><div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;" id="cbPal"></div><div class="g-hint">Pick a color then click any area to fill it!</div>`;
  const cv=document.getElementById('cbC');
  addListener(cv,'click',e=>{const r=cv.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;shapes.forEach(s=>{let hit=false;if(s.type==='sun'){const dx=mx-s.cx,dy=my-s.cy;if(Math.sqrt(dx*dx+dy*dy)<s.r+8)hit=true;}else if(s.type.startsWith('cloud')){const dx=mx-s.cx,dy=my-s.cy;if(Math.sqrt(dx*dx+dy*dy)<s.r*1.8)hit=true;}else if(s.type.startsWith('tree')){const dx=mx-s.cx,dy=my-s.cy;if(Math.sqrt(dx*dx+dy*dy)<s.r||Math.abs(mx-s.cx)<8)hit=true;}else if(s.type==='house'){if(mx>s.cx-62&&mx<s.cx+62&&my>s.cy-70&&my<s.cy+38)hit=true;}else if(s.type==='grass'){if(my>274)hit=true;}if(hit&&!s.color){s.color=selColor;score+=s.pts;showToast('+'+s.pts+'!');}});render();});
  addListener(cv,'touchstart',e=>{e.preventDefault();const r=cv.getBoundingClientRect();cv.dispatchEvent(new MouseEvent('click',{clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}));},{passive:false});
  render();
}



/* ============================================================
   NEW: CITY BUILDER
============================================================ */
function buildTownship(c, lv) {
  lv=lv||1;
  const BLDGS=[{e:'üè†',n:'House',cost:10,inc:1},{e:'üè¨',n:'Shop',cost:25,inc:3},{e:'üå≥',n:'Park',cost:15,inc:1},{e:'üè≠',n:'Factory',cost:50,inc:7},{e:'‚õΩ',n:'Station',cost:30,inc:4},{e:'üè´',n:'School',cost:40,inc:5},{e:'üè•',n:'Hospital',cost:60,inc:8},{e:'üé≠',n:'Theater',cost:80,inc:12}];
  let coins=100+lv*20,income=0,grid=Array(25).fill(null),sel=null;
  function render(){const cEl=document.getElementById('twCo');if(cEl)cEl.textContent=coins;const iEl=document.getElementById('twIn');if(iEl)iEl.textContent='+'+income+'/s';const bEl=document.getElementById('twBl');if(bEl)bEl.textContent=grid.filter(Boolean).length;const gEl=document.getElementById('twGrid');if(gEl)gEl.innerHTML=grid.map((cell,i)=>`<div onclick="twPl(${i})" style="width:58px;height:58px;background:${cell?'rgba(34,197,94,.1)':'rgba(255,255,255,.03)'};border:1px solid ${cell?'rgba(34,197,94,.2)':'rgba(255,255,255,.06)'};border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:${cell?'1.8rem':'.9rem'};cursor:pointer;">${cell||'+'}</div>`).join('');const shEl=document.getElementById('twShop');if(shEl)shEl.innerHTML=BLDGS.map((b,i)=>`<div onclick="twSl(${i})" style="background:${sel===i?'rgba(255,102,0,.15)':'var(--card2)'};border:1px solid ${sel===i?'var(--orange)':'var(--border)'};border-radius:8px;padding:6px 10px;cursor:pointer;text-align:center;min-width:70px;"><div style="font-size:1.4rem;">${b.e}</div><div style="font-size:.62rem;font-weight:700;">${b.n}</div><div style="font-size:.62rem;color:${coins>=b.cost?'#22c55e':'#ef4444'};">üí∞${b.cost}</div></div>`).join('');}
  window.twSl=function(i){sel=sel===i?null:i;render();};
  window.twPl=function(i){if(grid[i]||sel===null)return;const b=BLDGS[sel];if(coins<b.cost){showToast('Not enough coins!');return;}coins-=b.cost;grid[i]=b.e;income+=b.inc;sel=null;showToast(b.e+' built! +'+b.inc+'/s');render();};
  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="twCo">${coins}</div><div class="g-score-lbl">Coinsü™ô</div></div><div class="g-score-item"><div class="g-score-val" id="twIn">+0/s</div><div class="g-score-lbl">Income</div></div><div class="g-score-item"><div class="g-score-val" id="twBl">0</div><div class="g-score-lbl">Buildings</div></div></div><div style="display:grid;grid-template-columns:repeat(5,58px);gap:5px;margin-bottom:.8rem;background:rgba(34,197,94,.05);border:1px solid rgba(34,197,94,.12);border-radius:9px;padding:8px;" id="twGrid"></div><div style="font-size:.78rem;color:#aaa;margin-bottom:.4rem;text-align:center;">Select building to buy:</div><div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;" id="twShop"></div><div class="g-hint">Earn 1000 coins to win! Income auto-earns every second.</div>`;
  addInterval(()=>{coins+=income;const ce=document.getElementById('twCo');if(ce)ce.textContent=coins;if(coins>=1000&&income>0)setTimeout(()=>showWin('City built! '+grid.filter(Boolean).length+' buildings!','township',()=>openGame('township')),300);},1000);
  render();
}

/* ============================================================
   NEW: STORY MATCH
============================================================ */
function buildStoryMatch(c, lv) {
  lv=lv||1;
  const QS=[{q:'The Princess was locked in a tower. Who rescued her?',opts:['Dragon','Knight','Witch','Wizard'],ans:1,exp:'A brave knight saved the princess!'},{q:'Jack climbed the beanstalk. What did he steal?',opts:['A sword','Golden eggs ü•ö','A harp','Magic lamp'],ans:1,exp:'Jack stole the goose that laid golden eggs!'},{q:'Three Little Pigs: which house survived the Big Bad Wolf?',opts:['Straw','Wood','Brick üß±','Mud'],ans:2,exp:'Only the brick house was wolf-proof!'},{q:'At midnight Cinderella\'s coach became...',opts:['Apple','Pumpkin üéÉ','Carrot','Potato'],ans:1,exp:'It was originally a pumpkin!'},{q:'Snow White bit a poisoned apple from...',opts:['The witch','Huntsman','Evil Queen','Mirror'],ans:2,exp:'The Evil Queen in disguise!'},{q:'Hansel & Gretel found a house made of...',opts:['Gold','Candy üç¨','Wood','Ice'],ans:1,exp:'A delicious candy house!'},{q:'Rapunzel let her hair down for...',opts:['A princess','A thief','A prince','A knight'],ans:2,exp:'The prince climbed her long golden hair!'},{q:'In Sleeping Beauty, the spell was broken by...',opts:['True love\'s kiss üíã','A magic sword','Water','A song'],ans:0,exp:'True love\'s kiss broke the curse!'}];
  let qi=(lv-1)%QS.length,score=0,asked=0;
  function loadQ(){const q=QS[qi];asked++;document.getElementById('gc').innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val">${score}</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val">${qi+1}/${QS.length}</div><div class="g-score-lbl">Story</div></div></div><div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:1.3rem;max-width:440px;width:100%;"><div style="font-size:1.8rem;text-align:center;margin-bottom:.6rem;">üìñ</div><div style="font-size:.98rem;font-weight:700;text-align:center;margin-bottom:1rem;line-height:1.5;">${q.q}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="smOpts">${q.opts.map((o,i)=>`<div onclick="smAns(${i})" style="background:var(--card);border:1px solid var(--border);padding:.8rem;border-radius:8px;cursor:pointer;text-align:center;font-weight:600;font-size:.88rem;transition:all .2s;">${o}</div>`).join('')}</div><div id="smExp" style="margin-top:.9rem;font-size:.82rem;color:#aaa;text-align:center;min-height:18px;"></div></div>`;
  window.smAns=function(i){const opts=document.querySelectorAll('#smOpts div');opts[q.ans].style.cssText+=';background:rgba(34,197,94,.15);border-color:#22c55e;color:#22c55e;';if(i!==q.ans)opts[i].style.cssText+=';background:rgba(239,68,68,.15);border-color:#ef4444;color:#ef4444;';const exp=document.getElementById('smExp');if(exp)exp.textContent='üí° '+q.exp;if(i===q.ans){score+=10;showToast('‚úÖ +10!');}else showToast('‚ùå Wrong!');setTimeout(()=>{qi=(qi+1)%QS.length;if(score>=60||asked>=QS.length)showWin('Score: '+score+'! Story Master!','storymatch',()=>openGame('storymatch'));else loadQ();},1600);};}
  loadQ();
}


/* ==============================================================
   GAME RATING SYSTEM
============================================================== */
const gameRatings = {};
function showRating(id) {
  const modal = document.getElementById('ratingModal');
  if (!modal) return;
  const saved = gameRatings[id] || 0;
  modal.innerHTML = `<div style="position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)this.remove()">
    <div style="background:#161616;border:1px solid rgba(255,102,0,.3);border-radius:16px;padding:1.5rem;text-align:center;max-width:340px;width:90%;">
      <div style="font-size:2rem;margin-bottom:.5rem;">${GAMES.find(g=>g.id===id)?.icon||'üéÆ'}</div>
      <div style="font-family:'Orbitron',monospace;font-weight:700;font-size:1rem;margin-bottom:1rem;">${GAMES.find(g=>g.id===id)?.name||'Game'}</div>
      <div style="font-size:.85rem;color:#999;margin-bottom:.8rem;">Rate this game:</div>
      <div style="display:flex;gap:8px;justify-content:center;font-size:2.2rem;margin-bottom:1rem;" id="starRow">
        ${[1,2,3,4,5].map(s=>`<span onclick="setRating('${id}',${s})" style="cursor:pointer;filter:${saved>=s?'none':'grayscale(1)'};transition:all .15s;">${saved>=s?'‚≠ê':'‚òÜ'}</span>`).join('')}
      </div>
      ${saved?`<div style="color:var(--orange);font-size:.85rem;margin-bottom:.8rem;">Your rating: ${saved}/5 ‚≠ê</div>`:''}
      <button onclick="this.closest('[onclick]').remove()" style="background:linear-gradient(135deg,#ff6600,#ff8833);color:#fff;border:none;padding:8px 20px;border-radius:8px;font-family:Orbitron,monospace;font-size:.8rem;cursor:pointer;">Close</button>
    </div>
  </div>`;
  modal.firstElementChild && document.body.appendChild(modal.firstElementChild);
  modal.innerHTML = '';
}
function setRating(id, stars) {
  gameRatings[id] = stars;
  showToast('‚≠ê'.repeat(stars) + ' Rated '+stars+'/5!');
  playTone(800+stars*100, 0.1, 'sine', 0.25);
}
// Add rating helper element
const ratingModal = document.createElement('div');
ratingModal.id = 'ratingModal';
document.body.appendChild(ratingModal);

/* ==============================================================
   FIXED: TIC TAC TOE ‚Äî Auto restart, win counter, no double touch
============================================================== */
function buildTTT(c, lv) {
  let board = Array(9).fill('');
  let scores = {X:0, O:0, D:0};
  let gameOver = false, processing = false;

  c.innerHTML = `
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="tX">0</div><div class="g-score-lbl">You X</div></div>
      <div class="g-score-item"><div class="g-score-val" id="tD">0</div><div class="g-score-lbl">Draw</div></div>
      <div class="g-score-item"><div class="g-score-val" id="tO">0</div><div class="g-score-lbl">CPU O</div></div>
    </div>
    <div class="g-status" id="tStatus">Your turn! Tap a cell</div>
    <div class="ttt-board" id="tBoard"></div>
    <button class="g-btn" onclick="tttReset()">New Game</button>
    <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('tictactoe')">‚≠ê Rate</button>
    <div class="g-hint">Win 3 in a row! Auto-restarts after each round.</div>`;

  function renderBoard() {
    document.getElementById('tBoard').innerHTML = board.map((v,i) =>
      `<div class="ttt-cell${v?' taken '+v:''}" id="tc${i}">${v}</div>`).join('');
    document.querySelectorAll('.ttt-cell').forEach((cell, i) => {
      cell.addEventListener('touchstart', e => { e.preventDefault(); tttClick(i); }, {passive:false});
      cell.addEventListener('click', () => tttClick(i));
    });
  }

  const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  function checkWin(b, p) { return WINS.find(w => w.every(i => b[i] === p)) || null; }

  function minimax(b, depth, isMax, a, be) {
    const xW = checkWin(b,'X'), oW = checkWin(b,'O');
    if (oW) return 10 - depth; if (xW) return depth - 10;
    const empty = b.reduce((acc,v,i)=>v?acc:[...acc,i],[]);
    if (!empty.length) return 0;
    if (isMax) {
      let best = -Infinity;
      for (let i of empty) { b[i]='O'; best=Math.max(best,minimax(b,depth+1,false,a,be)); b[i]=''; a=Math.max(a,best); if(be<=a)break; }
      return best;
    } else {
      let best = Infinity;
      for (let i of empty) { b[i]='X'; best=Math.min(best,minimax(b,depth+1,true,a,be)); b[i]=''; be=Math.min(be,best); if(be<=a)break; }
      return best;
    }
  }

  function cpuMove() {
    const empty = board.reduce((acc,v,i)=>v?acc:[...acc,i],[]);
    if (!empty.length) return;
    let best = -Infinity, move = empty[0];
    for (let i of empty) { board[i]='O'; const val=minimax(board,0,false,-Infinity,Infinity); board[i]=''; if(val>best){best=val;move=i;} }
    board[move] = 'O'; playClick();
    renderBoard();
    const w = checkWin(board,'O');
    if (w) { hi(w); scores.O++; upSc(); setS('ü§ñ CPU Wins!'); playFail(); endGame(); return; }
    if (board.every(Boolean)) { scores.D++; upSc(); setS('ü§ù Draw!'); endGame(); return; }
    setS('Your turn!'); processing = false;
  }

  function hi(w) { w.forEach(i=>{ const el=document.getElementById('tc'+i); if(el)el.classList.add('win-cell'); }); }
  function setS(msg) { const el=document.getElementById('tStatus'); if(el)el.textContent=msg; }
  function upSc() { ['X','O','D'].forEach(k=>{ const el=document.getElementById('t'+k); if(el)el.textContent=scores[k]; }); }

  function endGame() {
    gameOver = true; processing = false;
    setTimeout(() => {
      board = Array(9).fill(''); gameOver = false; processing = false;
      renderBoard(); setS('Your turn! Tap a cell');
    }, 1800);
  }

  window.tttClick = function(i) {
    if (gameOver || board[i] || processing) return;
    processing = true;
    board[i] = 'X'; playClick();
    renderBoard();
    const w = checkWin(board,'X');
    if (w) { hi(w); scores.X++; upSc(); setS('üéâ You Win!'); playWin(); endGame(); return; }
    if (board.every(Boolean)) { scores.D++; upSc(); setS('ü§ù Draw!'); endGame(); return; }
    setS('CPU thinking...'); setTimeout(cpuMove, 400);
  };

  window.tttReset = function() { board=Array(9).fill(''); gameOver=false; processing=false; renderBoard(); setS('Your turn! Tap a cell'); };
  renderBoard();
}

/* ==============================================================
   FIXED: SUDOKU ‚Äî proper new game every time
============================================================== */
function buildSudoku(c, lv) {
  lv = lv || 1;
  const PUZZLES = [
    { p:'530070000600195000098000060800060003400803001700020006060000280000419005000080079', s:'534678912672195348198342567859761423426853791713924856961537284287419635345286179' },
    { p:'008006700900000200005007040001050090070090030040010500010700400006000001007300600', s:'218436759963145287475287146321654897876991032549813562134762498658924311297358624' },
    { p:'700000400020030000001005060000906800030000090006108000050600900000080040003000002', s:'765218493428739651391465278514926837237841596896153724152684937673592148849317562' },
  ];
  const idx = (lv - 1) % PUZZLES.length;
  const puzzle = PUZZLES[idx].p.split('').map(Number);
  const solution = PUZZLES[idx].s.split('').map(Number);
  let userBoard = [...puzzle];
  let selected = null, errors = 0;

  c.innerHTML = `
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="sdkErr">0</div><div class="g-score-lbl">Errors</div></div>
      <div class="g-score-item"><div class="g-score-val" id="sdkLeft">0</div><div class="g-score-lbl">Empty</div></div>
    </div>
    <div class="sdk-wrap"><table class="sdk-grid" id="sdkTable" cellspacing="0" cellpadding="0"></table></div>
    <div class="sdk-nums" id="sdkNumpad"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button class="g-btn" onclick="buildSudoku(document.getElementById('gc'),${lv+1})">New Game</button>
      <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="sdkSolve()">Reveal</button>
      <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('sudoku')">‚≠ê Rate</button>
    </div>
    <div class="g-hint">Tap cell ‚Üí tap number. Fill all cells correctly!</div>`;

  const np = document.getElementById('sdkNumpad');
  for (let n=1;n<=9;n++) { const btn=document.createElement('button'); btn.className='sdk-num'; btn.textContent=n; btn.addEventListener('click',()=>sdkEnter(n)); np.appendChild(btn); }
  const clr=document.createElement('button'); clr.className='sdk-num'; clr.textContent='‚úï'; clr.addEventListener('click',()=>sdkEnter(0)); np.appendChild(clr);

  function renderGrid() {
    const tbl=document.getElementById('sdkTable'); if(!tbl)return;
    tbl.innerHTML='';
    for(let r=0;r<9;r++){const tr=document.createElement('tr');for(let col=0;col<9;col++){const td=document.createElement('td');const i=r*9+col;const orig=puzzle[i]!==0;td.className='sdk-cell'+(orig?' given':'')+(selected===i?' sel':'')+(userBoard[i]&&!orig&&userBoard[i]!==solution[i]?' err':'');td.textContent=userBoard[i]||'';td.addEventListener('click',()=>{if(!orig){selected=i;renderGrid();playClick();}});td.addEventListener('touchstart',e=>{e.preventDefault();if(!orig){selected=i;renderGrid();playClick();}},{passive:false});tr.appendChild(td);}tbl.appendChild(tr);}
    const left=userBoard.filter((v,i)=>v===0&&puzzle[i]===0).length;const el=document.getElementById('sdkLeft');if(el)el.textContent=left;
  }

  window.sdkEnter = function(n) {
    if(selected===null||puzzle[selected]!==0)return;
    if(n===0){userBoard[selected]=0;}else{userBoard[selected]=n;playClick();if(n!==solution[selected]){errors++;const ee=document.getElementById('sdkErr');if(ee)ee.textContent=errors;playFail();}else playTone(600,0.1,'sine',0.2);}
    renderGrid();
    const done=userBoard.every((v,i)=>v===solution[i]);
    if(done){playWin();showToast('üéâ Solved!');setTimeout(()=>showWin('Sudoku Solved!','sudoku',()=>openGame('sudoku')),400);}
  };
  addListener(document,'keydown',e=>{if(e.key>='1'&&e.key<='9')sdkEnter(+e.key);if(e.key==='Delete'||e.key==='Backspace')sdkEnter(0);});
  window.sdkSolve = function(){userBoard=[...solution];selected=null;renderGrid();showToast('‚úÖ Solved!');};
  renderGrid();
}

/* ==============================================================
   FIXED: BUBBLE SHOOTER ‚Äî complete mobile-friendly rewrite
============================================================== */
function buildBubble(c, lv) {
  lv = lv || 1;
  const W = 340, H = 480, R = 18;
  const COLS = 9;
  const COLORS = ['#ff6600','#3b82f6','#22c55e','#ec4899','#f59e0b'];
  const nC = Math.min(3 + lv, 5);
  let grid = [], cur = null, nxt = rndC();
  let score = 0, shooting = false, angle = -Math.PI/2;
  const SX = W/2, SY = H - 35;

  function rndC() { return COLORS[Math.floor(Math.random()*nC)]; }

  function initGrid() {
    grid = [];
    for (let row = 0; row < 4+Math.floor(lv/2); row++) {
      for (let col = 0; col < COLS - (row%2); col++) {
        const x = R + (row%2)*R + col*R*2;
        const y = R + row*R*1.73;
        grid.push({x, y, color: rndC()});
      }
    }
  }

  c.innerHTML = `
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="bSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="bCt">${0}</div><div class="g-score-lbl">Bubbles</div></div>
    </div>
    <canvas id="bC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;touch-action:none;max-width:100%;"></canvas>
    <div class="g-hint">Tap/click to aim & shoot! Match 3+ same color!</div>
    <button class="g-btn" onclick="showRating('bubble')">‚≠ê Rate</button>`;

  const canvas = document.getElementById('bC'), ctx = canvas.getContext('2d');

  function drawBub(x, y, color, alpha=1) {
    ctx.save(); ctx.globalAlpha = alpha;
    const g = ctx.createRadialGradient(x-R*.3, y-R*.3, 0, x, y, R);
    g.addColorStop(0, lighten(color, 50)); g.addColorStop(1, color);
    ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, R-1, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=1.5; ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.4)'; ctx.beginPath(); ctx.arc(x-R*.3, y-R*.3, R*.25, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function lighten(hex, a) {
    const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
    return `rgb(${Math.min(255,r+a)},${Math.min(255,g+a)},${Math.min(255,b+a)})`;
  }

  function draw() {
    const bg = ctx.createLinearGradient(0,0,0,H); bg.addColorStop(0,'#050515'); bg.addColorStop(1,'#100515');
    ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);
    grid.forEach(b => drawBub(b.x, b.y, b.color));
    // Shooter
    drawBub(SX, SY, cur ? cur.color : nxt);
    // Next
    ctx.fillStyle='rgba(255,255,255,.4)'; ctx.font='10px Exo 2'; ctx.fillText('NEXT:',6,H-28);
    drawBub(55, SY, nxt, 0.7);
    // Aim
    if (!shooting) {
      ctx.save(); ctx.setLineDash([5,9]); ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.moveTo(SX,SY);
      let lx=SX, ly=SY, dx=Math.cos(angle)*9, dy=Math.sin(angle)*9;
      for(let i=0;i<28;i++){lx+=dx;ly+=dy;if(lx<R){lx=R;dx*=-1;}if(lx>W-R){lx=W-R;dx*=-1;}if(ly<0)break;}
      ctx.lineTo(lx,ly); ctx.stroke(); ctx.restore();
    }
    if (cur) drawBub(cur.x, cur.y, cur.color);
    const ce = document.getElementById('bCt'); if(ce) ce.textContent = grid.length;
  }

  function snap(x, y) {
    const row = Math.round((y - R) / (R*1.73));
    const off = row % 2 === 1 ? R : 0;
    let cx = Math.round((x - off) / (R*2)) * R*2 + off + R;
    let cy = row * R*1.73 + R;
    cx = Math.max(R, Math.min(W-R, cx));
    cy = Math.max(R, cy);
    // Avoid overlap
    let tries = 0;
    while(grid.some(b => Math.hypot(b.x-cx, b.y-cy) < R*1.8) && tries < 8) {
      cx += R * (Math.random()-.5); tries++;
    }
    return {x:cx, y:cy};
  }

  function flood(x, y, color, seen=new Set()) {
    const key = Math.round(x)+','+Math.round(y);
    if (seen.has(key)) return [];
    const b = grid.find(bb => Math.hypot(bb.x-x, bb.y-y) < R*1.9);
    if (!b || b.color !== color) return [];
    seen.add(key);
    return [b, ...flood(b.x-R*2,b.y,color,seen), ...flood(b.x+R*2,b.y,color,seen),
      ...flood(b.x-R,b.y-R*1.73,color,seen), ...flood(b.x+R,b.y-R*1.73,color,seen),
      ...flood(b.x-R,b.y+R*1.73,color,seen), ...flood(b.x+R,b.y+R*1.73,color,seen)];
  }

  function land(bul) {
    const pos = snap(bul.x, bul.y);
    grid.push({x:pos.x, y:pos.y, color:bul.color});
    shooting = false; cur = null;
    const grp = flood(pos.x, pos.y, bul.color);
    if (grp.length >= 3) {
      grp.forEach(b => grid.splice(grid.indexOf(b),1));
      score += grp.length * 10;
      const ss = document.getElementById('bSc'); if(ss) ss.textContent = score;
      showToast('üí• +'+grp.length*10+'!'); playPop();
      if (!grid.length || score >= 300*lv) setTimeout(()=>showWin('Score: '+score+'!','bubble',()=>openGame('bubble')),400);
    } else { playTone(300, 0.05, 'square', 0.1); }
    nxt = rndC();
  }

  function shootBub() {
    if (shooting) return;
    shooting = true;
    const spd = 12;
    cur = {x:SX, y:SY, vx:Math.cos(angle)*spd, vy:Math.sin(angle)*spd, color:nxt};
    nxt = rndC(); playShoot();
  }

  function setAngle(cx, cy) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = W / rect.width, scaleY = H / rect.height;
    const gx = (cx - rect.left) * scaleX, gy = (cy - rect.top) * scaleY;
    angle = Math.atan2(gy - SY, gx - SX);
    angle = Math.max(-Math.PI + 0.1, Math.min(-0.05, angle));
  }

  function update() {
    if (cur) {
      cur.x += cur.vx; cur.y += cur.vy;
      if (cur.x < R) { cur.x = R; cur.vx *= -1; }
      if (cur.x > W-R) { cur.x = W-R; cur.vx *= -1; }
      if (cur.y < R || grid.some(b => Math.hypot(b.x-cur.x, b.y-cur.y) < R*1.85)) { land(cur); }
    }
    draw();
  }

  addListener(canvas, 'mousemove', e => setAngle(e.clientX, e.clientY));
  addListener(canvas, 'click', e => { setAngle(e.clientX, e.clientY); shootBub(); });
  addListener(canvas, 'touchmove', e => { e.preventDefault(); setAngle(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
  addListener(canvas, 'touchend', e => { e.preventDefault(); setAngle(e.changedTouches[0].clientX, e.changedTouches[0].clientY); shootBub(); }, {passive:false});

  initGrid(); draw(); startLoop(update);
}

/* ==============================================================
   FIXED: GLASS HIT ‚Äî proper canvas coordinate scaling
============================================================== */
function buildGlassHit(c, lv) {
  lv = lv || 1;
  const W=400, H=340;
  let targets=[], score=0, hits=0, combo=0, particles=[], spawnInt;
  let targetCount = 5 + lv * 3;

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="ghSc">0</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val" id="ghHt">0/${targetCount}</div><div class="g-score-lbl">Hits</div></div>
      <div class="g-score-item"><div class="g-score-val" id="ghCo">x1</div><div class="g-score-lbl">Combo</div></div>
    </div>
    <canvas id="ghC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;touch-action:none;max-width:100%;"></canvas>
    <div class="g-hint">Tap/click the glowing targets before they fade! Fast = more combo!</div>
    <button class="g-btn" onclick="showRating('glasshit')">‚≠ê Rate</button>`;

  const canvas = document.getElementById('ghC'), ctx = canvas.getContext('2d');

  function spawn() {
    if (targets.length >= 6 + lv) return;
    const shapes = ['circle','square','diamond'];
    targets.push({
      x: 50+Math.random()*(W-100), y: 40+Math.random()*(H-80),
      r: 22+Math.random()*18, maxLife: 2.5+Math.random()*1.5,
      born: Date.now(), hue: Math.random()*360,
      shape: shapes[Math.floor(Math.random()*3)], hit:false
    });
  }

  function hitTarget(mx, my) {
    let didHit = false;
    for (let i = targets.length-1; i >= 0; i--) {
      const t = targets[i];
      if (t.hit) continue;
      const dx = mx-t.x, dy = my-t.y;
      if (Math.sqrt(dx*dx+dy*dy) < t.r+8) {
        t.hit = true; didHit = true; combo++;
        for(let p=0;p<12;p++) particles.push({x:t.x,y:t.y,vx:(Math.random()-.5)*9,vy:(Math.random()-.5)*9,life:1,hue:t.hue,s:3+Math.random()*3});
        const pts = 10 * combo;
        score += pts; hits++;
        const ss=document.getElementById('ghSc'); if(ss) ss.textContent=score;
        const hh=document.getElementById('ghHt'); if(hh) hh.textContent=hits+'/'+targetCount;
        const cc=document.getElementById('ghCo'); if(cc) cc.textContent='x'+combo;
        showToast('+'+pts+(combo>2?' COMBO!':'')); playHit();
        setTimeout(()=>{const idx=targets.indexOf(t);if(idx>-1)targets.splice(idx,1);}, 300);
        if (hits >= targetCount) setTimeout(()=>showWin('Score: '+score+'! Hit Master!','glasshit',()=>openGame('glasshit')),400);
        break;
      }
    }
    if (!didHit) { combo = 0; const cc=document.getElementById('ghCo'); if(cc)cc.textContent='x1'; }
  }

  function draw() {
    ctx.fillStyle='#030310'; ctx.fillRect(0,0,W,H);
    // Glass shards bg
    ctx.save(); ctx.globalAlpha=0.04;
    for(let i=0;i<12;i++){ctx.strokeStyle=`hsl(${200+i*8},60%,70%)`;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(i*35,0);ctx.lineTo(i*30+20,H);ctx.stroke();}
    ctx.restore();
    targets.forEach(t => {
      const age = (Date.now()-t.born)/1000, life = Math.max(0, 1-age/t.maxLife);
      if (life <= 0 && !t.hit) { combo=0; const cc=document.getElementById('ghCo');if(cc)cc.textContent='x1'; }
      if (life <= 0 || t.hit) return;
      const pulse = 0.85 + Math.sin(Date.now()/200)*0.15;
      ctx.save(); ctx.globalAlpha = life;
      const gg = ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,t.r*2.5);
      gg.addColorStop(0,`hsla(${t.hue},80%,60%,${life*.4})`); gg.addColorStop(1,'transparent');
      ctx.fillStyle=gg; ctx.beginPath(); ctx.arc(t.x,t.y,t.r*2.5,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle=`hsla(${t.hue},80%,65%,${life})`; ctx.lineWidth=2.5;
      ctx.fillStyle=`hsla(${t.hue},60%,60%,${life*.15})`;
      if(t.shape==='circle'){ctx.beginPath();ctx.arc(t.x,t.y,t.r*pulse,0,Math.PI*2);ctx.fill();ctx.stroke();}
      else if(t.shape==='square'){ctx.beginPath();ctx.roundRect(t.x-t.r*pulse,t.y-t.r*pulse,t.r*2*pulse,t.r*2*pulse,5);ctx.fill();ctx.stroke();}
      else{ctx.beginPath();ctx.moveTo(t.x,t.y-t.r*pulse);ctx.lineTo(t.x+t.r*pulse,t.y);ctx.lineTo(t.x,t.y+t.r*pulse);ctx.lineTo(t.x-t.r*pulse,t.y);ctx.closePath();ctx.fill();ctx.stroke();}
      // Countdown ring
      ctx.strokeStyle=`hsla(${t.hue},100%,70%,${life*.5})`;ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(t.x,t.y,t.r+6,-Math.PI/2,-Math.PI/2+Math.PI*2*life);ctx.stroke();
      ctx.restore();
    });
    targets = targets.filter(t=>(Date.now()-t.born)/1000 < t.maxLife && !t.hit);
    particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=.03;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=`hsl(${p.hue},80%,60%)`;ctx.beginPath();ctx.arc(p.x,p.y,p.s*p.life,0,Math.PI*2);ctx.fill();ctx.restore();});
    particles=particles.filter(p=>p.life>0);
  }

  function onTap(clientX, clientY) {
    const pos = getCanvasPos(canvas, clientX, clientY);
    hitTarget(pos.x, pos.y);
  }

  addListener(canvas,'click', e => onTap(e.clientX, e.clientY));
  addListener(canvas,'touchstart', e => { e.preventDefault(); onTap(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});

  spawnInt = addInterval(spawn, 800);
  for(let i=0;i<3;i++) spawn();
  draw(); startLoop(draw);
}

/* ==============================================================
   FIXED: WORD SEARCH ‚Äî event delegation (no per-cell listeners)
============================================================== */
function buildWordSearch(c, lv) {
  lv = lv || 1;
  const SZ = 9 + Math.min(lv-1, 3);
  const BANKS = [['GAME','CODE','PLAY','WIN','FUN','ACE'],['CHESS','RACER','SCORE','LEVEL','PIXEL'],['ARCADE','BATTLE','DRAGON','GALAXY'],['WARRIOR','MISSION','THUNDER','CRYSTAL']];
  const bank = BANKS[Math.min(lv-1,3)];
  const words = bank.slice(0, 3 + Math.min(lv,3));
  let grid=[], placed=[], found=[], selCells=[], startCell=null;

  function initG() {
    grid = Array.from({length:SZ}, ()=>Array(SZ).fill(''));
    placed = [];
    for (const word of words) {
      for (let tr=0;tr<100;tr++) {
        const dirs=[[0,1],[1,0],[1,1],[0,-1],[-1,0],[-1,-1],[1,-1],[-1,1]];
        const [dr,dc]=dirs[Math.floor(Math.random()*8)];
        const r=Math.floor(Math.random()*SZ), col=Math.floor(Math.random()*SZ);
        let ok=true; const cells=[];
        for (let i=0;i<word.length;i++) { const nr=r+dr*i, nc=col+dc*i; if(nr<0||nr>=SZ||nc<0||nc>=SZ){ok=false;break;} if(grid[nr][nc]&&grid[nr][nc]!==word[i]){ok=false;break;} cells.push([nr,nc]); }
        if(ok){cells.forEach(([nr,nc],i)=>grid[nr][nc]=word[i]);placed.push({word,cells});break;}
      }
    }
    const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    for(let r=0;r<SZ;r++) for(let col=0;col<SZ;col++) if(!grid[r][col])grid[r][col]=L[Math.floor(Math.random()*26)];
  }

  function getCellFromEvent(e) {
    const g = document.getElementById('wsGrid');
    if (!g) return null;
    const rect = g.getBoundingClientRect();
    const cw = rect.width / SZ, ch = rect.height / SZ;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const col = Math.floor((clientX - rect.left) / cw);
    const row = Math.floor((clientY - rect.top) / ch);
    if (row < 0 || row >= SZ || col < 0 || col >= SZ) return null;
    return [row, col];
  }

  function extendSel(r, col) {
    if (!startCell) return;
    const [sr, sc] = startCell;
    const dr = Math.sign(r-sr), dc = Math.sign(col-sc);
    selCells = [[sr,sc]];
    let cr=sr+dr, cc=sc+dc;
    while((cr!==r||cc!==col)&&cr>=0&&cr<SZ&&cc>=0&&cc<SZ) { selCells.push([cr,cc]); cr+=dr; cc+=dc; }
    if(r>=0&&r<SZ&&col>=0&&col<SZ) selCells.push([r,col]);
    render();
  }

  function checkWord() {
    const s = selCells.map(([r,col])=>grid[r][col]).join('');
    const rs = s.split('').reverse().join('');
    for(const {word} of placed) {
      if((s===word||rs===word)&&!found.includes(word)){
        found.push(word); showToast('‚úÖ Found: '+word); playWin();
        const fe=document.getElementById('wsFd');if(fe)fe.textContent=found.length+'/'+words.length;
        if(found.length===words.length){showToast('üéâ All found!');setTimeout(()=>showWin('All '+words.length+' words!','wordsearch',()=>openGame('wordsearch')),400);}
      }
    }
    selCells = []; startCell = null; render();
  }

  function render() {
    const g = document.getElementById('wsGrid'); if(!g) return;
    const FC = new Set(); placed.filter(p=>found.includes(p.word)).forEach(p=>p.cells.forEach(([r,col])=>FC.add(r+','+col)));
    const SS = new Set(selCells.map(([r,col])=>r+','+col));
    const CS = Math.min(Math.floor((window.innerWidth - 60) / SZ), 30);
    g.style.cssText = `display:grid;grid-template-columns:repeat(${SZ},${CS}px);gap:2px;user-select:none;touch-action:none;cursor:pointer;`;
    g.innerHTML = grid.flatMap((row,r)=>row.map((ch,col)=>{
      const key=r+','+col, iS=SS.has(key), iF=FC.has(key);
      return `<div style="width:${CS}px;height:${CS}px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:${Math.max(10,CS*.55)}px;border-radius:4px;background:${iF?'rgba(34,197,94,.3)':iS?'rgba(255,102,0,.35)':'rgba(255,255,255,.04)'};color:${iF?'#22c55e':iS?'var(--orange)':'#ddd'};border:1px solid ${iF?'rgba(34,197,94,.4)':iS?'rgba(255,102,0,.4)':'rgba(255,255,255,.06)'};">${ch}</div>`;
    })).join('');
    const wl=document.getElementById('wsWL');if(wl)wl.innerHTML=words.map(w=>`<span style="padding:3px 10px;border-radius:16px;font-size:.78rem;font-weight:700;background:${found.includes(w)?'rgba(34,197,94,.15)':'var(--card2)'};border:1px solid ${found.includes(w)?'#22c55e':'var(--border)'};text-decoration:${found.includes(w)?'line-through':'none'};color:${found.includes(w)?'#22c55e':'#aaa'};">${w}</span>`).join('');
  }

  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="wsFd">0/${words.length}</div><div class="g-score-lbl">Found</div></div></div>
  <div id="wsGrid" style="touch-action:none;"></div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;" id="wsWL"></div>
  <div class="g-hint">Drag to select ‚Äî words go any direction!</div>
  <button class="g-btn" onclick="showRating('wordsearch')">‚≠ê Rate</button>`;

  const wsG = document.getElementById('wsGrid');
  addListener(wsG, 'mousedown', e => { const cell=getCellFromEvent(e); if(cell){startCell=cell;selCells=[cell];render();} });
  addListener(wsG, 'mousemove', e => { if(!startCell)return; const cell=getCellFromEvent(e); if(cell)extendSel(cell[0],cell[1]); });
  addListener(wsG, 'mouseup', () => { if(startCell){checkWord();} });
  addListener(wsG, 'touchstart', e => { e.preventDefault(); const cell=getCellFromEvent(e); if(cell){startCell=cell;selCells=[cell];render();} }, {passive:false});
  addListener(wsG, 'touchmove', e => { e.preventDefault(); const cell=getCellFromEvent(e); if(cell)extendSel(cell[0],cell[1]); }, {passive:false});
  addListener(wsG, 'touchend', e => { e.preventDefault(); if(startCell)checkWord(); }, {passive:false});

  initG(); render();
}

/* ==============================================================
   FIXED: MAGIC TILES ‚Äî proper scoring & piano sounds
============================================================== */
function buildMagicTiles(c, lv) {
  lv = lv || 1;
  const COLS = 4, TH = 90, W = 320, H = 480;
  let tiles=[], score=0, lives=3, speed=1.8+lv*.4, running=false, missed=0;
  const NOTE_FREQS = [262, 330, 392, 523];

  function spawnRow() {
    const bc = Math.floor(Math.random()*COLS);
    tiles.push({y:-TH, black:bc, hit:false, missed:false, note:bc});
  }

  function draw(ctx) {
    ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
    const TW = W/COLS;
    ctx.strokeStyle='rgba(255,255,255,.1)'; ctx.lineWidth=1;
    for(let i=1;i<COLS;i++){ctx.beginPath();ctx.moveTo(i*TW,0);ctx.lineTo(i*TW,H);ctx.stroke();}
    ctx.strokeStyle='rgba(255,102,0,.4)'; ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(0,H-65);ctx.lineTo(W,H-65);ctx.stroke();
    tiles.forEach(t=>{
      for(let col=0;col<COLS;col++){
        if(col===t.black){
          if(t.hit){ctx.fillStyle='rgba(255,102,0,.6)';ctx.fillRect(col*TW+1,t.y,TW-2,TH-2);}
          else{ctx.fillStyle='#111';ctx.fillRect(col*TW+1,t.y,TW-2,TH-2);ctx.fillStyle='#252525';ctx.fillRect(col*TW+5,t.y+5,TW-12,8);}
        }else{ctx.fillStyle='rgba(240,240,240,.07)';ctx.fillRect(col*TW+1,t.y,TW-2,TH-2);}
      }
    });
    ['C','D','E','F'].forEach((n,i)=>{ctx.fillStyle='rgba(255,255,255,.2)';ctx.font='10px Exo 2';ctx.textAlign='center';ctx.fillText(n,i*TW+TW/2,H-12);});
    ctx.textAlign='left';
    if(!running&&score>0){ctx.fillStyle='rgba(0,0,0,.85)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#ff6600';ctx.font='bold 20px Orbitron';ctx.textAlign='center';ctx.fillText('GAME OVER',W/2,H/2-10);ctx.fillStyle='#fff';ctx.font='14px Exo 2';ctx.fillText('Score: '+score,W/2,H/2+18);ctx.textAlign='left';}
  }

  function update(ctx) {
    if(!running)return;
    tiles.forEach(t=>t.y+=speed);
    const last=tiles[tiles.length-1];if(!last||last.y>-TH)spawnRow();
    tiles.forEach(t=>{
      if(t.y>H-65&&!t.hit&&!t.missed){t.missed=true;lives--;
        const le=document.getElementById('mtLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));
        if(lives<=0){running=false;showToast('Game Over! Score: '+score);}
        else showToast('Miss!');}
    });
    tiles=tiles.filter(t=>t.y<H+TH);
    draw(ctx);
  }

  function tap(ex, ey) {
    if(!running)return;
    const TW=W/COLS;
    const canvas=document.getElementById('mtC');if(!canvas)return;
    const pos=getCanvasPos(canvas, ex, ey);
    const col=Math.floor(pos.x/TW);
    const hitTile=tiles.find(t=>t.black===col&&pos.y>t.y&&pos.y<t.y+TH&&!t.hit);
    if(hitTile){
      hitTile.hit=true;score+=10;
      playPiano(hitTile.note);
      const ss=document.getElementById('mtSc');if(ss)ss.textContent=score;
      if(score>=300*lv)setTimeout(()=>showWin('Score: '+score+'! Piano Master!','magictiles',()=>openGame('magictiles')),300);
    } else {
      lives--;playFail();
      const le=document.getElementById('mtLv');if(le)le.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives));
      if(lives<=0){running=false;showToast('Wrong tile! Game Over!');}
    }
  }

  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="mtSc">0</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val" id="mtLv">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div><div class="g-score-lbl">Lives</div></div></div><canvas id="mtC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;max-width:100%;display:block;"></canvas><div class="g-hint">Tap BLACK tiles only! Miss or tap white = lose a life!</div><button class="g-btn" id="mtBtn" onclick="mtSt()">üéπ Start!</button><button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('magictiles')">‚≠ê Rate</button>`;
  const cv=document.getElementById('mtC'),ctx=cv.getContext('2d');
  addListener(cv,'click',e=>tap(e.clientX,e.clientY));
  addListener(cv,'touchstart',e=>{e.preventDefault();tap(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});
  window.mtSt=function(){score=0;lives=3;tiles=[];speed=1.8+lv*.4;running=true;for(let i=0;i<5;i++){const bc=Math.floor(Math.random()*COLS);tiles.push({y:-(i+1)*TH,black:bc,hit:false,missed:false,note:bc});}const ss=document.getElementById('mtSc');if(ss)ss.textContent=0;const le=document.getElementById('mtLv');if(le)le.textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è';};
  draw(ctx);startLoop(()=>update(ctx));
}

/* ==============================================================
   FIXED: HILL CLIMB ‚Äî coins, fuel pickups, difficulty
============================================================== */
function buildHillClimb(c, lv) {
  lv=lv||1;
  const W=500,H=380,GND_BASE=260;
  const TERRAIN_LEN=8000;
  let terrain=[],carX=150,carY=0,carVX=0,carAngle=0,fuel=100,score=0,camX=0,coins3=[],coinCount=0,gasOn=false,brakeOn=false;

  function genTerrain(){
    terrain=[{x:0,y:GND_BASE}];
    let x=0,y=GND_BASE;
    while(x<TERRAIN_LEN){const step=15+Math.random()*20;x+=step;y+=(-1+Math.random()*2)*(10+lv*3+x/1000*2);y=Math.max(GND_BASE-100,Math.min(GND_BASE+80,y));terrain.push({x,y});}
    // Add coins and fuel
    coins3=[];
    for(let cx=300;cx<TERRAIN_LEN-100;cx+=180+Math.random()*120){
      const cy=groundY(cx)-30;
      const type=Math.random()<.2?'fuel':'coin';
      coins3.push({x:cx,y:cy,type,collected:false});
    }
  }

  function groundY(x){
    for(let i=0;i<terrain.length-1;i++){if(terrain[i].x<=x&&terrain[i+1].x>=x){const t=(x-terrain[i].x)/(terrain[i+1].x-terrain[i].x);return terrain[i].y*(1-t)+terrain[i+1].y*t;}}
    return GND_BASE;
  }

  c.innerHTML=`
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="hcSc">0m</div><div class="g-score-lbl">Distance</div></div>
      <div class="g-score-item"><div class="g-score-val" id="hcCo">0</div><div class="g-score-lbl">Coinsü™ô</div></div>
      <div class="g-score-item"><div class="g-score-val" id="hcFl">100%</div><div class="g-score-lbl">Fuel</div></div>
    </div>
    <canvas id="hcC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;"></canvas>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button class="g-btn" onmousedown="hcGas(true)" onmouseup="hcGas(false)" ontouchstart="hcGas(true);event.preventDefault()" ontouchend="hcGas(false)" style="padding:10px 24px;font-size:1.2rem;">‚õΩ Gas</button>
      <button class="g-btn" onmousedown="hcBrake(true)" onmouseup="hcBrake(false)" ontouchstart="hcBrake(true);event.preventDefault()" ontouchend="hcBrake(false)" style="padding:10px 24px;font-size:1.2rem;">üõë Brake</button>
    </div>
    <div class="g-hint">ü™ô collect coins ‚Ä¢ ‚õΩ collect fuel ‚Ä¢ Arrow keys work too!</div>
    <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('hillclimb')">‚≠ê Rate</button>`;

  const cv=document.getElementById('hcC'),ctx=cv.getContext('2d');
  window.hcGas=function(on){gasOn=on;};window.hcBrake=function(on){brakeOn=on;};
  addListener(document,'keydown',e=>{if(e.key==='ArrowRight'||e.key==='d')gasOn=true;if(e.key==='ArrowLeft'||e.key==='a')brakeOn=true;});
  addListener(document,'keyup',e=>{if(e.key==='ArrowRight'||e.key==='d')gasOn=false;if(e.key==='ArrowLeft'||e.key==='a')brakeOn=false;});

  let wheelAng=0;

  function draw(){
    // Sky gradient
    const bg=ctx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#1a3a6a');bg.addColorStop(.65,'#2a4a8a');bg.addColorStop(1,'#3a5a20');ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
    // Clouds
    ctx.fillStyle='rgba(255,255,255,.15)';
    [{x:80-camX*.05,y:50,r:30},{x:240-camX*.05,y:35,r:40},{x:420-camX*.05,y:55,r:28}].forEach(cl=>{const cx2=((cl.x%W)+W)%W;ctx.beginPath();ctx.arc(cx2,cl.y,cl.r,0,Math.PI*2);ctx.arc(cx2+cl.r,cl.y,cl.r*.7,0,Math.PI*2);ctx.arc(cx2-cl.r*.5,cl.y,cl.r*.65,0,Math.PI*2);ctx.fill();});
    // Terrain
    const pts=terrain.filter(p=>p.x>=camX-20&&p.x<=camX+W+20);
    if(pts.length>1){ctx.fillStyle='#4a7a20';ctx.beginPath();ctx.moveTo(pts[0].x-camX,pts[0].y);pts.forEach(p=>ctx.lineTo(p.x-camX,p.y));ctx.lineTo(pts[pts.length-1].x-camX,H);ctx.lineTo(pts[0].x-camX,H);ctx.closePath();ctx.fill();ctx.strokeStyle='#5a9a28';ctx.lineWidth=3;ctx.beginPath();pts.forEach((p,i)=>i?ctx.lineTo(p.x-camX,p.y):ctx.moveTo(p.x-camX,p.y));ctx.stroke();}
    // Rocks (visual)
    for(let rx=Math.floor(camX/200)*200;rx<camX+W;rx+=200){ctx.fillStyle='#5a4a3a';ctx.beginPath();ctx.arc(rx-camX,groundY(rx)-10,12,0,Math.PI*2);ctx.fill();}
    // Coins & fuel
    coins3.filter(coin=>!coin.collected&&coin.x>camX-50&&coin.x<camX+W+50).forEach(coin=>{
      ctx.font='18px serif';ctx.textAlign='center';ctx.fillText(coin.type==='fuel'?'‚õΩ':'ü™ô',coin.x-camX,coin.y);
      ctx.strokeStyle=coin.type==='fuel'?'rgba(34,197,94,.4)':'rgba(255,215,0,.4)';
      ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(coin.x-camX,coin.y-5,14,0,Math.PI*2);ctx.stroke();
    });
    ctx.textAlign='left';
    // Car
    const cx=carX-camX,cy=carY;
    ctx.save();ctx.translate(cx,cy);ctx.rotate(carAngle);
    ctx.fillStyle='#ff6600';ctx.beginPath();ctx.roundRect(-38,-22,76,22,5);ctx.fill();
    ctx.fillStyle='#ff8833';ctx.beginPath();ctx.roundRect(-26,-38,38,18,4);ctx.fill();
    ctx.fillStyle='rgba(180,220,255,.8)';ctx.fillRect(-20,-34,28,12);
    [['-',-28,0,'back'],['+',20,0,'front']].forEach(([s,wx,wy])=>{
      ctx.save();ctx.translate(wx,wy);ctx.rotate(wheelAng*(s==='+'?1:1));
      ctx.fillStyle='#333';ctx.beginPath();ctx.arc(0,0,12,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='#888';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-10,0);ctx.lineTo(10,0);ctx.moveTo(0,-10);ctx.lineTo(0,10);ctx.stroke();ctx.restore();
    });
    // Gas flame
    if(gasOn){ctx.fillStyle='rgba(255,100,0,.7)';ctx.beginPath();ctx.moveTo(-38,0);ctx.lineTo(-50,-5);ctx.lineTo(-38,-8);ctx.closePath();ctx.fill();}
    ctx.restore();
    // Fuel bar
    const fpct=Math.round(fuel);ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(8,H-30,104,14);ctx.fillStyle=fpct>25?'#22c55e':'#ef4444';ctx.fillRect(8,H-30,fpct,14);ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='9px Exo 2';ctx.fillText('FUEL',12,H-19);
    const fe=document.getElementById('hcFl');if(fe)fe.textContent=fpct+'%';
  }

  function update(){
    const g1=groundY(carX-28),g2=groundY(carX+28);
    const slope=Math.atan2(g2-g1,56);
    const grav=Math.sin(slope)*(.3+lv*.02+carX/TERRAIN_LEN*.2);
    if(gasOn){carVX+=.22;fuel=Math.max(0,fuel-.055);wheelAng+=.15;}
    if(brakeOn){carVX*=.88;wheelAng+=carVX*.05;}
    else if(!gasOn)wheelAng+=carVX*.05;
    carVX-=grav;carVX*=.99;carVX=Math.max(-4,Math.min(10+lv,carVX));
    carX+=carVX;score=Math.floor(carX/20);
    const midY=groundY(carX);carY=midY-18;carAngle=slope*.55;
    camX=Math.max(0,carX-150);
    // Collect coins
    coins3.filter(coin=>!coin.collected&&Math.abs(coin.x-carX)<30&&Math.abs(coin.y-groundY(carX))<40).forEach(coin=>{
      coin.collected=true;
      if(coin.type==='fuel'){fuel=Math.min(100,fuel+40);showToast('‚õΩ Refueled!');playTone(500,0.15,'sine',0.3);}
      else{coinCount+=10;playPop();showToast('+10 ü™ô');}
      const ce=document.getElementById('hcCo');if(ce)ce.textContent=coinCount;
      const ss=document.getElementById('hcSc');if(ss)ss.textContent=score+'m';
    });
    if(fuel<=0||Math.abs(carAngle)>1.3){showToast(fuel<=0?'üí® Out of fuel!':'üîÑ Flipped!');playFail();fuel=100;carX=150;carY=GND_BASE-18;carVX=0;carAngle=0;camX=0;}
    if(score>=300*lv)setTimeout(()=>showWin(score+'m! Coins: '+coinCount,'hillclimb',()=>openGame('hillclimb')),400);
    const ss=document.getElementById('hcSc');if(ss)ss.textContent=score+'m';
    draw();
  }

  genTerrain();draw();startLoop(update);
}

/* ==============================================================
   FIXED: CARROM ‚Äî complete physics rewrite
============================================================== */
function buildCarrom(c, lv) {
  lv=lv||1;
  const W=400, H=400, PAD=35;
  const PocketR=18;
  const POCKETS=[{x:PAD,y:PAD},{x:W-PAD,y:PAD},{x:PAD,y:H-PAD},{x:W-PAD,y:H-PAD}];
  let coins3=[], striker=null, score=0, running=false, aimAngle=-Math.PI/2, charging=false, chargeT=0;

  function mkStriker(){return {x:W/2,y:H-65,vx:0,vy:0,r:16};}

  function initCoins(){
    striker=mkStriker();
    coins3=[];
    const cx=W/2,cy=H/2;
    const offsets=[[0,0,'#f97316'],[1,0,'#f5f5f5'],[-1,0,'#1a1a1a'],[0,1,'#f5f5f5'],[0,-1,'#1a1a1a'],
      [.8,.8,'#1a1a1a'],[-.8,.8,'#f5f5f5'],[.8,-.8,'#f5f5f5'],[-.8,-.8,'#1a1a1a'],
      [1.6,0,'#f5f5f5'],[-1.6,0,'#1a1a1a'],[0,1.6,'#f5f5f5'],[0,-1.6,'#1a1a1a']];
    offsets.forEach(([dx,dy,col])=>coins3.push({x:cx+dx*26,y:cy+dy*26,vx:0,vy:0,r:10,c:col,potted:false}));
  }

  function moving(){
    if(!striker)return false;
    return Math.abs(striker.vx)>.08||Math.abs(striker.vy)>.08||coins3.some(co=>Math.abs(co.vx)>.08||Math.abs(co.vy)>.08);
  }

  function draw(ctx){
    if(!striker){draw_empty(ctx);return;}
    ctx.fillStyle='#c8a56b';ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#b8954a';ctx.fillRect(PAD,PAD,W-PAD*2,H-PAD*2);
    // Board lines
    ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1.5;
    ctx.strokeRect(PAD+18,PAD+18,W-PAD*2-36,H-PAD*2-36);
    ctx.beginPath();ctx.moveTo(W/2,PAD);ctx.lineTo(W/2,H-PAD);ctx.moveTo(PAD,H/2);ctx.lineTo(W-PAD,H/2);ctx.stroke();
    ctx.beginPath();ctx.arc(W/2,H/2,46,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.arc(W/2,H/2,8,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.2)';ctx.fill();
    POCKETS.forEach(p=>{ctx.fillStyle='rgba(0,0,0,.7)';ctx.beginPath();ctx.arc(p.x,p.y,PocketR,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#000';ctx.lineWidth=1;ctx.stroke();});
    // Aim guide
    if(!moving()&&running){ctx.save();ctx.setLineDash([8,12]);ctx.strokeStyle='rgba(255,200,0,.5)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(striker.x,striker.y);ctx.lineTo(striker.x+Math.cos(aimAngle)*100,striker.y+Math.sin(aimAngle)*100);ctx.stroke();ctx.restore();}
    // Charging bar
    if(charging){const pw=Math.min((Date.now()-chargeT)/700,1);ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(striker.x-30,striker.y-35,60,10);ctx.fillStyle=`hsl(${120-pw*120},100%,45%)`;ctx.fillRect(striker.x-30,striker.y-35,60*pw,10);}
    // Coins
    coins3.filter(co=>!co.potted).forEach(co=>{
      const cg=ctx.createRadialGradient(co.x-2,co.y-2,0,co.x,co.y,co.r);
      cg.addColorStop(0,co.c==='#1a1a1a'?'#555':co.c==='#f97316'?'#fba040':'#fff');
      cg.addColorStop(1,co.c);
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(co.x,co.y,co.r,0,Math.PI*2);ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1;ctx.stroke();
    });
    // Striker rail
    ctx.fillStyle='rgba(0,0,0,.15)';ctx.fillRect(PAD+4,H-76,W-PAD*2-8,3);ctx.fillRect(PAD+4,H-48,W-PAD*2-8,3);
    // Striker
    ctx.fillStyle='rgba(255,255,255,.92)';ctx.beginPath();ctx.arc(striker.x,striker.y,striker.r,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#ff6600';ctx.lineWidth=2.5;ctx.stroke();
    ctx.fillStyle='#ff6600';ctx.beginPath();ctx.arc(striker.x,striker.y,4,0,Math.PI*2);ctx.fill();
  }

  function draw_empty(ctx){ctx.fillStyle='#111';ctx.fillRect(0,0,W,H);}

  function update(ctx){
    if(!striker)return;
    const fr=.984;
    striker.x+=striker.vx;striker.y+=striker.vy;striker.vx*=fr;striker.vy*=fr;
    // Wall bounce
    if(striker.x<PAD+striker.r){striker.x=PAD+striker.r;striker.vx*=-.7;}
    if(striker.x>W-PAD-striker.r){striker.x=W-PAD-striker.r;striker.vx*=-.7;}
    if(striker.y<PAD+striker.r){striker.y=PAD+striker.r;striker.vy*=-.7;}
    if(striker.y>H-48){striker.y=H-48;striker.vy=0;striker.vx*=.4;}
    // Coins physics
    coins3.filter(co=>!co.potted).forEach(co=>{
      co.x+=co.vx;co.y+=co.vy;co.vx*=fr;co.vy*=fr;
      if(co.x<PAD+co.r){co.x=PAD+co.r;co.vx*=-.8;}
      if(co.x>W-PAD-co.r){co.x=W-PAD-co.r;co.vx*=-.8;}
      if(co.y<PAD+co.r){co.y=PAD+co.r;co.vy*=-.8;}
      if(co.y>H-PAD-co.r){co.y=H-PAD-co.r;co.vy*=-.8;}
      // Pocket check
      POCKETS.forEach(p=>{if(Math.hypot(co.x-p.x,co.y-p.y)<PocketR+co.r/2){co.potted=true;const pts=co.c==='#f97316'?25:10;score+=pts;const se=document.getElementById('caSc');if(se)se.textContent=score;showToast((co.c==='#f97316'?'üëë Queen! ':'Potted! ')+'+'+pts);playPop();}});
      // Striker-coin collision
      const dx=striker.x-co.x,dy=striker.y-co.y,d=Math.hypot(dx,dy);
      if(d<striker.r+co.r&&d>0){
        const nx=dx/d,ny=dy/d;
        const overlap=(striker.r+co.r-d)/2;
        striker.x+=nx*overlap;striker.y+=ny*overlap;co.x-=nx*overlap;co.y-=ny*overlap;
        const rel=striker.vx*nx+striker.vy*ny-(co.vx*nx+co.vy*ny);
        if(rel<0){striker.vx-=rel*nx*.85;striker.vy-=rel*ny*.85;co.vx+=rel*nx*.85;co.vy+=rel*ny*.85;}
      }
    });
    // Coin-coin collisions
    for(let i=0;i<coins3.length;i++) for(let j=i+1;j<coins3.length;j++){
      if(coins3[i].potted||coins3[j].potted)continue;
      const a=coins3[i],b=coins3[j];
      const dx=a.x-b.x,dy=a.y-b.y,d=Math.hypot(dx,dy);
      if(d<a.r+b.r&&d>0){const nx=dx/d,ny=dy/d;const overlap=(a.r+b.r-d)/2;a.x+=nx*overlap;a.y+=ny*overlap;b.x-=nx*overlap;b.y-=ny*overlap;const rel=a.vx*nx+a.vy*ny-(b.vx*nx+b.vy*ny);if(rel<0){a.vx-=rel*nx*.9;a.vy-=rel*ny*.9;b.vx+=rel*nx*.9;b.vy+=rel*ny*.9;}}
    }
    if(running&&!coins3.some(co=>!co.potted)){running=false;setTimeout(()=>showWin('Score: '+score+'! Carrom Champ!','carrom',()=>openGame('carrom')),400);}
    draw(ctx);
  }

  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="caSc">0</div><div class="g-score-lbl">Score</div></div></div><canvas id="caC" class="g-canvas" width="${W}" height="${H}" style="cursor:crosshair;touch-action:none;max-width:100%;"></canvas><div class="g-hint">Aim with mouse. Hold & release to flick!</div><button class="g-btn" id="caBtn" onclick="caSt()">üéØ Start!</button><button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('carrom')">‚≠ê Rate</button>`;

  const cv=document.getElementById('caC'),ctx=cv.getContext('2d');

  function onMove(clientX, clientY) {
    if(!striker||moving())return;
    const pos=getCanvasPos(cv,clientX,clientY);
    aimAngle=Math.atan2(pos.y-striker.y,pos.x-striker.x);
    const railX=Math.max(PAD+striker.r+4,Math.min(W-PAD-striker.r-4,pos.x));
    striker.x=railX;
  }

  addListener(cv,'mousemove',e=>onMove(e.clientX,e.clientY));
  addListener(cv,'mousedown',()=>{if(!moving()&&running){charging=true;chargeT=Date.now();}});
  addListener(cv,'mouseup',()=>{if(!charging)return;charging=false;const pw=Math.min((Date.now()-chargeT)/700,1);const spd=4+pw*15;striker.vx=Math.cos(aimAngle)*spd;striker.vy=Math.sin(aimAngle)*spd;playShoot();});
  addListener(cv,'touchmove',e=>{e.preventDefault();onMove(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});
  addListener(cv,'touchstart',e=>{e.preventDefault();if(!moving()&&running){charging=true;chargeT=Date.now();}},{passive:false});
  addListener(cv,'touchend',e=>{e.preventDefault();if(!charging)return;charging=false;const pw=Math.min((Date.now()-chargeT)/700,1);striker.vx=0;striker.vy=-(4+pw*15);playShoot();},{passive:false});

  window.caSt=function(){score=0;running=true;initCoins();const se=document.getElementById('caSc');if(se)se.textContent=0;};
  initCoins();draw(ctx);startLoop(()=>{if(running)update(ctx);else draw(ctx);});
}

/* ==============================================================
   NEW: CHROME DINO GAME ü¶ï
============================================================== */
function buildDino(c, lv) {
  lv=lv||1;
  const W=500,H=200;
  let dino={x:60,y:H-50,vy:0,h:45,w:35,r:false,frame:0},obsts=[],score=0,speed=4+lv*.5,running=false,ground=H-32,frame3=0;
  const JUMP_FORCE=-12;

  c.innerHTML=`<div class="g-scorebar"><div class="g-score-item"><div class="g-score-val" id="dnSc">0</div><div class="g-score-lbl">Score</div></div><div class="g-score-item"><div class="g-score-val" id="dnLv">Lv${lv}</div><div class="g-score-lbl">Level</div></div></div><canvas id="dnC" class="g-canvas" width="${W}" height="${H}" style="touch-action:none;max-width:100%;"></canvas><div class="g-hint" style="font-size:.85rem;">Tap/Space/Up = Jump ‚Ä¢ Duck on ground</div><div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;"><button class="g-btn" style="font-size:1.5rem;padding:12px 24px;" onclick="dnJump()">‚¨ÜÔ∏è Jump</button><button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('dino')">‚≠ê Rate</button></div>`;

  const cv=document.getElementById('dnC'),ctx=cv.getContext('2d');

  function drawDino(){
    const dx=dino.x,dy=dino.y;
    // Body
    ctx.fillStyle='#555';
    ctx.fillRect(dx,dy,dino.w,dino.h-8);
    // Head
    ctx.fillRect(dx+dino.w-8,dy-14,22,18);
    // Eye
    ctx.fillStyle='#fff';ctx.fillRect(dx+dino.w+8,dy-10,7,7);
    ctx.fillStyle='#000';ctx.fillRect(dx+dino.w+10,dy-8,4,4);
    // Mouth
    ctx.fillStyle='#555';ctx.fillRect(dx+dino.w+12,dy-2,8,3);
    // Legs (animated)
    const legOff=dino.r?Math.sin(frame3*.2)*8:0;
    ctx.fillStyle='#555';
    ctx.fillRect(dx+5,dy+dino.h-8,10,12+legOff);
    ctx.fillRect(dx+18,dy+dino.h-8,10,12-legOff);
    // Tail
    ctx.fillRect(dx-10,dy+8,12,6);
  }

  function drawObst(o){
    if(o.type==='cactus'){
      ctx.fillStyle='#2d7a2d';
      ctx.fillRect(o.x+10,o.y-o.h,12,o.h);
      ctx.fillRect(o.x,o.y-o.h+10,32,8);
      ctx.fillRect(o.x,o.y-o.h*1.4+10,8,o.h*.4);
      ctx.fillRect(o.x+24,o.y-o.h*1.3+10,8,o.h*.3);
    } else {
      // Bird/pterodactyl
      ctx.fillStyle='#8b5e3c';
      ctx.fillRect(o.x,o.y-8,30,10);
      ctx.fillRect(o.x-5,o.y-16,18,10);
      ctx.fillRect(o.x+15,o.y-16,18,10);
      ctx.fillStyle='#000';ctx.fillRect(o.x+22,o.y-6,4,4);
    }
  }

  function draw(){
    ctx.fillStyle='#f7f7f7';ctx.fillRect(0,0,W,H);
    // Ground
    ctx.fillStyle='#555';ctx.fillRect(0,ground,W,3);
    // Clouds
    ctx.fillStyle='#ddd';
    [{x:(200-frame3*.3)%W,y:40},{x:(380-frame3*.2)%W,y:25}].forEach(cl=>{const cx=((cl.x%W)+W)%W;ctx.fillRect(cx,cl.y,60,12);ctx.fillRect(cx+10,cl.y-8,40,14);});
    // Dino
    drawDino();
    // Obstacles
    obsts.forEach(o=>drawObst(o));
    // Score
    ctx.fillStyle='#555';ctx.font='bold 14px Orbitron';ctx.fillText(Math.floor(score),W-80,20);
    if(!running){ctx.fillStyle='rgba(255,255,255,.9)';ctx.fillRect(0,0,W,H);ctx.fillStyle='#555';ctx.font='bold 20px Orbitron';ctx.textAlign='center';ctx.fillText('TAP TO START',W/2,H/2-10);ctx.font='12px Exo 2';ctx.fillText('Jump over cacti & birds!',W/2,H/2+16);ctx.textAlign='left';}
  }

  function jump(){
    if(!running){running=true;return;}
    if(dino.y>=ground-dino.h){dino.vy=JUMP_FORCE-lv*.3;playTone(350,0.12,'sine',0.25);}
  }

  function update(){
    if(!running){draw();return;}
    frame3++;speed=4+lv*.5+score/800;
    // Dino physics
    dino.vy+=.7;dino.y+=dino.vy;
    if(dino.y>=ground-dino.h){dino.y=ground-dino.h;dino.vy=0;dino.r=true;}else dino.r=false;
    // Spawn obstacles
    if(!obsts.length||obsts[obsts.length-1].x<W-200-Math.random()*200){
      const isbird=Math.random()<.3&&lv>1;
      obsts.push({x:W+10,y:isbird?ground-40:ground,h:isbird?20:35+Math.random()*20,w:32,type:isbird?'bird':'cactus'});
    }
    obsts.forEach(o=>o.x-=speed);obsts=obsts.filter(o=>o.x>-50);
    // Collision
    obsts.forEach(o=>{
      const ohit=o.type==='bird'?o.y-20:o.y-o.h;
      if(dino.x+dino.w-10>o.x+5&&dino.x+10<o.x+o.w&&dino.y+10>ohit&&dino.y<o.y+4){
        running=false;playFail();
        showToast('üíÄ Score: '+Math.floor(score));
        if(score>=500*lv)showWin('Score: '+Math.floor(score)+'!','dino',()=>openGame('dino'));
      }
    });
    score+=.1*speed;const ss=document.getElementById('dnSc');if(ss)ss.textContent=Math.floor(score);
    // Milestone
    if(Math.floor(score)%200===0&&Math.floor(score)>0)playCoin();
    draw();
  }

  window.dnJump=jump;
  addListener(cv,'click',jump);
  addListener(cv,'touchstart',e=>{e.preventDefault();jump();},{passive:false});
  addListener(document,'keydown',e=>{if(e.code==='Space'||e.key==='ArrowUp'){e.preventDefault();jump();}});
  draw();startLoop(update);
}


/* FEEDBACK */
let fbRating = 0;
function fbStar(n) {
  fbRating = n;
  const stars = document.querySelectorAll('#fbStars span');
  stars.forEach((s,i) => s.textContent = i < n ? '‚≠ê' : '‚òÜ');
  playTone(600+n*80, 0.08, 'sine', 0.2);
}
function fbSubmit() {
  const msg = document.getElementById('fbMsg')?.value?.trim();
  const name = document.getElementById('fbName')?.value?.trim() || 'Anonymous';
  const game = document.getElementById('fbGame')?.value;
  if (!msg) { showToast('Please write something first!'); return; }
  const container = document.getElementById('fbResponses');
  if (container) {
    const div = document.createElement('div');
    div.style.cssText = 'background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:.82rem;';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-weight:700;color:var(--orange);">${name}</span><span style="color:#666;">${new Date().toLocaleTimeString()}</span></div>${fbRating?'<div style="margin-bottom:4px;">'+'‚≠ê'.repeat(fbRating)+'</div>':''}<div style="color:#ccc;">${msg}</div>${game?`<div style="color:#666;font-size:.75rem;margin-top:4px;">üéÆ Best: ${GAMES.find(g=>g.id===game)?.name||game}</div>`:''}`;
    container.prepend(div);
  }
  document.getElementById('fbMsg').value = '';
  document.getElementById('fbName').value = '';
  document.getElementById('fbStars').querySelectorAll('span').forEach(s=>s.textContent='‚òÜ');
  fbRating = 0;
  showToast('üôè Thank you!'); playWin();
}
/* Populate feedback game dropdown */
(function(){
  const sel = document.getElementById('fbGame');
  if(sel) GAMES.forEach(g=>{const o=document.createElement('option');o.value=g.id;o.textContent=g.icon+' '+g.name;sel.appendChild(o);});
})();


/* ==============================================================
   FULL 4-PLAYER LUDO GAME ‚Äî with AI
============================================================== */
function buildLudo(c, lv) {
  lv = lv || 1;

  // Player config: 4 players, each can be Human or AI
  const PLAYERS = [
    { name:'You', color:'#ef4444', aiLight:'rgba(239,68,68,.15)', isAI:false, symbol:'üî¥' },
    { name:'Blue', color:'#3b82f6', aiLight:'rgba(59,130,246,.15)', isAI:true, symbol:'üîµ' },
    { name:'Green', color:'#22c55e', aiLight:'rgba(34,197,94,.15)', isAI:true, symbol:'üü¢' },
    { name:'Yellow', color:'#f59e0b', aiLight:'rgba(245,158,11,.15)', isAI:true, symbol:'üü°' },
  ];

  // Each player has 4 tokens. Position: -1 = home base, 0-51 = board, 52-57 = home stretch, 57 = won
  // Board path for each player starts at different positions
  const START_CELLS = [0, 13, 26, 39]; // entry cells for each player
  const HOME_ENTRY = [50, 11, 24, 37]; // cell before entering home stretch
  const SAFE = [0, 8, 13, 21, 26, 34, 39, 47]; // safe cells

  let tokens = PLAYERS.map((p, pi) => Array(4).fill(0).map((_, ti) => ({
    player: pi, id: ti, pos: -1, // -1 = base
    finishedHome: false
  })));

  let turn = 0, dice = 0, rolled = false, gameOver = false;
  let playerTypes = PLAYERS.map(p => p.isAI);

  function rollDice() {
    return Math.floor(Math.random() * 6) + 1;
  }

  function getMovableTks(player, d) {
    return tokens[player].filter(tk => {
      if (tk.finishedHome) return false;
      if (tk.pos === -1) return d === 6;
      const newPos = tk.pos + d;
      // Check if entering home stretch
      const entry = HOME_ENTRY[player];
      if (tk.pos <= entry && newPos > entry) {
        const homeSteps = newPos - entry;
        return homeSteps <= 6;
      }
      if (typeof tk.pos === 'string' && tk.pos.startsWith('H')) {
        const hp = parseInt(tk.pos.slice(1));
        return hp + d <= 6;
      }
      return newPos <= 52;
    });
  }

  function moveToken(tk, d) {
    const player = tk.player;
    if (tk.pos === -1) {
      // Enter board
      tk.pos = START_CELLS[player];
    } else if (typeof tk.pos === 'string' && tk.pos.startsWith('H')) {
      const hp = parseInt(tk.pos.slice(1));
      const np = hp + d;
      if (np === 6) { tk.finishedHome = true; playWin(); showToast(PLAYERS[player].symbol + ' token home!'); }
      else tk.pos = 'H' + np;
    } else {
      const entry = HOME_ENTRY[player];
      const newPos = tk.pos + d;
      if (tk.pos <= entry && newPos > entry) {
        tk.pos = 'H' + (newPos - entry);
        if (newPos - entry === 6) { tk.finishedHome = true; playWin(); showToast(PLAYERS[player].symbol + ' token home!'); }
      } else {
        tk.pos = newPos % 52;
        // Check capture
        if (!SAFE.includes(tk.pos)) {
          tokens.forEach((ptks, pi) => {
            if (pi === player) return;
            ptks.forEach(otk => {
              if (!otk.finishedHome && otk.pos === tk.pos && typeof otk.pos !== 'string') {
                otk.pos = -1; // send home
                showToast(PLAYERS[player].symbol + ' captured ' + PLAYERS[pi].symbol + '!');
                playExplode();
              }
            });
          });
        }
      }
    }
    playCoin();
  }

  function nextTurn(extraTurn) {
    if (!extraTurn) turn = (turn + 1) % 4;
    dice = 0; rolled = false;
    render();
    if (gameOver) return;
    if (playerTypes[turn]) {
      setTimeout(aiTurn, 800);
    }
  }

  function aiTurn() {
    dice = rollDice();
    rolled = true;
    const movable = getMovableTks(turn, dice);
    if (movable.length === 0) {
      showToast(PLAYERS[turn].symbol + ' rolled ' + dice + ' ‚Äî no move!');
      render();
      setTimeout(() => nextTurn(false), 700);
      return;
    }
    // AI: prefer capturing, then prefer moving furthest token, else enter base if 6
    let chosen = movable[0];
    for (const tk of movable) {
      // Check if this move captures
      const fakePos = tk.pos === -1 ? START_CELLS[turn] : (tk.pos + dice) % 52;
      const captures = tokens.some((ptks, pi) => pi !== turn && ptks.some(otk => !otk.finishedHome && otk.pos === fakePos && typeof otk.pos !== 'string'));
      if (captures) { chosen = tk; break; }
      // Prefer token that has moved more
      if (typeof tk.pos === 'number' && tk.pos !== -1 && (typeof chosen.pos !== 'number' || tk.pos > chosen.pos)) chosen = tk;
    }
    setTimeout(() => {
      showToast(PLAYERS[turn].symbol + ' rolled ' + dice);
      moveToken(chosen, dice);
      checkWin();
      render();
      setTimeout(() => nextTurn(dice === 6), 600);
    }, 400);
  }

  function checkWin() {
    for (let pi = 0; pi < 4; pi++) {
      if (tokens[pi].every(tk => tk.finishedHome)) {
        gameOver = true;
        showToast('üéâ ' + PLAYERS[pi].name + ' WINS!');
        if (pi === 0) setTimeout(() => showWin('You Won Ludo!', 'ludo', () => openGame('ludo')), 500);
        break;
      }
    }
  }

  function getBoardXY(cell) {
    // 52-cell path mapped to a grid position for rendering
    // Using a simplified linear path display
    const perRow = 13;
    const row = Math.floor(cell / perRow);
    const col = cell % perRow;
    const W = 280, H = 280;
    const cx = 20 + col * (W / perRow);
    const cy = 30 + row * (H / 4);
    return { x: cx, y: cy };
  }

  function render() {
    const g = document.getElementById('ludoG'); if (!g) return;
    const diceEmoji = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
    const activeP = PLAYERS[turn];

    // Player boards
    let boardHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:.8rem;">`;
    PLAYERS.forEach((p, pi) => {
      const tks = tokens[pi];
      const home = tks.filter(t => t.finishedHome).length;
      const onBoard = tks.filter(t => !t.finishedHome && t.pos !== -1).length;
      const inBase = tks.filter(t => t.pos === -1).length;
      const isActive = pi === turn && !gameOver;
      boardHTML += `<div style="background:${p.aiLight};border:2px solid ${isActive ? p.color : 'rgba(255,255,255,.1)'};border-radius:10px;padding:8px;transition:all .3s;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;">
          <span style="font-size:1.2rem;">${p.symbol}</span>
          <span style="font-weight:700;font-size:.85rem;color:${p.color};">${p.name}</span>
          <span style="font-size:.7rem;color:#999;margin-left:auto;">${playerTypes[pi] ? 'ü§ñ' : 'üë§'}</span>
          ${isActive ? `<span style="font-size:.65rem;background:${p.color};color:#000;padding:2px 6px;border-radius:8px;font-weight:700;">TURN</span>` : ''}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          ${tks.map(tk => `<div style="width:32px;height:32px;border-radius:50%;background:${tk.finishedHome ? p.color : tk.pos === -1 ? 'rgba(255,255,255,.1)' : p.color};border:2px solid ${p.color};display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:${tk.pos === -1 ? p.color : '#fff'};">${tk.finishedHome ? 'üè†' : tk.pos === -1 ? '‚≠ï' : typeof tk.pos === 'string' ? 'üéØ' : tk.pos}</div>`).join('')}
        </div>
        <div style="font-size:.65rem;color:#777;margin-top:4px;">üè†${home} üéØ${onBoard} ‚≠ï${inBase}</div>
      </div>`;
    });
    boardHTML += `</div>`;

    // Dice + current turn
    boardHTML += `<div style="text-align:center;margin-bottom:.8rem;">
      <div style="font-size:.9rem;color:#aaa;margin-bottom:.4rem;">${gameOver ? 'üéâ Game Over!' : 'Current: ' + activeP.symbol + ' ' + activeP.name + (playerTypes[turn] ? ' ü§ñ' : ' üë§')}</div>
      <div style="font-size:3rem;margin-bottom:.5rem;">${dice ? diceEmoji[dice] : 'üé≤'}</div>
      ${!rolled && !gameOver && !playerTypes[turn] ?
        `<button onclick="ludoRoll()" style="background:linear-gradient(135deg,#ff6600,#ff8833);color:#fff;border:none;padding:10px 28px;border-radius:10px;font-family:Orbitron,monospace;font-weight:700;font-size:.9rem;cursor:pointer;">üé≤ Roll!</button>` :
        rolled && !gameOver && !playerTypes[turn] ? `<div style="font-size:.85rem;color:var(--orange);">Choose a token to move!</div>` :
        gameOver ? `<button onclick="buildLudo(document.getElementById('gc'),${lv})" style="background:linear-gradient(135deg,#ff6600,#ff8833);color:#fff;border:none;padding:10px 28px;border-radius:10px;font-family:Orbitron,monospace;font-weight:700;font-size:.9rem;cursor:pointer;">Play Again</button>` : ''
      }
    </div>`;

    // Movable tokens (clickable)
    if (rolled && !gameOver && !playerTypes[turn]) {
      const movable = getMovableTks(turn, dice);
      if (movable.length === 0) {
        boardHTML += `<div style="text-align:center;color:#999;margin-bottom:.8rem;">No moves! Turn passes.</div>`;
        setTimeout(() => nextTurn(false), 800);
      } else {
        boardHTML += `<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:.8rem;">`;
        movable.forEach((tk, i) => {
          boardHTML += `<button onclick="ludoMove(${tk.player},${tk.id})" style="background:${PLAYERS[tk.player].color};color:#fff;border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:.9rem;">Token ${tk.id + 1} (${tk.pos === -1 ? 'Base' : tk.pos})</button>`;
        });
        boardHTML += `</div>`;
      }
    }

    // Settings - toggle AI
    boardHTML += `<div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:.5rem;">`;
    PLAYERS.forEach((p, pi) => {
      if (pi === 0) return; // player 1 is always human
      boardHTML += `<button onclick="ludoToggleAI(${pi})" style="background:${playerTypes[pi] ? 'rgba(59,130,246,.2)' : 'rgba(34,197,94,.2)'};border:1px solid ${playerTypes[pi] ? '#3b82f6' : '#22c55e'};color:${playerTypes[pi] ? '#3b82f6' : '#22c55e'};padding:4px 10px;border-radius:8px;font-size:.72rem;font-weight:700;cursor:pointer;">${p.symbol} ${playerTypes[pi] ? 'ü§ñ AI' : 'üë§ P'+(pi+1)}</button>`;
    });
    boardHTML += `</div>`;

    boardHTML += `<div class="g-hint">Roll 6 to enter board. Get all 4 tokens home to WIN!</div>`;
    boardHTML += `<button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;" onclick="showRating('ludo')">‚≠ê Rate</button>`;

    g.innerHTML = boardHTML;
  }

  window.ludoRoll = function() {
    if (rolled || gameOver || playerTypes[turn]) return;
    dice = rollDice();
    rolled = true;
    playTone(300 + dice * 50, 0.1, 'square', 0.2);
    const movable = getMovableTks(turn, dice);
    if (dice === 6) showToast('üé≤ Rolled 6! Extra turn!');
    render();
    if (!movable.length) {
      setTimeout(() => { showToast('No moves!'); nextTurn(false); }, 700);
    }
  };

  window.ludoMove = function(pi, ti) {
    if (!rolled || gameOver || playerTypes[turn] || pi !== turn) return;
    const tk = tokens[pi][ti];
    const movable = getMovableTks(turn, dice);
    if (!movable.includes(tk)) return;
    moveToken(tk, dice);
    checkWin();
    render();
    setTimeout(() => nextTurn(dice === 6), 500);
  };

  window.ludoToggleAI = function(pi) {
    playerTypes[pi] = !playerTypes[pi];
    render();
    if (pi === turn && playerTypes[pi]) setTimeout(aiTurn, 500);
  };

  c.innerHTML = `<div id="ludoG" style="max-width:400px;width:100%;"></div>`;
  render();
  if (playerTypes[turn]) setTimeout(aiTurn, 600);
}

/* ==============================================================
   IMPROVED: NOT A ROBOT ‚Äî with levels
============================================================== */
function buildNotARobot(c, lv) {
  lv = lv || 1;
  const GRIDS_BY_LEVEL = [
    // Level 1: Simple
    { type:'checkbox', desc:'Click ONLY üöó cars', items:['üöó','üöó','üå≥','üöó','üå≥','üöó','üå≥','üå≥','üöó'], target:'üöó', grid:3 },
    // Level 2: Larger grid
    { type:'checkbox', desc:'Click ONLY üçé apples', items:['üçé','üçä','üçé','üçä','üçé','üçé','üçä','üçé','üçä','üçé','üçä','üçä'], target:'üçé', grid:4 },
    // Level 3: Harder
    { type:'checkbox', desc:'Click ONLY üê± cats', items:['üê±','üê∂','üê±','üê∏','üê∂','üê±','üê∏','üê±','üê∂','üê±','üê∏','üê∏','üê∂','üê±','üê∂','üê±'], target:'üê±', grid:4 },
    // Level 4: Tricky
    { type:'checkbox', desc:'Click ONLY üî¥ red circles', items:['üî¥','üîµ','üî¥','üü¢','üîµ','üî¥','üü°','üî¥','üîµ','üü¢','üî¥','üü°','üîµ','üî¥','üü¢','üî¥'], target:'üî¥', grid:4 },
    // Level 5: Very hard
    { type:'checkbox', desc:'Click ONLY üåü stars (NOT ‚≠ê)', items:['üåü','‚≠ê','üåü','‚≠ê','üåü','üåü','‚≠ê','üåü','‚≠ê','üåü','‚≠ê','üåü','‚≠ê','‚≠ê','üåü','‚≠ê','üåü','‚≠ê','‚≠ê','üåü','‚≠ê','üåü','‚≠ê','üåü','üåü'], target:'üåü', grid:5 },
  ];

  const lvData = GRIDS_BY_LEVEL[Math.min(lv - 1, GRIDS_BY_LEVEL.length - 1)];

  // Shuffle items
  const items = [...lvData.items].sort(() => Math.random() - .5);
  const targets = items.map((e, i) => ({ e, i, selected: false }));
  const correct = targets.filter(t => t.e === lvData.target);
  let verifying = false, score = 0, mistakes = 0;

  function render() {
    const g = document.getElementById('nrGrid'); if (!g) return;
    const CS = Math.min(58, Math.floor((window.innerWidth - 80) / lvData.grid));
    g.style.cssText = `display:grid;grid-template-columns:repeat(${lvData.grid},${CS}px);gap:5px;`;
    g.innerHTML = targets.map((t, i) =>
      `<div onclick="nrTap(${i})" style="width:${CS}px;height:${CS}px;background:${t.selected ? 'rgba(255,102,0,.2)' : 'var(--card2)'};border:2px solid ${t.selected ? 'var(--orange)' : 'rgba(255,255,255,.08)'};border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:${CS*.55}px;cursor:pointer;user-select:none;transition:all .15s;${t.selected ? 'transform:scale(.92);' : ''}">${t.e}</div>`
    ).join('');
    const sc = document.getElementById('nrSc'); if(sc) sc.textContent = score;
    const mk = document.getElementById('nrMk'); if(mk) mk.textContent = mistakes;
  }

  window.nrTap = function(i) {
    if (verifying) return;
    targets[i].selected = !targets[i].selected;
    playClick();
    render();
  };

  window.nrVerify = function() {
    if (verifying) return;
    verifying = true;
    const selected = targets.filter(t => t.selected);
    const correctSel = selected.filter(t => t.e === lvData.target).length;
    const wrongSel = selected.filter(t => t.e !== lvData.target).length;
    const missed = correct.length - correctSel;

    if (wrongSel === 0 && missed === 0) {
      score += 100; playWin();
      showToast('‚úÖ Correct! +100 Human verified!');
      setTimeout(() => showWin(`Level ${lv} cleared! Score: ${score}`, 'notarobot', () => openGame('notarobot')), 500);
    } else {
      mistakes++;
      playFail();
      showToast(`‚ùå ${wrongSel} wrong, ${missed} missed! Try again!`);
      // Highlight errors
      const g = document.getElementById('nrGrid'); if (!g) return;
      const cells = g.querySelectorAll('div');
      targets.forEach((t, i) => {
        if (t.selected && t.e !== lvData.target) cells[i].style.background = 'rgba(239,68,68,.3)';
        if (!t.selected && t.e === lvData.target) cells[i].style.background = 'rgba(34,197,94,.15)';
      });
      setTimeout(() => {
        targets.forEach(t => t.selected = false);
        verifying = false;
        render();
      }, 1200);
    }
  };

  c.innerHTML = `
    <div class="g-scorebar">
      <div class="g-score-item"><div class="g-score-val" id="nrSc">${score}</div><div class="g-score-lbl">Score</div></div>
      <div class="g-score-item"><div class="g-score-val">Lv${lv}</div><div class="g-score-lbl">Level</div></div>
      <div class="g-score-item"><div class="g-score-val" id="nrMk">0</div><div class="g-score-lbl">Mistakes</div></div>
    </div>
    <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:1rem;margin-bottom:.8rem;text-align:center;max-width:360px;width:100%;">
      <div style="font-size:.75rem;color:#999;margin-bottom:.4rem;">Select all images of:</div>
      <div style="font-size:.95rem;font-weight:700;color:var(--orange);">${lvData.desc}</div>
      <div style="font-size:.72rem;color:#777;margin-top:.3rem;">${correct.length} items to find</div>
    </div>
    <div id="nrGrid" style="margin-bottom:.8rem;"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
      <button onclick="nrVerify()" style="background:linear-gradient(135deg,#ff6600,#ff8833);color:#fff;border:none;padding:11px 28px;border-radius:10px;font-family:Orbitron,monospace;font-weight:700;font-size:.88rem;cursor:pointer;">‚úì I'M NOT A ROBOT</button>
      <button class="g-btn" onclick="buildNotARobot(document.getElementById('gc'),${lv})" style="padding:11px 18px;">‚Ü∫</button>
    </div>
    <button class="g-btn" style="background:var(--card2);border:1px solid var(--border);color:#fff;margin-top:6px;" onclick="showRating('notarobot')">‚≠ê Rate</button>
    <div class="g-hint">Tap all matching images, then press the button!</div>`;

  render();
}

</script>
<!-- ============ FEEDBACK ============ -->
<section class="section" id="feedback-section" style="background:linear-gradient(135deg,rgba(255,102,0,.04),rgba(255,102,0,.02));border-top:1px solid rgba(255,102,0,.1);">
  <div class="container" style="max-width:680px;">
    <div class="sec-hdr">
      <div class="sec-title">üí¨ Share <span>Feedback</span></div>
      <div class="sec-line"></div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;">
      <p style="color:var(--gray);font-size:.9rem;margin-bottom:1rem;text-align:center;">How was your experience? Tell us what you think, what's broken, or what games to add next!</p>
      <div style="margin-bottom:1rem;">
        <label style="display:block;font-size:.78rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:.4rem;">YOUR NAME (optional)</label>
        <input id="fbName" type="text" placeholder="Anonymous Player" style="width:100%;box-sizing:border-box;background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Exo 2',sans-serif;font-size:.9rem;outline:none;">
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;font-size:.78rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:.4rem;">OVERALL RATING</label>
        <div style="display:flex;gap:10px;font-size:2rem;" id="fbStars">
          <span onclick="fbStar(1)" style="cursor:pointer;">‚òÜ</span>
          <span onclick="fbStar(2)" style="cursor:pointer;">‚òÜ</span>
          <span onclick="fbStar(3)" style="cursor:pointer;">‚òÜ</span>
          <span onclick="fbStar(4)" style="cursor:pointer;">‚òÜ</span>
          <span onclick="fbStar(5)" style="cursor:pointer;">‚òÜ</span>
        </div>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;font-size:.78rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:.4rem;">YOUR QUESTION / FEEDBACK / SUGGESTION</label>
        <textarea id="fbMsg" rows="4" placeholder="Which game is your favorite? What's broken? What new game should we add? Ask us anything!" style="width:100%;box-sizing:border-box;background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Exo 2',sans-serif;font-size:.9rem;outline:none;resize:vertical;min-height:90px;"></textarea>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="display:block;font-size:.78rem;font-weight:700;color:var(--orange);letter-spacing:1px;margin-bottom:.4rem;">BEST GAME SO FAR</label>
        <select id="fbGame" style="width:100%;box-sizing:border-box;background:var(--dark);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:#fff;font-family:'Exo 2',sans-serif;font-size:.9rem;outline:none;">
          <option value="">-- Select a game --</option>
        </select>
      </div>
      <button onclick="fbSubmit()" style="width:100%;background:linear-gradient(135deg,#ff6600,#ff8833);color:#fff;border:none;padding:12px;border-radius:10px;font-family:'Orbitron',monospace;font-weight:700;font-size:.9rem;cursor:pointer;letter-spacing:1px;">üì® SEND FEEDBACK</button>
      <div id="fbResponses" style="margin-top:1rem;display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;"></div>
    </div>
  </div>
</section>

</body>
</html>
